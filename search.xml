<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>计算机基础</title>
      <link href="computer/"/>
      <url>computer/</url>
      
        <content type="html"><![CDATA[<h1 id="进制"><a href="#进制" class="headerlink" title="进制"></a>进制</h1><p>我们平时使用的数字都是由 0~9 共十个数字组成的，例如 1、9、10、297、952 等，一个数字最多能表示九，如果要表示十、十一、二十九、一百等，就需要多个数字组合起来。</p><p>例如表示 5+8 的结果，一个数字不够，只能”进位 “，用 13 来表示；这时” 进一位 “相当于十，” 进两位“相当于二十。</p><p>因为逢十进一（满十进一），也因为只有 0~9 共十个数字，所以叫做十进制（Decimalism）。十进制是在人类社会发展过程中自然形成的，它符合人们的思维习惯，例如人类有十根手指，也有十根脚趾。</p><p>进制也就是进位制。进行加法运算时逢 X 进一（满 X 进一），进行减法运算时借一当 X，这就是 X 进制，这种进制也就包含 X 个数字，基数为 X。十进制有 0~9 共 10 个数字，基数为 10，在加减法运算中，逢十进一，借一当十。</p><h2 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h2><p>我们不妨将思维拓展一下，既然可以用 0~9 共十个数字来表示数值，那么也可以用 0、1 两个数字来表示数值，这就是二进制（Binary）。例如，数字 0、1、10、111、100、1000001 都是有效的二进制。</p><p>在计算机内部，数据都是以二进制的形式存储的，二进制是学习编程必须掌握的基础。本节我们先讲解二进制的概念，下节讲解数据在内存中的存储，让大家学以致用。</p><p>二进制加减法和十进制加减法的思想是类似的：</p><ul><li>  对于十进制，进行加法运算时逢十进一，进行减法运算时借一当十；</li><li>  对于二进制，进行加法运算时逢二进一，进行减法运算时借一当二。</li></ul><p>下面两张示意图详细演示了二进制加减法的运算过程。</p><ol><li>二进制加法：1+0=1、1+1=10、11+10=101、111+111=1110</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-015930.png">  </p><ol start="2"><li>二进制减法：1-0=1、10-1=1、101-11=10、1100-111=101</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020024.png">  </p><h2 id="八进制"><a href="#八进制" class="headerlink" title="八进制"></a>八进制</h2><p>除了二进制，C 语言还会使用到八进制。</p><p>八进制有 0~7 共 8 个数字，基数为 8，加法运算时逢八进一，减法运算时借一当八。例如，数字 0、1、5、7、14、733、67001、25430 都是有效的八进制。</p><p>下面两张图详细演示了八进制加减法的运算过程。</p><ol><li>八进制加法：3+4=7、5+6=13、75+42=137、2427+567=3216</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020031.png">  </p><ol start="2"><li>八进制减法：6-4=2、52-27=23、307-141=146、7430-1451=5757</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020042.png">  </p><h2 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h2><p>除了二进制和八进制，十六进制也经常使用，甚至比八进制还要频繁。</p><p>十六进制中，用 A 来表示 10，B 表示 11，C 表示 12，D 表示 13，E 表示 14，F 表示 15，因此有 0~F 共 16 个数字，基数为 16，加法运算时逢 16 进 1，减法运算时借 1 当 16。例如，数字 0、1、6、9、A、D、F、419、EA32、80A3、BC00 都是有效的十六进制。</p><blockquote><p>注意，十六进制中的字母不区分大小写，ABCDEF 也可以写作 abcdef。</p></blockquote><p>下面两张图详细演示了十六进制加减法的运算过程。</p><ol><li>十六进制加法：6+7=D、18+BA=D2、595+792=D27、2F87+F8A=3F11</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020047.png">  </p><ol start="2"><li>十六进制减法：D-3=A、52-2F=23、E07-141=CC6、7CA0-1CB1=5FEF</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020054.png">  </p><h1 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h1><h2 id="将二进制、八进制、十六进制转换为十进制"><a href="#将二进制、八进制、十六进制转换为十进制" class="headerlink" title="将二进制、八进制、十六进制转换为十进制"></a>将二进制、八进制、十六进制转换为十进制</h2><p>二进制、八进制和十六进制向十进制转换都非常容易，就是 “按权相加”。所谓 “权”，也即 “位权”。</p><p>假设当前数字是 N 进制，那么：</p><ul><li>  对于整数部分，从右往左看，第 i 位的位权等于 Ni-1</li><li>  对于小数部分，恰好相反，要从左往右看，第 j 位的位权为 N-j。</li></ul><p>更加通俗的理解是，假设一个多位数（由多个数字组成的数）某位上的数字是 1，那么它所表示的数值大小就是该位的位权。</p><h4 id="1-整数部分"><a href="#1-整数部分" class="headerlink" title="1) 整数部分"></a>1) 整数部分</h4><p>例如，将八进制数字 53627 转换成十进制：</p><p>53627 = 5×84 + 3×83 + 6×82 + 2×81 + 7×80 = 22423（十进制）</p><p>从右往左看，第 1 位的位权为 80=1，第 2 位的位权为 81=8，第 3 位的位权为 82=64，第 4 位的位权为 83=512，第 5 位的位权为 84=4096 …… 第 n 位的位权就为 8n-1。将各个位的数字乘以位权，然后再相加，就得到了十进制形式。</p><blockquote><p>注意，这里我们需要以十进制形式来表示位权。</p></blockquote><p>再如，将十六进制数字 9FA8C 转换成十进制：</p><p>9FA8C = 9×164 + 15×163 + 10×162 + 8×161 + 12×160 = 653964（十进制）</p><p>从右往左看，第 1 位的位权为 160=1，第 2 位的位权为 161=16，第 3 位的位权为 162=256，第 4 位的位权为 163=4096，第 5 位的位权为 164=65536 …… 第 n 位的位权就为 16n-1。将各个位的数字乘以位权，然后再相加，就得到了十进制形式。</p><p>将二进制数字转换成十进制也是类似的道理：</p><p>11010 = 1×24 + 1×23 + 0×22 + 1×21 + 0×20 = 26（十进制）</p><p>从右往左看，第 1 位的位权为 20=1，第 2 位的位权为 21=2，第 3 位的位权为 22=4，第 4 位的位权为 23=8，第 5 位的位权为 24=16 …… 第 n 位的位权就为 2n-1。将各个位的数字乘以位权，然后再相加，就得到了十进制形式。</p><h4 id="2-小数部分"><a href="#2-小数部分" class="headerlink" title="2) 小数部分"></a>2) 小数部分</h4><p>例如，将八进制数字 423.5176 转换成十进制：</p><p>423.5176 = 4×82 + 2×81 + 3×80 + 5×8-1 + 1×8-2 + 7×8-3 + 6×8-4 = 275.65576171875（十进制）</p><p>小数部分和整数部分相反，要从左往右看，第 1 位的位权为 8-1=1/8，第 2 位的位权为 8-2=1/64，第 3 位的位权为 8-3=1/512，第 4 位的位权为 8-4=1/4096 …… 第 m 位的位权就为 8-m。</p><p>再如，将二进制数字 1010.1101 转换成十进制：</p><p>1010.1101 = 1×23 + 0×22 + 1×21 + 0×20 + 1×2-1 + 1×2-2 + 0×2-3 + 1×2-4 = 10.8125（十进制）</p><p>小数部分和整数部分相反，要从左往右看，第 1 位的位权为 2-1=1/2，第 2 位的位权为 2-2=1/4，第 3 位的位权为 2-3=1/8，第 4 位的位权为 2-4=1/16 …… 第 m 位的位权就为 2-m。</p><p>更多转换成十进制的例子：</p><ul><li>  二进制：1001 = 1×23 + 0×22 + 0×21 + 1×20 = 8 + 0 + 0 + 1 = 9（十进制）</li><li>  二进制：101.1001 = 1×22 + 0×21 + 1×20 + 1×2-1 + 0×2-2 + 0×2-3 + 1×2-4 = 4 + 0 + 1 + 0.5 + 0 + 0 + 0.0625 = 5.5625（十进制）</li><li>  八进制：302 = 3×82 + 0×81 + 2×80 = 192 + 0 + 2 = 194（十进制）</li><li>  八进制：302.46 = 3×82 + 0×81 + 2×80 + 4×8-1 + 6×8-2 = 192 + 0 + 2 + 0.5 + 0.09375= 194.59375（十进制）</li><li>  十六进制：EA7 = 14×162 + 10×161 + 7×160 = 3751（十进制）</li></ul><h2 id="将十进制转换为二进制、八进制、十六进制"><a href="#将十进制转换为二进制、八进制、十六进制" class="headerlink" title="将十进制转换为二进制、八进制、十六进制"></a>将十进制转换为二进制、八进制、十六进制</h2><p>将十进制转换为其它进制时比较复杂，整数部分和小数部分的算法不一样，下面我们分别讲解。</p><h4 id="1-整数部分-1"><a href="#1-整数部分-1" class="headerlink" title="1) 整数部分"></a>1) 整数部分</h4><p>十进制整数转换为 N 进制整数采用 “除 N 取余，逆序排列” 法。具体做法是：</p><ul><li>  将 N 作为除数，用十进制整数除以 N，可以得到一个商和余数；</li><li>  保留余数，用商继续除以 N，又得到一个新的商和余数；</li><li>  仍然保留余数，用商继续除以 N，还会得到一个新的商和余数；</li><li>  ……</li><li>  如此反复进行，每次都保留余数，用商接着除以 N，直到商为 0 时为止。</li></ul><p>把先得到的余数作为 N 进制数的低位数字，后得到的余数作为 N 进制数的高位数字，依次排列起来，就得到了 N 进制数字。</p><p>下图演示了将十进制数字 36926 转换成八进制的过程：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020514.png"></p><p>从图中得知，十进制数字 36926 转换成八进制的结果为 110076。</p><p>下图演示了将十进制数字 42 转换成二进制的过程：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020534.png"></p><p>从图中得知，十进制数字 42 转换成二进制的结果为 101010。</p><h4 id="2-小数部分-1"><a href="#2-小数部分-1" class="headerlink" title="2) 小数部分"></a>2) 小数部分</h4><p>十进制小数转换成 N 进制小数采用 “乘 N 取整，顺序排列” 法。具体做法是：</p><ul><li>  用 N 乘以十进制小数，可以得到一个积，这个积包含了整数部分和小数部分；</li><li>  将积的整数部分取出，再用 N 乘以余下的小数部分，又得到一个新的积；</li><li>  再将积的整数部分取出，继续用 N 乘以余下的小数部分；</li><li>  ……</li><li>  如此反复进行，每次都取出整数部分，用 N 接着乘以小数部分，直到积中的小数部分为 0，或者达到所要求的精度为止。</li></ul><p>把取出的整数部分按顺序排列起来，先取出的整数作为 N 进制小数的高位数字，后取出的整数作为低位数字，这样就得到了 N 进制小数。</p><p>下图演示了将十进制小数 0.930908203125 转换成八进制小数的过程：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020658.png"></p><p>从图中得知，十进制小数 0.930908203125 转换成八进制小数的结果为 0.7345。</p><p>下图演示了将十进制小数 0.6875 转换成二进制小数的过程：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020713.png"></p><p>从图中得知，十进制小数 0.6875 转换成二进制小数的结果为 0.1011。</p><p>如果一个数字既包含了整数部分又包含了小数部分，那么将整数部分和小数部分开，分别按照上面的方法完成转换，然后再合并在一起即可。例如：</p><ul><li>  十进制数字 36926.930908203125 转换成八进制的结果为 110076.7345；</li><li>  十进制数字 42.6875 转换成二进制的结果为 101010.1011。</li></ul><p>下表列出了前 17 个十进制整数与二进制、八进制、十六进制的对应关系：</p><table><tbody><tr><th>十进制</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td></tr><tr><th>二进制</th><td>0</td><td>1</td><td>10</td><td>11</td><td>100</td><td>101</td><td>110</td><td>111</td><td>1000</td><td>1001</td><td>1010</td><td>1011</td><td>1100</td><td>1101</td><td>1110</td><td>1111</td><td>10000</td></tr><tr><th>八进制</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>20</td></tr><tr><th>十六进制</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>10</td></tr></tbody></table><p>注意，十进制小数转换成其他进制小数时，结果有可能是一个无限位的小数。请看下面的例子：</p><ul><li>  十进制 0.51 对应的二进制为 0.100000101000111101011100001010001111010111…，是一个循环小数；</li><li>  十进制 0.72 对应的二进制为 0.1011100001010001111010111000010100011110…，是一个循环小数；</li><li>  十进制 0.625 对应的二进制为 0.101，是一个有限小数。</li></ul><h2 id="二进制和八进制、十六进制的转换"><a href="#二进制和八进制、十六进制的转换" class="headerlink" title="二进制和八进制、十六进制的转换"></a>二进制和八进制、十六进制的转换</h2><p>其实，任何进制之间的转换都可以使用上面讲到的方法，只不过有时比较麻烦，所以一般针对不同的进制采取不同的方法。将二进制转换为八进制和十六进制时就有非常简洁的方法，反之亦然。</p><h4 id="1-二进制整数和八进制整数之间的转换"><a href="#1-二进制整数和八进制整数之间的转换" class="headerlink" title="1) 二进制整数和八进制整数之间的转换"></a>1) 二进制整数和八进制整数之间的转换</h4><p>二进制整数转换为八进制整数时，每三位二进制数字转换为一位八进制数字，运算的顺序是从低位向高位依次进行，高位不足三位用零补齐。下图演示了如何将二进制整数 1110111100 转换为八进制：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020757.png"></p><p>从图中可以看出，二进制整数 1110111100 转换为八进制的结果为 1674。</p><p>八进制整数转换为二进制整数时，思路是相反的，每一位八进制数字转换为三位二进制数字，运算的顺序也是从低位向高位依次进行。下图演示了如何将八进制整数 2743 转换为二进制：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020801.png"></p><p>从图中可以看出，八进制整数 2743 转换为二进制的结果为 10111100011。</p><h4 id="2-二进制整数和十六进制整数之间的转换"><a href="#2-二进制整数和十六进制整数之间的转换" class="headerlink" title="2) 二进制整数和十六进制整数之间的转换"></a>2) 二进制整数和十六进制整数之间的转换</h4><p>二进制整数转换为十六进制整数时，每四位二进制数字转换为一位十六进制数字，运算的顺序是从低位向高位依次进行，高位不足四位用零补齐。下图演示了如何将二进制整数 10 1101 0101 1100 转换为十六进制：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020845.jpg"></p><p>从图中可以看出，二进制整数 10 1101 0101 1100 转换为十六进制的结果为 2D5C。</p><p>十六进制整数转换为二进制整数时，思路是相反的，每一位十六进制数字转换为四位二进制数字，运算的顺序也是从低位向高位依次进行。下图演示了如何将十六进制整数 A5D6 转换为二进制：</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-08-020907.png"></p><p>从图中可以看出，十六进制整数 A5D6 转换为二进制的结果为 1010 0101 1101 0110。</p><p>在 C 语言编程中，二进制、八进制、十六进制之间几乎不会涉及小数的转换，所以这里我们只讲整数的转换，大家学以致用足以。另外，八进制和十六进制之间也极少直接转换，这里我们也不再讲解了。</p><h1 id="二进制数据存储"><a href="#二进制数据存储" class="headerlink" title="二进制数据存储"></a>二进制数据存储</h1><p>计算机要处理的信息是多种多样的，如数字、文字、符号、图形、音频、视频等，这些信息在人们的眼里是不同的。但对于计算机来说，它们在内存中都是一样的，都是以二进制的形式来表示。</p><p>要想学习编程，就必须了解二进制，它是计算机处理数据的基础。</p><p>内存条是一个非常精密的部件，包含了上亿个电子元器件，它们很小，达到了纳米级别。这些元器件，实际上就是电路；电路的电压会变化，要么是 0V，要么是 5V，只有这两种电压。5V 是通电，用 1 来表示，0V 是断电，用 0 来表示。所以，一个元器件有 2 种状态，0 或者 1。</p><p>我们通过电路来控制这些元器件的通断电，会得到很多 0、1 的组合。例如，8 个元器件有 28=256 种不同的组合，16 个元器件有 216=65536 种不同的组合。虽然一个元器件只能表示 2 个数值，但是多个结合起来就可以表示很多数值了。</p><p>我们可以给每一种组合赋予特定的含义，例如，可以分别用 1101000、00011100、11111111、00000000、01010101、10101010 来表示 C、语、言、中、文、网 这几个字，那么结合起来 1101000 00011100 11111111 00000000 01010101 10101010 就表示”C 语言中文网 “。</p><p>一般情况下我们不一个一个的使用元器件，而是将 <strong>8 个元器件看做一个单位</strong>，即使表示很小的数，例如 1，也需要 8 个，也就是 00000001。</p><p>1 个元器件称为 1 比特（Bit）或 1 位，8 个元器件称为 1 字节（Byte），那么 16 个元器件就是 2Byte，32 个就是 4Byte，以此类推：</p><ul><li>  8×1024 个元器件就是 1024Byte，简写为 1KB；</li><li>  8×1024×1024 个元器件就是 1024KB，简写为 1MB；</li><li>  8×1024×1024×1024 个元器件就是 1024MB，简写为 1GB。</li></ul><p>现在，你知道 1GB 的内存有多少个元器件了吧。我们通常所说的文件大小是多少 KB、多少 MB，就是这个意思。</p><p>单位换算：</p><ul><li>  1Byte = 8 Bit</li><li>  1KB = 1024Byte = 210Byte</li><li>  1MB = 1024KB = 220Byte</li><li>  1GB = 1024MB = 230Byte</li><li>  1TB = 1024GB = 240Byte</li><li>  1PB = 1024TB = 250Byte</li><li>  1EB = 1024PB = 260Byte</li></ul><p>我们平时使用计算机时，通常只会设计到 KB、MB、GB、TB 这几个单位，PB 和 EB 这两个高级单位一般在<a href="http://c.biancheng.net/big_data/">大数据</a>处理过程中才会用到。</p><p>你看，在内存中没有 abc 这样的字符，也没有 gif、jpg 这样的图片，只有 0 和 1 两个数字，计算机也只认识 0 和 1。所以，计算机使用二进制，而不是我们熟悉的十进制，写入内存中的数据，都会被转换成 0 和 1 的组合。</p>]]></content>
      
      
      <categories>
          
          <category> 计算机基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 计算机基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kali 环境搭建</title>
      <link href="kali/"/>
      <url>kali/</url>
      
        <content type="html"><![CDATA[<h1 id="kali-环境搭建"><a href="#kali-环境搭建" class="headerlink" title="kali 环境搭建"></a>kali 环境搭建</h1><h2 id="kali-root"><a href="#kali-root" class="headerlink" title="kali root"></a>kali root</h2><p>开机后用kali/kali进去入系统，运行sudo passwd root，给root设个密码toor，重复retype一次。然后重启以root/toor进入系统即可。</p><h2 id="kali-设置时区"><a href="#kali-设置时区" class="headerlink" title="kali 设置时区"></a>kali 设置时区</h2><p>kali里面时间老是不对，其实只是时区不对而已，一个命令就搞定：<br><code>dpkg-reconfigure tzdata</code><br>然后选择Asia→Shanghai，然后重启即可。</p><h2 id="kali-常用软件"><a href="#kali-常用软件" class="headerlink" title="kali 常用软件"></a>kali 常用软件</h2><h3 id="安装-jnetop-htop-tree"><a href="#安装-jnetop-htop-tree" class="headerlink" title="安装 jnetop htop tree"></a>安装 jnetop htop tree</h3><p>apt update<br>apt install jnettop htp tree</p><h2 id="kali-换源"><a href="#kali-换源" class="headerlink" title="kali 换源"></a>kali 换源</h2><p>1.更新软件源<br><code>sudo vim /etc/apt/sources.list</code><br>2.选择比较合适的源(选择一个即可）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#中科大</span></span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line"><span class="comment">#阿里云</span></span><br><span class="line">deb http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="comment">#清华大学</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line"></span><br><span class="line"><span class="comment">#163</span></span><br><span class="line">deb http://mirrors.163.com/debian wheezy main non-free contrib</span><br><span class="line">deb-src http://mirrors.163.com/debian wheezy main non-free contrib</span><br><span class="line">deb http://mirrors.163.com/debian wheezy-proposed-updates main non-free contrib</span><br><span class="line">deb-src http://mirrors.163.com/debian wheezy-proposed-updates main non-free contrib</span><br><span class="line">deb-src http://mirrors.163.com/debian-security wheezy/updates main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="comment">#东软大学</span></span><br><span class="line">deb http://mirrors.neusoft.edu.cn/kali kali-rolling/main non-free contrib</span><br><span class="line">deb-src http://mirrors.neusoft.edu.cn/kali kali-rolling/main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="comment">#官方源</span></span><br><span class="line">deb http://http.kali.org/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://http.kali.org/kali kali-rolling main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="comment">#jessie 需要手动调整 复制过来有问题</span></span><br><span class="line">deb http://ftp.de.debian.org/debian jessie main</span><br></pre></td></tr></table></figure><h2 id="kali-非-root-用户使用-adb"><a href="#kali-非-root-用户使用-adb" class="headerlink" title="kali 非 root 用户使用 adb"></a>kali 非 root 用户使用 adb</h2><p>非 root 用户使用 adb 命令时可能会出现以下错误<br><code>adb: insufficient permissions for device: missing udev rules?</code></p><p>解决方式:<br><code>vim /etc/udev/rules.d/51-android.rules</code></p><p>然后添加:<br><code>SUBSYSTEM==&quot;usb&quot;, ENV&#123;DEVTYPE&#125;==&quot;usb_device&quot;, MODE=&quot;0666&quot;</code><br>再次拔插设备即可</p><h2 id="kali-安装-android-studio"><a href="#kali-安装-android-studio" class="headerlink" title="kali 安装 android studio"></a>kali 安装 android studio</h2><p>浏览器设置代理</p><p>搜索proxy socks5 本机 ip: 代理端口</p><p>打开网址: <a href="https://developer.android.com/studio">https://developer.android.com/studio</a></p><p>复制 download 地址, 使用 wget 命令下载</p><p>下载完成后解压缩并添加权限 <code>chmod -R 755 Android-Studio</code> </p><p>进入 bin 目录启动 <code>./studio.sh</code> </p><p>安装完成后新建一个 native 项目等待同步即可</p><h2 id="kali-使用-adb"><a href="#kali-使用-adb" class="headerlink" title="kali 使用 adb"></a>kali 使用 adb</h2><p>安装好 android-studio 之后</p><p>进入 <code>/root/Android/Sdk/platform-tools</code>可以看到 adb 工具</p><p>将路径加入到 zshrc 中 <code>vim ~/.zshrc</code> 加入: <code>export PATH=&quot;/root/Android/Sdk/platform-tools:$PATH&quot;</code> </p><h2 id="kali-安装-pyenv"><a href="#kali-安装-pyenv" class="headerlink" title="kali 安装 pyenv"></a>kali 安装 pyenv</h2><ol><li><p><a href="https://github.com/pyenv/pyenv/wiki#suggested-build-environment">安装需要的依赖 </a> <code>sudo apt-get update; sudo apt-get install --no-install-recommends make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev</code></p></li><li><p><code>git clone https://github.com/pyenv/pyenv.git ~/.pyenv</code> </p></li><li><p>kali 2020 使用的是 zsh , 需要将 pyenv 添加到路径中 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure></li><li><p><code>echo -e &#39;if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init -)&quot;\nfi&#39; &gt;&gt; ~/.zshrc</code></p></li><li><p><code>exec &quot;$SHELL&quot;</code></p></li><li><p>安装指定版本 python <code>pyenv install 3.8.0</code> </p></li><li><p>切换指定版本 python <code>pyenv local 3.8.0</code> </p></li></ol><h2 id="kali-安装-nodejs-和-gum"><a href="#kali-安装-nodejs-和-gum" class="headerlink" title="kali 安装 nodejs 和 gum"></a>kali 安装 nodejs 和 gum</h2><p><a href="https://github.com/nodesource/distributions/blob/master/README.md">https://github.com/nodesource/distributions/blob/master/README.md</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using Debian, as root</span></span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_15.x | bash -</span><br><span class="line">apt-get install -y nodejs</span><br></pre></td></tr></table></figure><p>安装 gum 进行代码提示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @types/frida-gum</span><br></pre></td></tr></table></figure><h2 id="kali-安装-vscode"><a href="#kali-安装-vscode" class="headerlink" title="kali 安装 vscode"></a>kali 安装 vscode</h2><p>下载地址: <a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></p><p><code>dpkg -i 文件名</code></p>]]></content>
      
      
      <categories>
          
          <category> env </category>
          
      </categories>
      
      
        <tags>
            
            <tag> env </tag>
            
            <tag> kali </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>adb 常用命令</title>
      <link href="adb/"/>
      <url>adb/</url>
      
        <content type="html"><![CDATA[<ul><li><p>adb 启动和停止</p><ul><li><code>adb start-server</code></li><li><code>adb kill-server</code></li></ul></li><li><p>adb 查看最顶端应用的包名和 activity 名</p><ul><li><code>adb shell dumpsys window | grep mCurrentFocus</code> </li></ul></li><li><p>adb 输入字符串</p><ul><li><code>adb shell input text &quot;&lt;String&gt;&quot;</code> </li></ul></li><li><p>adb 模拟按键</p><ul><li><code>adb shell input keyevent &lt;Int&gt;</code> <a href="https://www.huaweicloud.com/articles/aaab7697baca07f9d37854a69631a11d.html">按键参考</a></li></ul></li><li><p>adb 安装 apk 指定 32 位和 64 位</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb install --abi armeabi-v7a &lt;apk path&gt;  <span class="comment"># 32位下运行</span></span><br><span class="line">adb install --abi arm64-v8a &lt;apk path&gt;    <span class="comment"># 64位下运行</span></span><br></pre></td></tr></table></figure></li><li><p>adb 查看连接设备</p><ul><li><code>adb devices</code></li></ul></li><li><p>adb 指定连接设备</p><ul><li><code>adb -s cf12345f shell</code></li></ul></li><li><p>adb 安装应用</p><ul><li><code>adb install -r demo.apk</code></li></ul></li><li><p>adb 卸载应用</p><ul><li><code>adb uninstall &lt;包名&gt;</code></li></ul></li><li><p>adb 列出手机安装的所有 app 的包名</p><ul><li><code>adb shell pm list packages</code></li></ul></li><li><p>adb 列出除了系统应用之外的第三方应用</p><ul><li><code>adb shell pm list package -3</code> </li></ul></li><li><p>adb 清除应用数据和缓存</p><ul><li><code>adb shell pm clear &lt;包名&gt;</code></li></ul></li><li><p>adb 强制停止应用</p><ul><li><code>adb shell am force-stop com.tencent.mm</code></li></ul></li><li><p>adb 启动 activity</p><ul><li><code>adb shell am start com.tencent.mm/com.tencent.mm.ui.LauncherUI</code> 配合adb 查看最顶端应用的包名和 activity 名使用</li></ul></li><li><p>adb 取出安装的 apk</p><ol><li><code>adb shell pm list package</code></li><li><code>adb shell pm path com.tence01.mm</code> 获取apk的位置</li><li><code>adb pull /data/app/com.tence01.mm-1.apk ~/apks</code> 拉取到本地</li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> others </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>arm</title>
      <link href="arm/"/>
      <url>arm/</url>
      
        <content type="html"><![CDATA[<h2 id="arm-可执行程序生成过程"><a href="#arm-可执行程序生成过程" class="headerlink" title="arm 可执行程序生成过程"></a>arm 可执行程序生成过程</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>编写hello.c 文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello arm!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mac 自带的 clang 编译, 如果使用默认的 clang 进行编译<br><code>clang _01helloworld.c -o hello_mac</code></p><p>使用 <code>file</code> 查看, 编译的结果为<br><code>Mach-O 64-bit executable x86_6</code></p><p>需要使用 <code>ndk</code> 中的 <code>clang</code> 进行编译; 可以直接使用 <code>android studio</code> 自带的 <code>ndk</code> 中的 <code>clang</code> 命令进行编译;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-03-065237.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-03-065237.png"></p><p>将 <code>clang</code> 添加到环境变量, 方便使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alias arm&#x3D;&#39;export PATH&#x3D;&quot;&#x2F;Users&#x2F;zhangyang&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk&#x2F;21.0.6113669&#x2F;toolchains&#x2F;llvm&#x2F;prebuilt&#x2F;darwin-x86_64&#x2F;bin:$PATH&quot;&#39;</span><br><span class="line">arm # 切换环境变量</span><br><span class="line">clang -target aarch64-linux-android21 _01helloworld.c -o hello # 编译 64 位</span><br><span class="line">clang -target armv7-linux-android21 _01helloworld.c -o hello     # 编译 32 位</span><br></pre></td></tr></table></figure><p>使用 <code>file</code> 查看, 结果为: <code>hello: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /system/bin/linker64, not stripped</code></p><h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><p>获取预编译的文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -target arm-linux-android21 -E _01helloworld.c *-o arm*hello.i</span><br></pre></td></tr></table></figure><p>使用 <code>clang</code> 命令, 增加 <code>-E</code> 参数, 生成一个 <code>.i</code> 尾缀的文件</p><ul><li>hello.i</li></ul><p>预处理过程将源文件中导入的头文件和宏展开; 预处理输出结果还是一个源程序文件, 以 <code>.i</code> 为扩展名</p><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -target arm-linux-android21 -S arm_hello.i -o arm_hello.s</span><br></pre></td></tr></table></figure><p>使用 <code>clang</code> 命令, 增加 <code>-S</code> 参数, 将 <code>.i</code> 文件生成为一个尾缀 <code>.s</code> 文件</p><ul><li>arm_hello.s</li></ul><h3 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -target arm-linux-android21 -c arm_hello.s -o arm_hello.o</span><br></pre></td></tr></table></figure><p>此时生成的 <code>arm_hello.o</code> , 生成一个可重定位目标文件, 以 <code>.o</code> 为扩展名;</p><p>它是一个二进制文件, 其中的代码已经是机器指令了;</p><p>数据以及其他信息也都用二进制表示, 所以它不可读, 打开显示为乱码;</p><h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>将多个 <code>.o</code> 文件通过命令链接成一个可执行文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -taregt arm-linux-adnroid21 arm_hello.o -o arm_hello</span><br></pre></td></tr></table></figure><p>在 <code>android</code> 中运行</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-03-073133.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-03-073133.png"></p>]]></content>
      
      
      <categories>
          
          <category> so </category>
          
      </categories>
      
      
        <tags>
            
            <tag> arm </tag>
            
            <tag> so </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>101辅导</title>
      <link href="101fudao/"/>
      <url>101fudao/</url>
      
        <content type="html"><![CDATA[<h1 id="INFO"><a href="#INFO" class="headerlink" title="INFO"></a>INFO</h1><p>app: 101辅导<br>包名: com.chinaedu.blessonstu<br>版本: 1.8.5</p><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>直接搜索 “signature” 定位到关键代码<code>com.chinaedu.http.interceptor.SHA1EncryptInterceptor</code>;<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-083222.png" alt="img"></p><p>该类是一个<code>interceptor</code> , 通过 <code>addInterceptor</code>方法添加到 <code>OkHttpClient</code> 中;<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-083132.png" alt="img"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path=&#x27;./index.d.ts&#x27;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;执行 -&gt; &quot;</span>,<span class="string">&quot;hook&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> Sha1Clazz = Java.use(<span class="string">&quot;com.chinaedu.blessonstu.utils.SHA1Utils&quot;</span>);</span><br><span class="line">        Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">        <span class="keyword">var</span> gson = Java.use(<span class="string">&quot;com.r0ysue.gson.Gson&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Sha1Clazz.makeSignature.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">map, str</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;makeSignature map:&quot;</span>,gson.$new().toJson(map));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;makeSignature str:&quot;</span>, str);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.makeSignature(map, str);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;makeSignature result:&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Sha1Clazz.SHA1.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;SHA1 str&quot;</span>, str);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.SHA1(str);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;SHA1 result&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hook();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-084738.png" alt="img"></p><ol><li>对请求参数进行排序</li><li>排序之后拼接字符串 key=value</li><li>添加&amp;符进行分割</li><li>末位添加 salt: 00302c79-3a50-47ae-89f3-242f51b3e817</li><li>对字符串进行标准的 sha1 摘要</li></ol><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-085117.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> demo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>铁甲</title>
      <link href="tiejia/"/>
      <url>tiejia/</url>
      
        <content type="html"><![CDATA[<h1 id="INFO"><a href="#INFO" class="headerlink" title="INFO"></a>INFO</h1><p>app: 铁甲<br>包名: com.cehome.cehomebbs<br>版本: 3.9.9.0</p><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>使用关键词搜索 “token” 可以直接定位到关键代码 <code>cehome.sdk.utils.AesUtil.getSystemHeader</code><br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-080348.png" alt="img"><br>定位到关键代码, 使用了 Aes 进行加密; 进入该方法可以看到使用的标准的加密:<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-080428.png" alt="img"></p><ol><li>加密内容: “cehomeapp@” + uuid</li><li>key: j33$E@GctUXJtVfO</li><li>ECB/PKCS5Padding</li></ol><h1 id="python-实现"><a href="#python-实现" class="headerlink" title="python 实现"></a>python 实现</h1><p><a href="https://github.com/kevinspider/snip/blob/main/AesEcb.py">AesEcb</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Mapping</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> Padding</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode, b64decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_ecb_pkcs7_b64_encrypt</span>(<span class="params">data, key</span>):</span></span><br><span class="line">    data = Padding.pad(data.encode(<span class="string">&#x27;utf-8&#x27;</span>), AES.block_size, <span class="string">&#x27;pkcs7&#x27;</span>)</span><br><span class="line">    aes = AES.new(key.encode(<span class="string">&#x27;utf-8&#x27;</span>), AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> b64encode(aes.encrypt(data)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_ecb_pkcs7_b64_decrypt</span>(<span class="params">data, key</span>):</span></span><br><span class="line">    data = b64decode(data.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    aes = AES.new(key.encode(<span class="string">&#x27;utf-8&#x27;</span>), AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> Padding.unpad(aes.decrypt(data), AES.block_size, <span class="string">&#x27;pkcs7&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    result = aes_ecb_pkcs7_b64_encrypt(<span class="string">&quot;cehomeapp@f6b72cfb-e94d-4eba-9aa3-6c41f33118e8&quot;</span>,<span class="string">&quot;j33$E@GctUXJtVfO&quot;</span>)</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> demo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>宝宝树孕育</title>
      <link href="baobaoshu/"/>
      <url>baobaoshu/</url>
      
        <content type="html"><![CDATA[<h1 id="INFO"><a href="#INFO" class="headerlink" title="INFO"></a>INFO</h1><p>app: com.babytree.apps.pregnancy<br>name: 宝宝树孕育<br>version: 8.31.0</p><h1 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h1><p>测试过程中发现, 使用 objection 进行 dexdump 比使用 python 中 dexdump 更加稳定;<br><code>objection -g com.babytree.apps.pregnancy explore</code><br><code>plugin load /Users/zhangyang/.objection/plugins/dexdump</code><br><code>plugin dexdump dump</code></p><h1 id="合并-dex"><a href="#合并-dex" class="headerlink" title="合并 dex"></a>合并 dex</h1><p>脱壳 dump 下来的 dex 文件存放在 ~/packageName 下, <a href="https://kevinspider.github.io/post/dex2apk/">dex2apk</a>进行合并 dex 文件;<br><code>mkdir source</code><br><code>mv *.dex ./source</code><br><code>python dex2apk.py -a ./baobaoshu.apk -i source</code><br><code>jadx-gui repacked.apk</code></p><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>直接搜索 “signature” 可以快速定位到加密位置:<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-052527.png" alt="img"><br>或者通过观察加密字段的特征, 使用 md5 反向定位 <a href="https://github.com/kevinspider/snip/blob/main/hookMD5.js">hookmd5</a><br>定位到关键加密位置: com.meitun.mama.util.bt<br>查看该类的 a 方法, 加密逻辑为:</p><ol><li>对请求的 url 进行首字母排序</li><li>遍历排序结果, 进行 key=value 的拼接</li><li>末位添加 salt : iambabytreekey!@#$%^&amp;*()</li><li>对结果进行 md5</li></ol>]]></content>
      
      
      <categories>
          
          <category> demo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git</title>
      <link href="git/"/>
      <url>git/</url>
      
        <content type="html"><![CDATA[<p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-15-032156.jpg" alt="img"></p><ul><li>workspace: 工作区</li><li>index/stage: 暂存区</li><li>repository: 仓库区(本地仓库)</li><li>remote: 远程仓库</li></ul><h1 id="新建代码库"><a href="#新建代码库" class="headerlink" title="新建代码库"></a>新建代码库</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在当前目录新建一个Git代码库</span></span><br><span class="line">$ git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个目录，将其初始化为Git代码库</span></span><br><span class="line">$ git init [project-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载一个项目和它的整个代码历史</span></span><br><span class="line">$ git <span class="built_in">clone</span> [url]</span><br></pre></td></tr></table></figure><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>Git 的配置文件为 .gitconfig, 可以在用户主目录下(全局配置), 也可以在项目目录下(项目配置);</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示当前的Git配置</span></span><br><span class="line">$ git config --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑Git配置文件</span></span><br><span class="line">$ git config -e [--global]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置提交代码时的用户信息</span></span><br><span class="line">$ git config [--global] user.name <span class="string">&quot;[name]&quot;</span></span><br><span class="line">$ git config [--global] user.email <span class="string">&quot;[email address]&quot;</span></span><br></pre></td></tr></table></figure><h1 id="增加-删除文件"><a href="#增加-删除文件" class="headerlink" title="增加/删除文件"></a>增加/删除文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加指定文件到暂存区</span></span><br><span class="line">$ git add [file1] [file2] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加指定目录到暂存区，包括子目录</span></span><br><span class="line">$ git add [dir]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加当前目录的所有文件到暂存区</span></span><br><span class="line">$ git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加每个变化前，都会要求确认</span></span><br><span class="line"><span class="comment"># 对于同一个文件的多处变化，可以实现分次提交</span></span><br><span class="line">$ git add -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除工作区文件，并且将这次删除放入暂存区</span></span><br><span class="line">$ git rm [file1] [file2] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止追踪指定文件，但该文件会保留在工作区</span></span><br><span class="line">$ git rm --cached [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改名文件，并且将这个改名放入暂存区</span></span><br><span class="line">$ git mv [file-original] [file-renamed]</span><br></pre></td></tr></table></figure><h1 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提交暂存区到仓库区</span></span><br><span class="line">$ git commit -m [message]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交暂存区的指定文件到仓库区</span></span><br><span class="line">$ git commit [file1] [file2] ... -m [message]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交工作区自上次commit之后的变化，直接到仓库区</span></span><br><span class="line">$ git commit -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交时显示所有diff信息</span></span><br><span class="line">$ git commit -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用一次新的commit，替代上一次提交</span></span><br><span class="line"><span class="comment"># 如果代码没有任何新变化，则用来改写上一次commit的提交信息</span></span><br><span class="line">$ git commit --amend -m [message]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重做上一次commit，并包括指定文件的新变化</span></span><br><span class="line">$ git commit --amend [file1] [file2] ...</span><br></pre></td></tr></table></figure><h1 id="远程同步"><a href="#远程同步" class="headerlink" title="远程同步"></a>远程同步</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载远程仓库的所有变动</span></span><br><span class="line">$ git fetch [remote]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有远程仓库</span></span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个远程仓库的信息</span></span><br><span class="line">$ git remote show [remote]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加一个新的远程仓库，并命名</span></span><br><span class="line">$ git remote add [shortname] [url]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取回远程仓库的变化，并与本地分支合并</span></span><br><span class="line">$ git pull [remote] [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传本地指定分支到远程仓库</span></span><br><span class="line">$ git push [remote] [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强行推送当前分支到远程仓库，即使有冲突</span></span><br><span class="line">$ git push [remote] --force</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送所有分支到远程仓库</span></span><br><span class="line">$ git push [remote] --all</span><br></pre></td></tr></table></figure><h1 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有本地分支</span></span><br><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有远程分支</span></span><br><span class="line">$ git branch -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有本地分支和远程分支</span></span><br><span class="line">$ git branch -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，但依然停留在当前分支</span></span><br><span class="line">$ git branch [branch-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，并切换到该分支</span></span><br><span class="line">$ git checkout -b [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，指向指定commit</span></span><br><span class="line">$ git branch [branch] [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，与指定的远程分支建立追踪关系</span></span><br><span class="line">$ git branch --track [branch] [remote-branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到指定分支，并更新工作区</span></span><br><span class="line">$ git checkout [branch-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到上一个分支</span></span><br><span class="line">$ git checkout -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立追踪关系，在现有分支与指定的远程分支之间</span></span><br><span class="line">$ git branch --set-upstream [branch] [remote-branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并指定分支到当前分支</span></span><br><span class="line">$ git merge [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择一个commit，合并进当前分支</span></span><br><span class="line">$ git cherry-pick [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">$ git branch -d [branch-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">$ git push origin --delete [branch-name]</span><br><span class="line">$ git branch -dr [remote/branch]</span><br></pre></td></tr></table></figure><h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有tag</span></span><br><span class="line">$ git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个tag在当前commit</span></span><br><span class="line">$ git tag [tag]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个tag在指定commit</span></span><br><span class="line">$ git tag [tag] [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除本地tag</span></span><br><span class="line">$ git tag -d [tag]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程tag</span></span><br><span class="line">$ git push origin :refs/tags/[tagName]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看tag信息</span></span><br><span class="line">$ git show [tag]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交指定tag</span></span><br><span class="line">$ git push [remote] [tag]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交所有tag</span></span><br><span class="line">$ git push [remote] --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，指向某个tag</span></span><br><span class="line">$ git checkout -b [branch] [tag]</span><br></pre></td></tr></table></figure><h1 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示有变更的文件</span></span><br><span class="line">$ git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前分支的版本历史</span></span><br><span class="line">$ git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示commit历史，以及每次commit发生变更的文件</span></span><br><span class="line">$ git <span class="built_in">log</span> --<span class="built_in">stat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索提交历史，根据关键词</span></span><br><span class="line">$ git <span class="built_in">log</span> -S [keyword]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个commit之后的所有变动，每个commit占据一行</span></span><br><span class="line">$ git <span class="built_in">log</span> [tag] HEAD --pretty=format:%s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个commit之后的所有变动，其&quot;提交说明&quot;必须符合搜索条件</span></span><br><span class="line">$ git <span class="built_in">log</span> [tag] HEAD --grep feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个文件的版本历史，包括文件改名</span></span><br><span class="line">$ git <span class="built_in">log</span> --follow [file]</span><br><span class="line">$ git whatchanged [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定文件相关的每一次diff</span></span><br><span class="line">$ git <span class="built_in">log</span> -p [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示过去5次提交</span></span><br><span class="line">$ git <span class="built_in">log</span> -5 --pretty --oneline</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有提交过的用户，按提交次数排序</span></span><br><span class="line">$ git shortlog -sn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定文件是什么人在什么时间修改过</span></span><br><span class="line">$ git blame [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示暂存区和工作区的差异</span></span><br><span class="line">$ git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示暂存区和上一个commit的差异</span></span><br><span class="line">$ git diff --cached [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示工作区与当前分支最新commit之间的差异</span></span><br><span class="line">$ git diff HEAD</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示两次提交之间的差异</span></span><br><span class="line">$ git diff [first-branch]...[second-branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示今天你写了多少行代码</span></span><br><span class="line">$ git diff --shortstat <span class="string">&quot;@&#123;0 day ago&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交的元数据和内容变化</span></span><br><span class="line">$ git show [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交发生变化的文件</span></span><br><span class="line">$ git show --name-only [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交时，某个文件的内容</span></span><br><span class="line">$ git show [commit]:[filename]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前分支的最近几次提交</span></span><br><span class="line">$ git reflog</span><br></pre></td></tr></table></figure><h1 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 恢复暂存区的指定文件到工作区</span></span><br><span class="line">$ git checkout [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复某个commit的指定文件到暂存区和工作区</span></span><br><span class="line">$ git checkout [commit] [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复暂存区的所有文件到工作区</span></span><br><span class="line">$ git checkout .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变</span></span><br><span class="line">$ git reset [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置暂存区与工作区，与上一次commit保持一致</span></span><br><span class="line">$ git reset --hard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变</span></span><br><span class="line">$ git reset [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致</span></span><br><span class="line">$ git reset --hard [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前HEAD为指定commit，但保持暂存区和工作区不变</span></span><br><span class="line">$ git reset --keep [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个commit，用来撤销指定commit</span></span><br><span class="line"><span class="comment"># 后者的所有变化都将被前者抵消，并且应用到当前分支</span></span><br><span class="line">$ git revert [commit]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂时将未提交的变化移除，稍后再移入</span></span><br><span class="line">$ git stash</span><br><span class="line">$ git stash pop</span><br></pre></td></tr></table></figure><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个可供发布的压缩包</span></span><br><span class="line">$ git archive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置换行符为LF</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#拒绝提交包含混合换行符的文件</span></span><br><span class="line">git config --global core.safecrlf <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> others </tag>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dex2apk</title>
      <link href="dex2apk/"/>
      <url>dex2apk/</url>
      
        <content type="html"><![CDATA[<p>使用脱壳工具脱下来的 dex 合并成 apk; 直接拖入 jadx-gui 中查看<br>针对之前出现的某些 dex 格式错误, 导致重新打包之后会出现 jadx-gui 无法打开的问题;</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename_class</span>(<span class="params">path</span>):</span></span><br><span class="line">   files = os.listdir(path)</span><br><span class="line">   dex_index = <span class="number">0</span></span><br><span class="line">   <span class="keyword">if</span> path.endswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">       path = path[:-<span class="number">1</span>]</span><br><span class="line">       print(path)</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(files)):</span><br><span class="line">       <span class="keyword">if</span> files[i].endswith(<span class="string">&#x27;.dex&#x27;</span>):</span><br><span class="line">           old_name = path + <span class="string">&#x27;/&#x27;</span> + files[i]</span><br><span class="line">           <span class="keyword">if</span> dex_index == <span class="number">0</span>:</span><br><span class="line">               new_name = path + <span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;classes.dex&#x27;</span></span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               new_name = path + <span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;classes%d.dex&#x27;</span> % dex_index</span><br><span class="line">           dex_index += <span class="number">1</span></span><br><span class="line">           <span class="keyword">if</span> os.path.exists(new_name):</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">           os.rename(old_name, new_name)</span><br><span class="line">   print(<span class="string">&#x27;[*] 重命名完毕&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_dex</span>(<span class="params">path</span>):</span></span><br><span class="line">   files = os.listdir(path)</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(files)):</span><br><span class="line">       <span class="keyword">if</span> files[i].endswith(<span class="string">&quot;.dex&quot;</span>):</span><br><span class="line">           flag = os.popen(<span class="string">&quot;jadx -s &quot;</span> + path + <span class="string">&quot;/&quot;</span> + files[i]).read()</span><br><span class="line">           print(<span class="string">&quot;flag&quot;</span>, flag)</span><br><span class="line">           <span class="keyword">if</span> <span class="string">&quot;INFO  - done&quot;</span> <span class="keyword">in</span> flag:</span><br><span class="line">               print(<span class="string">&quot;校验成功&quot;</span>)</span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               print(<span class="string">&quot;校验失败, 删除文件&quot;</span> + path + <span class="string">&quot;/&quot;</span> + files[i])</span><br><span class="line">               os.remove(path + <span class="string">&quot;/&quot;</span> + files[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_META_INF_from_apk</span>(<span class="params">apk_path, target_path</span>):</span></span><br><span class="line">   r = zipfile.is_zipfile(apk_path)</span><br><span class="line">   <span class="keyword">if</span> r:</span><br><span class="line">       fz = zipfile.ZipFile(apk_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">       <span class="keyword">for</span> file <span class="keyword">in</span> fz.namelist():</span><br><span class="line">           <span class="keyword">if</span> file.startswith(<span class="string">&#x27;META-INF&#x27;</span>):</span><br><span class="line">               fz.extract(file, target_path)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       print(<span class="string">&#x27;[-] %s 不是一个APK文件&#x27;</span> % apk_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zip_dir</span>(<span class="params">dirname, zipfilename</span>):</span></span><br><span class="line">   filelist = []</span><br><span class="line">   <span class="keyword">if</span> os.path.isfile(dirname):</span><br><span class="line">       <span class="keyword">if</span> dirname.endswith(<span class="string">&#x27;.dex&#x27;</span>):</span><br><span class="line">           filelist.append(dirname)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(dirname):</span><br><span class="line">           <span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> dirs:</span><br><span class="line">               <span class="comment"># if dir == &#x27;META-INF&#x27;:</span></span><br><span class="line">               <span class="comment"># print(&#x27;dir:&#x27;, os.path.join(root, dir))</span></span><br><span class="line">               filelist.append(os.path.join(root, <span class="built_in">dir</span>))</span><br><span class="line">           <span class="keyword">for</span> name <span class="keyword">in</span> files:</span><br><span class="line">               <span class="comment"># print(&#x27;file:&#x27;, os.path.join(root, name))</span></span><br><span class="line"></span><br><span class="line">               filelist.append(os.path.join(root, name))</span><br><span class="line"></span><br><span class="line">   z = zipfile.ZipFile(zipfilename, <span class="string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED)</span><br><span class="line">   <span class="keyword">for</span> tar <span class="keyword">in</span> filelist:</span><br><span class="line">       arcname = tar[<span class="built_in">len</span>(dirname):]</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="string">&#x27;META-INF&#x27;</span> <span class="keyword">in</span> arcname <span class="keyword">or</span> arcname.endswith(<span class="string">&#x27;.dex&#x27;</span>)) <span class="keyword">and</span> <span class="string">&#x27;.DS_Store&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> arcname:</span><br><span class="line">           z.write(tar, arcname)</span><br><span class="line">   print(<span class="string">&#x27;[*] APK打包成功，你可以拖入APK进行分析啦！&#x27;</span>  )</span><br><span class="line">   z.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_args</span>():</span></span><br><span class="line">   parser = argparse.ArgumentParser(description=<span class="string">&#x27;repackage dumped dex to apk for jeb/jadx analysis.&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--apk_path&#x27;</span>, required=<span class="literal">True</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;apk for extracting META-INF&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--dex_path&#x27;</span>, required=<span class="literal">True</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;path of dumped dex&#x27;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;repacked.apk&quot;</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&#x27;apk path after zip&#x27;</span>)</span><br><span class="line">   args = parser.parse_args()</span><br><span class="line">   <span class="comment">#print(args.apk_path)</span></span><br><span class="line">   <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   args = parse_args()</span><br><span class="line">   rename_class(args.dex_path)</span><br><span class="line">   check_dex(args.dex_path)</span><br><span class="line">   extract_META_INF_from_apk(args.apk_path, args.dex_path)</span><br><span class="line">   <span class="comment"># zip_file(args.dex_path)</span></span><br><span class="line">   zip_dir(args.dex_path, args.output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment"># usage</span></span><br><span class="line">   <span class="comment"># jadx 需要加入环境变量</span></span><br><span class="line">   <span class="comment"># python dex2apk.py -a ./baobaoshu.apk -i com.babytree.apps.pregnancy</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> others </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本来生活</title>
      <link href="benlaishenghuo/"/>
      <url>benlaishenghuo/</url>
      
        <content type="html"><![CDATA[<h1 id="INFO"><a href="#INFO" class="headerlink" title="INFO"></a>INFO</h1><p>app: com.android.benlailife.activity<br>name: 本来生活<br>version: 5.7.1</p><h1 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h1><p><code>frida-dexdump dump</code><br><code>grep -grep -rnli &quot;mainactivity&quot; ./</code><br>找到目标 <code>dex</code> 文件, 使用 <code>jadx-gui</code> 打开</p><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="sign-参数"><a href="#sign-参数" class="headerlink" title="sign 参数"></a>sign 参数</h2><p>直接全局搜索 “sign” 很容易定位到 <code>com.android.benlai.request.basic.c</code> 中的 <code>createSign</code>方法;<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-11-120100.png" alt="img"></p><ol><li>对输入的 map 根据键进行排序</li><li>遍历排序结果拼接成字符串</li><li>字符串末位添加 salt : <code>benlai</code></li><li>调用 <code>u.a</code>方法, 进入之后看到就是一个标准的 md5, 然后将 md5 的结果转成大写</li></ol><h2 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h2><p>清空 app 的缓存, 抓包发现在启动的较早时机会发出一个 <code>https://api.benlai.com/v5/token</code> 的请求; 此时的 <code>Authorization</code> 是一个定值; 写死或者通过 hook 获取都可以</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> CredentialsClazz = Java.use(<span class="string">&quot;okhttp3.Credentials&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> result = CredentialsClazz.basic(<span class="string">&quot;ffa50d1669fe48e3a512fe68d7f5d10e&quot;</span>,<span class="string">&quot;3e4b5ac89c5746ab8a1d72df8242b126&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;request_token_au&quot;</span>, result);</span><br></pre></td></tr></table></figure><p>通过 hook 的方式也可以手动获取和清空该值, 每次清空该值之后再请求都会触发 <code>https://api.benlai.com/v5/token</code> 请求;</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 authorization</span></span><br><span class="line"><span class="keyword">var</span> mmkvClazz = Java.use(<span class="string">&quot;com.tencent.mmkv.MMKV&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mmkv_token = mmkvClazz.mmkvWithID(<span class="string">&quot;MMKV_TOKEN&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;mmkv_token&quot;</span>, mmkv_token);</span><br><span class="line"><span class="keyword">var</span> result = mmkv_token.decodeString(<span class="string">&quot;GLOBAL_TOKEN&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空</span></span><br><span class="line">mmkv_token.encode(<span class="string">&quot;GLOBAL_TOKEN&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;重制 global_token&quot;</span>);</span><br></pre></td></tr></table></figure><p>拿到的响应内容为:<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-11-120622.png" alt="img"><br>access_token 就是之后请求数据要使用的 <code>Authorization</code>;</p><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">&quot;Kevin&quot;</span></span><br><span class="line">__time__ = <span class="string">&quot;2021/3/11&quot;</span></span><br><span class="line">__blog__ = <span class="string">&quot;https://kevinspider.github.io/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">deviceId = <span class="string">&#x27;010214c4-9b56-4130-a4d9-3124c82462f0&#x27;</span></span><br><span class="line">android_id = <span class="string">&#x27;37cea1958c8c5c1e&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encodeMethod</span>(<span class="params">params</span>):</span></span><br><span class="line">    dict_2 = <span class="built_in">dict</span>(<span class="built_in">sorted</span>(params.items(), key=<span class="keyword">lambda</span> i: i[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">input</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> dict_2:</span><br><span class="line">        <span class="built_in">input</span> += key + dict_2[key]</span><br><span class="line"></span><br><span class="line">    print(<span class="built_in">input</span>)</span><br><span class="line">    <span class="built_in">input</span> += <span class="string">&quot;benlai&quot;</span></span><br><span class="line"></span><br><span class="line">    md5 = hashlib.md5()</span><br><span class="line">    md5.update(<span class="built_in">input</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    md5_result = md5.hexdigest().upper()</span><br><span class="line">    <span class="keyword">return</span> md5_result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAccessToken</span>():</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Basic ZmZhNTBkMTY2OWZlNDhlM2E1MTJmZTY4ZDdmNWQxMGU6M2U0YjVhYzg5YzU3NDZhYjhhMWQ3MmRmODI0MmIxMjY=&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Dalvik/2.1.0(Linux;U;Android8.1.0;Nexus6PBuild/OPM7.181205.001)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;api.benlai.com&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;systemVersion&quot;</span>: <span class="string">&quot;8.1.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;phoneModel&quot;</span>: <span class="string">&quot;Nexus_6P&quot;</span>,</span><br><span class="line">        <span class="string">&quot;localcity&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pageid&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;source&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;nativeVersion&quot;</span>: <span class="string">&quot;5.7.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;t&quot;</span>: <span class="built_in">str</span>(<span class="built_in">int</span>(time.time() * <span class="number">1000</span>)),</span><br><span class="line">        <span class="string">&quot;imei&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="comment"># &quot;sign&quot;: &quot;48B07E12DB11CECBE2A00B86AFD851A8&quot;,</span></span><br><span class="line">        <span class="string">&quot;webId&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: <span class="string">&quot;5.7.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;android_id&quot;</span>: android_id,</span><br><span class="line">        <span class="string">&quot;channel&quot;</span>: <span class="string">&quot;yyb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;deviceId&quot;</span>: deviceId,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">      <span class="string">&#x27;grant_Type&#x27;</span>: <span class="string">&#x27;Client_Credentials&#x27;</span>,</span><br><span class="line">      <span class="comment"># &#x27;sign&#x27;: &#x27;48B07E12DB11CECBE2A00B86AFD851A8&#x27;,</span></span><br><span class="line">      <span class="string">&#x27;channel&#x27;</span>: <span class="string">&#x27;yyb&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;pageid&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;systemVersion&#x27;</span>: <span class="string">&#x27;8.1.0&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;deviceId&#x27;</span>: deviceId,</span><br><span class="line">      <span class="string">&#x27;phoneModel&#x27;</span>: <span class="string">&#x27;Nexus_6P&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;localcity&#x27;</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;nativeVersion&#x27;</span>: <span class="string">&#x27;5.7.1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;5.7.1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;webId&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;t&#x27;</span>: <span class="built_in">str</span>(<span class="built_in">int</span>(time.time() * <span class="number">1000</span>)),</span><br><span class="line">      <span class="string">&#x27;imei&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;android_id&#x27;</span>: android_id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    md5_result = encodeMethod(params)</span><br><span class="line"></span><br><span class="line">    data[<span class="string">&#x27;sign&#x27;</span>] = md5_result</span><br><span class="line">    params[<span class="string">&#x27;sign&#x27;</span>] = md5_result</span><br><span class="line"></span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.benlai.com/v5/token&#x27;</span>, headers=headers, params=params, data=data)</span><br><span class="line">    data = response.json()</span><br><span class="line"></span><br><span class="line">    access_token = data[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> access_token</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getList</span>(<span class="params">accessToken</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&quot;Bearer &quot;</span> + accessToken,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Dalvik/2.1.0(Linux;U;Android8.1.0;Nexus6PBuild/OPM7.181205.001)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;api.benlai.com&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;channel&#x27;</span>: <span class="string">&#x27;yyb&#x27;</span>,</span><br><span class="line">        <span class="comment"># &#x27;sign&#x27;: &#x27;615AECBF4D611D71934E999D0164A693&#x27;,</span></span><br><span class="line">        <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pageid&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;systemVersion&#x27;</span>: <span class="string">&#x27;8.1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;deviceId&#x27;</span>: deviceId,</span><br><span class="line">        <span class="string">&#x27;phoneModel&#x27;</span>: <span class="string">&#x27;Nexus_6P&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;limit&#x27;</span>: <span class="string">&#x27;10&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;categorySysNo&#x27;</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;offset&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;localcity&#x27;</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;5.7.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;nativeVersion&#x27;</span>: <span class="string">&#x27;5.7.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;webId&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;t&#x27;</span>: <span class="built_in">str</span>(<span class="built_in">int</span>(time.time() * <span class="number">1000</span>)),</span><br><span class="line">        <span class="string">&#x27;imei&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android_id&#x27;</span>: android_id,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    md5_result = encodeMethod(params)</span><br><span class="line">    params[<span class="string">&#x27;sign&#x27;</span>] = md5_result</span><br><span class="line"></span><br><span class="line">    response = requests.get(<span class="string">&#x27;https://api.benlai.com/v5/IHome/GetHomePageTagInfo&#x27;</span>, headers=headers, params=params)</span><br><span class="line">    print(response.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    accessToken = getAccessToken()</span><br><span class="line">    print(accessToken)</span><br><span class="line">    getList(accessToken)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> demo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>frida 抓包</title>
      <link href="zhuabao/"/>
      <url>zhuabao/</url>
      
        <content type="html"><![CDATA[<h1 id="Http-和-Https"><a href="#Http-和-Https" class="headerlink" title="Http 和 Https"></a>Http 和 Https</h1><h2 id="Http-的弊端"><a href="#Http-的弊端" class="headerlink" title="Http 的弊端"></a>Http 的弊端</h2><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-031554.jpg"></p><p>Http 在传输数据的过程中, 所有的数据都是明文传输的, 没有安全性可言; 想要让 Http 更加安全, 只能使用加密算法对信息进行加密之后再传输, 只要确保密钥不被第三方获取, 那么就能确保数据传输的安全性;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-031841.jpg"></p><p>在 Http 的基础上, 对原有的 Http 进行 TLS 或 SSL 的加密, 提高安全性; Https = Http + SSL/TLS</p><h2 id="Https-工作原理"><a href="#Https-工作原理" class="headerlink" title="Https 工作原理"></a>Https 工作原理</h2><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-032601.jpg" alt="未命名图片"></p><ul><li><p>证书验证</p><ul><li>  ① 客户端发起请求, 连接到服务端的443端口(Https 默认端口)</li><li>  ②采用 Http 协议的服务器必须要有一套数字 CA 证书, 颁发证书的同时会产生一个私钥和一个公钥, 私钥由服务端自己保存, 公钥则是附带在证书信息中, 可以公开; 证书本身也附带一个证书电子签名, 这个签名用来验证证书的完整性和真实性, 防止证书被篡改;</li><li>  ③服务器响应客户端请求, 将证书传递给客户端, 证书包含公钥和其他信息, 如: 证书颁发机构, 公司信息, 和证书有效期等;</li><li>④客户端解析证书并对其进行验证<ul><li>  如果证书不是可信机构颁布的, 或者证书中的域名和实际域名不一致, 或者证书已经过期, 就会向访问者显示一个警告, 告知风险; </li><li>  如果证书可信任, 进入接下来的数据传输中的非对称加密流程</li></ul></li></ul></li><li><p>数据传输</p><ul><li><p>非对称加密</p><p>  <img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-034704.png" alt="img"></p><ul><li>  客户端判断证书可信任, 客户端会从服务器证书中取出服务器的公钥, 并生成一个随机码 Key, 再使用服务器的公钥对 Key 进行加密;</li><li>  ⑤客户端将使用服务器公钥加密之后的 Key 的结果发送给服务器</li><li>  ⑥服务器使用自己的私钥对客户端发送过来的加密之后的 Key 进行解密, 获取到之后对称加密服务器和客户端通信的密钥 Key;</li></ul></li><li><p>对称加密</p><p>  <img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-034800.png" alt="img"></p><ul><li>  ⑦使用从客户端获取到的 Key 对信息进行加密, 发送给客户端</li><li>  ⑧之后客户端和服务器都通过这个 Key 对数据进行加解密, 传输所有的内容</li></ul></li></ul></li></ul><h1 id="SSl-和-TLS"><a href="#SSl-和-TLS" class="headerlink" title="SSl 和 TLS"></a>SSl 和 TLS</h1><h2 id="SSL-和-TLS-概念"><a href="#SSL-和-TLS-概念" class="headerlink" title="SSL 和 TLS 概念"></a>SSL 和 TLS 概念</h2><p>SSL 和 TLS 协议可以为通信双方提供识别和认证通道，从而保证通信的机密性和数据完整性。TLS 协议是从 Netscape SSL 3.0 协议演变而来的，不过这两种协议并不兼容，SSL 已经逐渐被 TLS 取代，所以下文就以 TLS 指代安全层;</p><h2 id="SSL-TLS-握手"><a href="#SSL-TLS-握手" class="headerlink" title="SSL/TLS 握手"></a>SSL/TLS 握手</h2><p>TLS 握手是启动 HTTPS 通信的过程，类似于 TCP 建立连接时的三次握手。 在 TLS 握手的过程中，通信双方交换消息以相互验证，相互确认，并确立它们所要使用的加密算法以及会话密钥 (用于对称加密的密钥)。可以说，TLS 握手是 HTTPS 通信的基础部分。</p><p>TLS 握手过程, 总共做了四件事:</p><ol><li> 商定双方通信所使用的 TLS 版本, 例如: TLS1.0, 1.2, 1.3等</li><li> 确定双方所要使用的密码组合;</li><li> 客户端通过服务器的公钥和数字证书上的数字签名验证服务端的身份;</li><li> 生成会话密钥, 并将密钥用于握手结束后的对称加密;</li></ol><p>详细过程:</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-04-09-051254.jpg" alt="未命名图片 (1)"></p><ol><li>“client hello” 消息: 客户端通过发送 “client hello” 消息向服务器发起握手请求, 该消息包含了:<ol><li> 客户端所支持的 TLS 版本和密码组合, 以供服务器进行选择</li><li> client random 随机字符串</li></ol></li><li>“server hello” 消息: 服务器发送 “server hello” 消息对客户端进行回应, 该消息包含了:<ol><li> 数字证书, 服务器选择的密码组合 </li><li> server random 随机字符串</li></ol></li><li>验证: 客户端对服务器发来的证书进行验证, 确保对方身份的合法性; 验证步骤为:<ol><li> 检查数字签名</li><li> 验证证书链</li><li> 检查证书的有效期</li><li> 检查证书撤回状态</li></ol></li><li> “premaster secret” 字符串: 客户端向服务器发送另一个随机字符串 “premaster secret” (预主密码), 这个字符串是经过服务器的公钥加密过的, 只有对应的私钥才能解密</li><li> 服务器使用私钥解密客户端发过来的加密的 “premaster secret”</li><li> 生成共享密钥: 经过上述步骤之后, 客户端和服务器都拥有了相同的 <strong>client random</strong>, <strong>server random</strong> 和 <strong>premaster secret</strong>, 并通过相同的算法生成相同的共享密钥 Key;</li><li> 客户端就绪: 客户端发送经过共享密钥 Key 加密后的 Finished 信号</li><li> 服务器就绪: 服务器发送经过共享密钥 Key 加密后的 Finished 信号</li><li> 达成安全通信: 握手完成, 双方使用对称加密进行安全通信</li></ol><h1 id="Https-中间人抓包"><a href="#Https-中间人抓包" class="headerlink" title="Https 中间人抓包"></a>Https 中间人抓包</h1><h2 id="高版本安卓系统如何导入证书"><a href="#高版本安卓系统如何导入证书" class="headerlink" title="高版本安卓系统如何导入证书"></a>高版本安卓系统如何导入证书</h2><ol><li><p><a href="https://github.com/Magisk-Modules-Repo/movecert">magisk - Move Certificates 模块</a></p></li><li><p>Aosp 直接将证书编译到系统中 <a href="https://www.52pojie.cn/thread-1382688-1-1.html">参考链接</a></p></li><li><p><a href="http://zhaoxincheng.com/index.php/2020/07/16/%E5%AE%89%E5%8D%937-0%E5%8F%8A%E4%BB%A5%E4%B8%8A%E6%8A%93%E5%8C%85%E8%AF%81%E4%B9%A6%E5%B0%8F%E6%8A%80%E5%B7%A7/">re 管理器</a></p></li><li><p>命令行</p><p>charles导出.cer证书，选择.cer类型 保存在pc上</p><ol><li>修改证书名称<br>系统证书目录：/system/etc/security/cacerts/<br>其中的每个证书的命名规则如下：<br><Certificate_Hash>.<br>文件名是一个Hash值，而后缀是一个数字。<br>文件名可以用下面的命令计算出来：<br>openssl x509 -subject_hash_old -in <Certificate_File><br>后缀名的数字是为了防止文件名冲突的，比如如果两个证书算出的Hash值是一样的话，那么一个证书的后缀名数字可以设置成0，而另一个证书的后缀名数字可以设置成1</li><li>复制证书到设备上<br>adb push xxxxxxx.0 /sdcard/</li><li>复制到系统目录并修改权限（安卓8.1.0 Magisk Root）<br>mount -o rw,remount /system 【不修改 没法写入】<br>mount -o rw,remount /<br>mv /sdcard/xxxxxxx.0 /etc/security/cacerts/ 移动文件到系统<br>chown root:root /etc/security/cacerts/fc365f9d.0 修改用户组<br>chmod 644 /system/etc/security/cacerts/xxxxxxx.0 修改权限</li></ol></li></ol><h2 id="抓包失败常见问题"><a href="#抓包失败常见问题" class="headerlink" title="抓包失败常见问题"></a>抓包失败常见问题</h2><ol><li>单向证书校验中 (C 校验 S), 没有将抓包工具证书放在手机中 <code>400 Bad Request</code></li><li>双向证书检验中 (S 校验 C), 没有向抓包工具配置 App 证书 <code>No required SSL certificate was sent</code></li><li>SSL PINNING 配置好了证书依然无法抓包</li></ol><h2 id="证书验证"><a href="#证书验证" class="headerlink" title="证书验证"></a>证书验证</h2><h3 id="什么是单向证书验证"><a href="#什么是单向证书验证" class="headerlink" title="什么是单向证书验证"></a>什么是单向证书验证</h3><p>单向认证流程中, 服务器端保存着公钥证书和私钥两个文件, 流程如下:<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-050703.jpg" alt="img"></p><ol><li>客户端发起建立 Https 连接请求, 将 SSL 协议版本的信息发送给服务器端;</li><li>服务器端将本机的公钥证书发送给客户端;</li><li>客户端读取公钥证书, 取出服务端公钥;</li><li>客户端生成一个随机数(秘钥 R), 用刚才得到的服务器公钥去加密这个随机数形成密文, 发送给服务端;</li><li>服务端用自己的私钥去解密密文, 得到秘钥 R;</li><li>服务端和客户端在之后的通讯中就使用秘钥 R 进行通信;</li></ol><h3 id="什么是双向证书验证"><a href="#什么是双向证书验证" class="headerlink" title="什么是双向证书验证"></a>什么是双向证书验证</h3><p>双向认证, 客户端和服务器端都需要验证对方的身份, 在建立 Https 连接的过程中, 握手的流程比单向认证多了几步; 单向认证过程, 客户端从服务器端下载服务器端公钥证书进行验证, 然后建立安全通信通道; 双向验证中, 客服端除了需要从服务器端下载服务器的公钥证书进行验证之外, 还需要把客户端的公钥证书上传到服务器端给服务器端进行验证, 等双方都认证通过了, 才开始建立安全通信通道进行数据传输;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-051308.jpg" alt="img"></p><ol><li>客户端发起建立 Https 连接请求, 将 SSL 协议版本的信息发送到服务器端;</li><li>服务器端将本机的公钥证书发送给客户端;</li><li>客户端读取公钥证书, 取出服务器公钥;</li><li>客户端将客户端的公钥证书发送给服务器端;</li><li>服务器端使用根证书解密客户端公钥证书, 拿到客户端公钥;</li><li>客户端发送自己支持的加密方案给服务器端;</li><li>服务器端根据自己和客户端支持的方法, 选择一个双方都能接收的加密方案, 使用客户端的公钥加密后发送给客户端;</li><li>客户端使用自己的私钥去解密密文, 得到秘钥 R;</li><li>服务器和客户端在后续通讯中使用秘钥 R 进行通信;</li></ol><h3 id="双向证书获取客户端证书和密码"><a href="#双向证书获取客户端证书和密码" class="headerlink" title="双向证书获取客户端证书和密码"></a>双向证书获取客户端证书和密码</h3><p>关键点:</p><ol><li>证书密码</li><li>cer 或者 p12 证书</li></ol><p>通杀方案:<br>通过 <code>r0ysue</code> 的 <a href="https://github.com/r0ysue/r0capture">r0capture</a> 进行 hook , 获取到证书;<br><code>python r0capture.py -U -f cn.soulapp.android -v &gt;&gt; soul3.txt</code><br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-062429.jpg" alt="img"><br>导出后的证书位于/sdcard/Download/包名xxx.p12路径，导出多次，每一份均可用，密码默认为：r0ysue，推荐使用keystore-explorer打开查看证书</p><p>手动方案:<br>例如 <code>soul</code> apk, 采用了双向证书验证;<br>对 apk 进行解包, tree 找到 client.cer 和 client.p12;<br>在 jadx 中进行反编译, 直接搜索 <code>client.p12</code> 定位到对应的 <code>load</code> 方法<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-065415.jpg" alt="img"><br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-065455.jpg" alt="img"><br>直接 hook 该方法就可以获取到证书的秘钥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path=&#x27;./index.d.ts&#x27;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_password</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> KeyStore =  Java.use(<span class="string">&quot;java.security.KeyStore&quot;</span>);</span><br><span class="line">        KeyStore.load.overload(<span class="string">&#x27;java.io.InputStream&#x27;</span>, <span class="string">&#x27;[C&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">inputStream, password</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;password is&quot;</span>, <span class="built_in">JSON</span>.stringify(password));</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.load(inputStream, password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hook_password)</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#125;%2R+\OSsjpP!w%X</span></span><br></pre></td></tr></table></figure><h3 id="如何将客户端证书配置到抓包工具"><a href="#如何将客户端证书配置到抓包工具" class="headerlink" title="如何将客户端证书配置到抓包工具"></a>如何将客户端证书配置到抓包工具</h3><p>charles -&gt; Proxy -&gt; SSL Proxying Settings -&gt; Server Certificates -&gt; Import P12 or PEM -&gt; 输入密码<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-03-065807.jpg" alt="img"></p><h3 id="requests-指定证书请求"><a href="#requests-指定证书请求" class="headerlink" title="requests 指定证书请求"></a>requests 指定证书请求</h3><p>安装 : <code>pip install requests_pkcs12</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests_pkcs12 <span class="keyword">import</span> get</span><br><span class="line"></span><br><span class="line">r = get(<span class="string">&#x27;https://example.com/test&#x27;</span>, pkcs12_filename=<span class="string">&#x27;clientcert.p12&#x27;</span>, pkcs12_password=<span class="string">&#x27;correcthorsebatterystaple&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="代理检测"><a href="#代理检测" class="headerlink" title="代理检测"></a>代理检测</h2><h3 id="代理检测原理"><a href="#代理检测原理" class="headerlink" title="代理检测原理"></a>代理检测原理</h3><p>检测用户是否使用了代理进行请求, 如果使用了代理, 那么很可能是中间人攻击, 强制中断请求;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 判断设备 是否使用代理上网</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isWifiProxy</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> IS_ICS_OR_LATER = Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH;</span><br><span class="line">        String proxyAddress; </span><br><span class="line">        <span class="keyword">int</span> proxyPort; </span><br><span class="line">        <span class="keyword">if</span> (IS_ICS_OR_LATER) &#123; </span><br><span class="line">            proxyAddress = System.getProperty(<span class="string">&quot;http.proxyHost&quot;</span>); </span><br><span class="line">            String portStr = System.getProperty(<span class="string">&quot;http.proxyPort&quot;</span>); </span><br><span class="line">            proxyPort = Integer.parseInt((portStr != <span class="keyword">null</span> ? portStr : <span class="string">&quot;-1&quot;</span>)); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            proxyAddress = android.net.Proxy.getHost(context); </span><br><span class="line">            proxyPort = android.net.Proxy.getPort(context); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> (!TextUtils.isEmpty(proxyAddress)) &amp;&amp; (proxyPort != -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="VPN-抓包"><a href="#VPN-抓包" class="headerlink" title="VPN 抓包"></a>VPN 抓包</h2><p>常用的抓包软件都是通过 <code>wifi</code> 设置 <code>http</code> 代理的方式进行抓包, 只是在应用层进行抓包, 很容易被检测和绕过;</p><p>使用以下 <code>api</code> 可以快速检测是否使用了 <code>http</code> 代理, 导致抓包失效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(&quot;http.proxyHost&quot;)&#96;</span><br><span class="line">&#96;System.getProperty(&quot;http.proxyPort&quot;)</span><br></pre></td></tr></table></figure><p><code>VPN</code> 抓包属于网络层, 开启 <code>VPN</code> 之后会在手机上新增一个虚拟网卡, 所有的流量都会从这个网卡上经过, 而且可以逃过上述两个 <code>api</code> 的检测;</p><h3 id="VPN-检测和绕过"><a href="#VPN-检测和绕过" class="headerlink" title="VPN 检测和绕过"></a>VPN 检测和绕过</h3><ol><li><code>java.net.NetworkInterface.getName()</code><br>该方法通过检测返回结果是否为 <code>tun0</code> 或 <code>ppp0</code> 来判断是否使用了 <code>vpn</code> ; <code>bypass</code> 的方法也比较简单, <code>hook</code> 这个方法, 然后返回 <code>&quot;rmnet_data1&quot;</code> 即可;</li><li><code>android.net.ConnectivityManager.getNetworkCapabilities()</code><br>该方法的返回值为 <code>null</code> 即可不被检测</li></ol><h2 id="SSL-Pinning"><a href="#SSL-Pinning" class="headerlink" title="SSL Pinning"></a>SSL Pinning</h2><h3 id="什么是-SSL-Pinning"><a href="#什么是-SSL-Pinning" class="headerlink" title="什么是 SSL Pinning"></a>什么是 SSL Pinning</h3><ul><li>SSL Pinning 是一种防止中间人攻击的技术, 主要机制是: 客户端发起请求 -&gt; 收到服务器发来的证书进行校验 -&gt; 如果收到的证书不被客户端信任, 那么就直接断开请求;</li><li>客户端预置了一份服务端的证书, 防止中间人攻击时被中间人伪造的服务端证书欺骗;</li><li>使用了 SSL pinning 技术的 App, 只信任指定的证书, 就算将自签名证书按照到系统目录中, App 也不会信任; 以此来对抗中间人攻击;</li></ul><ol><li>证书固定: 开发者将 SSL 证书的某些字节码硬编码在应用程序中; 当应用程序与服务器通信时, 它将检查证书中是否存在相同的字节码; 如果存在, 则应用程序将请求发送到服务器; 如果字节码不匹配, 它将抛出 SSL 证书错误; 这样可以防止攻击者使用自己的自签名证书;</li><li>公钥固定: 在客户端访问网站进行公钥固定中, 服务器将其公钥固定在客户端中, 当客户端重新访问同一个网站时, 服务器将标识其公共秘钥以检测连接的完整性;</li></ol><h3 id="双向验证和-SSL-Pinning-的区别"><a href="#双向验证和-SSL-Pinning-的区别" class="headerlink" title="双向验证和 SSL Pinning 的区别"></a>双向验证和 SSL Pinning 的区别</h3><ul><li>SSL Pinning 是客户端锁定服务器的证书, 在要与服务器进行交互的时候, 服务器端会将证书发送给客户端, 客户端调用函数对服务器端发来的证书进行校验, 与本地存放的的证书(一般存放在/asset 或/res/raw)进行对比;</li><li>双向证书认证是添加了客户端向服务器发送证书, 服务器对客户端的证书进行校验的部分;</li></ul><h3 id="如何定位-绕过已知通信框架的证书绑定"><a href="#如何定位-绕过已知通信框架的证书绑定" class="headerlink" title="如何定位/绕过已知通信框架的证书绑定"></a>如何定位/绕过已知通信框架的证书绑定</h3><ol><li>常见的 http 框架, 可以使用 <a href="https://github.com/sensepost/objection/blob/90044d7323ba6a302030cb9e02d90468036ae4b4/agent/src/android/pinning.ts">objection</a> 进行 hook : <code>android sslpinning disable</code><ul><li>Traditional HttpsURLConnection</li><li>OkHTTP</li><li>Retrofit (Wraps OkHTTP)</li><li>Volley (Uses a TrustManager)</li><li>Picasso (Uses a TrustManager)</li></ul></li><li><code>objection</code> 未覆盖的可以使用 <a href="https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js">ObjectionUnpinningPlus</a> 进行<ul><li>SSLcontext(ART only)</li><li>okhttp</li><li>webview</li><li>XUtils(ART only)</li><li>httpclientandroidlib</li><li>JSSE</li><li>network_security_config (android 7.0+)</li><li>Apache Http client (support partly)</li><li>OpenSSLSocketImpl</li><li>TrustKit</li><li>Cronet</li></ul></li><li><a href="https://github.com/r0ysue/r0capture">r0capture</a> 应用层抓包通杀<ul><li>spawn 模式: <code>python3 r0capture.py -U -f com.qiyi.video -v</code></li><li>attach 模式: <code>python3 r0capture.py -U com.qiyi.video -v</code></li><li><code>-p fileName.pcap</code> : 抓包并保存为 pcap 文件, 后续使用 Wireshark 进行分析</li><li><code>&gt;&gt; fileName.txt</code>: 将抓包内容重定向到指定文本中, 方便过滤</li><li>客户端证书导出功能, 默认开启, 需要用 spawn 模式运行, 需要手动给 app 添加存储卡读取权限;导出后的证书位于/sdcard/Download/包名xxx.p12路径, 密码默认<code>r0ysue</code>;</li><li><code>-H</code>，用于Frida-server监听在非标准端口时的连接</li></ul></li></ol><h3 id="如何定位-绕过未知框架的证书绑定"><a href="#如何定位-绕过未知框架的证书绑定" class="headerlink" title="如何定位/绕过未知框架的证书绑定"></a>如何定位/绕过未知框架的证书绑定</h3><ol><li>Hook Java 的 File 类构造函数, 证书肯定要被读取到内存中, 找到证书路径;</li><li>检测客户端证书的读取</li><li>打印调用栈, 定位到证书绑定代码</li></ol><h1 id="大众点评通用抓包"><a href="#大众点评通用抓包" class="headerlink" title="大众点评通用抓包"></a>大众点评通用抓包</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> cls = Java.use(<span class="string">&quot;com.dianping.nvnetwork.tunnel2.a&quot;</span>);</span><br><span class="line">    cls.isSocketConnected.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="淘系抓包"><a href="#淘系抓包" class="headerlink" title="淘系抓包"></a>淘系抓包</h1><p>使用Charles、Fiddle等抓包工具对淘系App进行抓包时，你会发现总是抓不到包，出现请求不走Charles代理的情况。这是因为淘系app底层网络通信的协议并不是普通的http协议，而是自己实现的一套私有协议Spdy。</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-22-062221.jpg" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-22-062221.jpg"></p><p>所以我们只要通过hook将是否使用spdy返回false既可;</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> SwitchConfig = Java.use(<span class="string">&#x27;mtopsdk.mtop.global.SwitchConfig&#x27;</span>);</span><br><span class="line">    SwitchConfig.nQ.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="美团外卖抓包"><a href="#美团外卖抓包" class="headerlink" title="美团外卖抓包"></a>美团外卖抓包</h1><p><a href="https://zckun.github.io/2019/09/13/python-mtwm-capture/">https://zckun.github.io/2019/09/13/python-mtwm-capture/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptable -A INPUT -s ***.**.***.181 -j DROP #屏蔽&#96;</span><br><span class="line">&#96;iptable -D INPUT -s ***.**.***.181 -j DROP #解除屏蔽&#96;</span><br><span class="line">&#96;service iptables save</span><br></pre></td></tr></table></figure><h1 id="r0capture-抓包分析"><a href="#r0capture-抓包分析" class="headerlink" title="r0capture 抓包分析"></a>r0capture 抓包分析</h1><h2 id="Hook-抓取-Http-包"><a href="#Hook-抓取-Http-包" class="headerlink" title="Hook 抓取 Http 包"></a>Hook 抓取 Http 包</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h3 id="hook-点"><a href="#hook-点" class="headerlink" title="hook 点"></a>hook 点</h3><h3 id="frida-参考-r0capture"><a href="#frida-参考-r0capture" class="headerlink" title="frida (参考 r0capture)"></a>frida (参考 r0capture)</h3><h2 id="Hook-抓取-Https-包"><a href="#Hook-抓取-Https-包" class="headerlink" title="Hook 抓取 Https 包"></a>Hook 抓取 Https 包</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><h3 id="Hook-点-如何确定-SSL-库的关键-API"><a href="#Hook-点-如何确定-SSL-库的关键-API" class="headerlink" title="Hook 点 (如何确定 SSL 库的关键 API)"></a>Hook 点 (如何确定 SSL 库的关键 API)</h3><h3 id="协议使用了系统中的-SSL-类库"><a href="#协议使用了系统中的-SSL-类库" class="headerlink" title="协议使用了系统中的 SSL 类库"></a>协议使用了系统中的 SSL 类库</h3><h4 id="java"><a href="#java" class="headerlink" title="java"></a>java</h4><h4 id="native"><a href="#native" class="headerlink" title="native"></a>native</h4><h3 id="协议使用了自我集成的-SSL-类库"><a href="#协议使用了自我集成的-SSL-类库" class="headerlink" title="协议使用了自我集成的 SSL 类库"></a>协议使用了自我集成的 SSL 类库</h3><h4 id="java-1"><a href="#java-1" class="headerlink" title="java"></a>java</h4>]]></content>
      
      
      <categories>
          
          <category> frida </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 抓包 </tag>
            
            <tag> frida </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>frida ollvm</title>
      <link href="fridaollvm/"/>
      <url>fridaollvm/</url>
      
        <content type="html"><![CDATA[<h1 id="ollvm-字符串混淆"><a href="#ollvm-字符串混淆" class="headerlink" title="ollvm 字符串混淆"></a>ollvm 字符串混淆</h1><h2 id="ollvm-默认字符串混淆"><a href="#ollvm-默认字符串混淆" class="headerlink" title="ollvm 默认字符串混淆"></a>ollvm 默认字符串混淆</h2><p>特征:</p><ul><li><p><code>export</code> 中存在 <code>.datadiv_decode</code> 字样的函数</p></li><li><p>点击进入这些函数可以看到大量异或操作</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-013823.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-013823.png"></p></li><li><p>ollvm 字符串混淆, 在静态的时候无法看到字符串, 执行起来先调用 <code>.init_array</code> 里面的函数解密字符串, 解密之后内存中的字符串是明文状态</p></li></ul><p>hook 代码:</p><p>找到混淆了的字符串对应在 <code>.data</code> 数据段的地址, hook 该地址并进行打印即可获取到明文</p><p>将 <code>RegisterNative</code> 对应的 <code>methods</code> 结构体找出来, 并使用 ida 转换成指针 <code>DCQ</code> 找到对应的位置</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020055.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020055.png"></p><p>跳转过去就是对应的函数体的起始位置 <code>.data</code> 段 0x37070, 打印即可;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020231.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020231.png"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printbytestring</span>(<span class="params">byteaddr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;base_addr &quot;</span>, base_addr);</span><br><span class="line">    <span class="built_in">console</span>.log(ptr(base_addr.add(byteaddr)).readCString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ollvm-init-array-中注册加密方法"><a href="#ollvm-init-array-中注册加密方法" class="headerlink" title="ollvm .init_array 中注册加密方法"></a>ollvm .init_array 中注册加密方法</h2><p>在 <code>export</code> 中无法找到 <code>.datadiv.encode</code> 标识的加密方法, 说明不是使用默认的加密方法进行混淆的, 可以在 <code>ida view-A</code> 界面中使用 <code>control + s</code> 打开 <code>segment</code> 进行跳转, 跳转到 <code>.init_array</code> 中查看</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020819.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-020819.png"></p><p>点击 <code>DCQ</code> 所指向的位置, 就可以找到加密;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021113.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021113.png"></p><p>针对这种形式的加密, 不同于正常的 <code>byte_地址 ^= 十六进制无符号数</code> ,这种只会出现在 64 位上面, 关注点在 <code>v0</code> 上,</p><p><code>stru_37010[0]</code> , <code>stru_37010[1]</code> 分别对应的值为:</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021509.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021509.png"></p><p><code>v0</code> 可以在汇编中看到赋值</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021805.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-021805.png"></p><p>也就是对 <code>stru_37010</code> 中的两个值和 <code>0xC6</code> 进行异或操作, 就可以获取到正常显示的明文字符串;</p><p>对于这种多个值和单个值异或的, 可以将前面的看做是一个数组, 在 ida 中修改数组的长度, 合并成一个值; 点击进入该地址, 右键 array, 设置长度即可</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-022754.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-022754.png"></p><p>使用 <code>python</code> 进行解密</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">&quot;Kevin&quot;</span></span><br><span class="line">__time__ = <span class="string">&quot;2021/3/2&quot;</span></span><br><span class="line">__blog__ = <span class="string">&quot;https://kevinspider.github.io/&quot;</span></span><br><span class="line"></span><br><span class="line"># 0xE7E68F888CE6ABA90xB4A0E6A9AAAAA38E</span><br><span class="line"># 0xE6AEB2AFB1E6A2A30xAAAFB6ABA985E6E6</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">decode</span><span class="params">(inputStr, flag)</span>:</span></span><br><span class="line"><span class="function">    inputStr </span>= inputStr.replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    print(inputStr)</span><br><span class="line">    myArray = re.findall(r<span class="string">&#x27;\w&#123;1,2&#125;&#x27;</span>,inputStr)</span><br><span class="line">    bytesArray = []</span><br><span class="line">    <span class="keyword">for</span> each in myArray:</span><br><span class="line">        bytesArray.append(<span class="string">&quot;0x&quot;</span> + each)</span><br><span class="line">    bytesArray.reverse()</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each in bytesArray:</span><br><span class="line">        str = <span class="keyword">int</span>(eval(each) ^ flag)</span><br><span class="line">        result += chr(str)</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    decode(<span class="string">&quot;0xE7E68F888CE6ABA90xB4A0E6A9AAAAA38E&quot;</span>,<span class="number">0xC6</span>)</span><br></pre></td></tr></table></figure><h2 id="ollvm-加密算法内置在函数中"><a href="#ollvm-加密算法内置在函数中" class="headerlink" title="ollvm 加密算法内置在函数中"></a>ollvm 加密算法内置在函数中</h2><p>在 <code>export</code> 中无法找到 <code>.datadiv.encode</code> 标识的加密方法, 说明不是使用默认的加密方法进行混淆的, 可以在 <code>ida view-A</code> 界面中使用 <code>control + s</code> 打开 <code>segment</code> 进行跳转, 跳转到 <code>.init_array</code> 中查看, 也没有找到对应的加密方法, 那么可能加密和解密是在 <code>jni_onload</code> 中进行的</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-034625.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-034625.png"></p><p>在汇编中找到对应异或操作的位置, 然后打印异或之后的结果</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-034915.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-12-17-034915.png"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inline_hook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_0731C = base_addr.add(<span class="number">0x07320</span>); <span class="comment">// 0x0731C  0x07320</span></span><br><span class="line">    Interceptor.attach(addr_0731C, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;onenter : x13&quot;</span>, <span class="built_in">this</span>.context.x13);</span><br><span class="line">            <span class="comment">// console.log(&quot;onenter : x14&quot;, this.context.x14);</span></span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;onLeave : retval&quot;, retval);</span></span><br><span class="line">            <span class="comment">// console.log(&quot;onLeave : x13&quot;, this.context.x13);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(android_dlopen_ext);</span><br><span class="line"><span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">    Interceptor.attach(android_dlopen_ext,&#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> soName = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="built_in">console</span>.log(soName);</span><br><span class="line">            <span class="keyword">if</span>(soName.indexOf(<span class="string">&quot;libhello-jni.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">this</span>.hook) &#123;</span><br><span class="line">                inline_hook();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">__author__ = <span class="string">&quot;Kevin&quot;</span></span><br><span class="line">__time__ = <span class="string">&quot;2021/3/2&quot;</span></span><br><span class="line">__blog__ = <span class="string">&quot;https://kevinspider.github.io/&quot;</span></span><br><span class="line"></span><br><span class="line">inputStr = <span class="string">&quot;28 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 29 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 00&quot;</span></span><br><span class="line">myArray = inputStr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">byteArray = []</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> myArray:</span><br><span class="line">    byteArray.append(<span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span> + each))</span><br><span class="line"></span><br><span class="line">str = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> byteArray:</span><br><span class="line">    str += chr(each)</span><br><span class="line">print(str)</span><br></pre></td></tr></table></figure><h1 id="ollvm-控制流混淆"><a href="#ollvm-控制流混淆" class="headerlink" title="ollvm 控制流混淆"></a>ollvm 控制流混淆</h1><p>解决思路</p><ul><li>从输入开始, 观察每个参数在哪里被算法调用</li><li>优先看被算法的调用, 如果函数算法走到头再看赋值</li><li>赋值看完再看引用</li><li>以上步骤重复进行</li><li>输入的参数找不到再从返回开始找, 返回可能是 return 出来的结果, 也可能是一个入参的指针, 使用 <code>hexdump</code> 打印进行校验</li><li>进入算法后, 观察是否是混淆的; 如果没有混淆, 那么可以将常量转成 <code>hex</code> 然后 <code>google</code> 搜索常量, 有帮助找出算法的特征; 如果有混淆的话, 那么不需要搜索常量, 因为控制流平坦化之后有大量常量用来跳转, 搜索没啥意义</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path=&#x27;./index.d.ts&#x27;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">从输入开始, 观察每个参数在哪里被算法调用</span></span><br><span class="line"><span class="comment">优先看被算法的调用, 如果函数算法走到头再看赋值</span></span><br><span class="line"><span class="comment">赋值看完再看引用</span></span><br><span class="line"><span class="comment">重复进行</span></span><br><span class="line"><span class="comment">输入的参数找不到再从返回开始找 返回可能是 return出来的结果 也可能是一个入参的指针</span></span><br><span class="line"><span class="comment">进入算法后 观察是否是混淆的 如果没有混淆 那么可以将常量转成 hex 然后 google 搜索常量, 有帮助找出算法的特征</span></span><br><span class="line"><span class="comment">如果有混淆的话 那么不需要搜索常量 因为控制流平坦化之后有大量常量用来跳转 搜索没啥意义</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooknewstringutf</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newstringutf = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jni 系统函数都在 libart.so 中</span></span><br><span class="line">    <span class="keyword">var</span> module_libart = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> symbols = module_libart.enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = symbols[i].name;</span><br><span class="line">        <span class="keyword">if</span> ((name.indexOf(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>) </span><br><span class="line">&amp;&amp; (name.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span>) </span><br><span class="line">&amp;&amp; (name.indexOf(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;NewStringUTF&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(name);</span><br><span class="line">                <span class="comment">// 获取到指定 jni 方法地址</span></span><br><span class="line">                newstringutf = symbols[i].address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Interceptor.attach(newstringutf, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;args[0] is : &quot;</span>, args[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;args[1] is : &quot;</span>, ptr(args[<span class="number">1</span>]).readCString());</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;newstringutf onEnter called from:\n&#x27;</span> +</span><br><span class="line">                    Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.FUZZY)</span><br><span class="line">                    .map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// retval const char*</span></span><br><span class="line">                <span class="comment">// console.log(&quot;GetStringUTFChars onLeave : &quot;, ptr(retval).readCString());</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookSign2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> HelloJni = Java.use(<span class="string">&quot;com.example.hellojni.HelloJni&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;HelloJni&quot;</span>, HelloJni);</span><br><span class="line">        HelloJni.sign2.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">arg1, arg2</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(arg1);</span><br><span class="line">            <span class="built_in">console</span>.log(arg2);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.sign2(arg1, arg2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hookSign2&quot;</span>, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果是大型 app 需要多个操作, 这个时候主动调用比较方便</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeSign2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.example.hellojni.HelloJni&quot;</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;find com.example.hellojni.HelloJni&quot;</span>, instance);</span><br><span class="line">                <span class="comment">// 如果每次传入的值都是随机的, 不方便进行分析, 可以先找到关键点 hook 住, </span></span><br><span class="line">                <span class="comment">// 然后主动调用, 固定入参, 方便进行分析;</span></span><br><span class="line">                <span class="keyword">var</span> result = instance.sign2(<span class="string">&quot;123&quot;</span>,<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;invokeSign2&quot;</span>, result);</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;complete!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_native</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;hook_native&quot;</span>, <span class="string">&quot;base_addr&quot;</span>, base_addr);</span><br><span class="line">    <span class="keyword">var</span> addr_13558 = base_addr.add(<span class="string">&quot;0x13558&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_13558, &#123;</span><br><span class="line">        <span class="comment">// addr_13558 指针 char* len</span></span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 怀疑第一个指针是留着传递执行结果的, 进入的时候先保留 执行结束打印</span></span><br><span class="line">            <span class="comment">// 最好是把指针类型的在进来的时候打印一次 出去的时候再打印一次 方便查看是否函数结束后指针指向的内容被改变了</span></span><br><span class="line">            <span class="built_in">this</span>.result = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_13558 onenter&quot;</span>, ptr(args[<span class="number">1</span>]).readCString(), args[<span class="number">2</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_13558 onleave&quot;</span>, <span class="string">&quot;arg1&quot;</span>,hexdump(<span class="built_in">this</span>.result));</span><br><span class="line">            <span class="comment">// console.log(&quot;addr_13558 onleave&quot;, &quot;retval&quot;, hexdump(retval));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_13558 onleave&quot;</span>, <span class="string">&quot;retval&quot;</span>, ptr(retval).readCString());</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_12D70 = base_addr.add(<span class="string">&quot;0x12D70&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_12D70, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 第一个参数是字符串 第二个参数是字符串</span></span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onenter&quot;</span>,<span class="string">&quot;arg1&quot;</span>,ptr(args[<span class="number">0</span>]).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onenter&quot;</span>,<span class="string">&quot;arg2&quot;</span>,ptr(args[<span class="number">1</span>]).readCString());</span><br><span class="line">            <span class="comment">// 分析 native 算法的时候, 不确定是什么格式 先用 hexdump 打印</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onenter&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(args[<span class="number">2</span>]));</span><br><span class="line">            <span class="comment">// 还可以往深入一层再当做一个指针再打印一次</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onenter&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(ptr(args[<span class="number">2</span>]).readPointer()));</span><br><span class="line">        &#125;, </span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onleave&quot;</span>,<span class="string">&quot;arg1&quot;</span>,ptr(<span class="built_in">this</span>.arg1).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onleave&quot;</span>,<span class="string">&quot;arg2&quot;</span>,ptr(<span class="built_in">this</span>.arg2).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onleave&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(<span class="built_in">this</span>.arg3));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_12D70 onleave&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(ptr(<span class="built_in">this</span>.arg3).readPointer()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_162B8 = base_addr.add(<span class="string">&quot;0x162B8&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_162B8, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">1</span>]</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onenter arg1&quot;</span>, hexdump(args[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onenter arg2&quot;</span>, args[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onenter arg3&quot;</span>, hexdump(args[<span class="number">2</span>]));</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;addr_162B8 onleave retval&quot;, hexdump(retval));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onleave retval&quot;</span>, ptr(retval).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onleave arg1&quot;</span>, hexdump(<span class="built_in">this</span>.arg1));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onleave arg2&quot;</span>, <span class="built_in">this</span>.arg2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_162B8 onleave arg3&quot;</span>, hexdump(<span class="built_in">this</span>.arg3));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_130F0 = base_addr.add(<span class="string">&quot;0x130F0&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_130F0, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">1</span>]</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">2</span>]</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;enter&quot;</span>,ptr(<span class="built_in">this</span>.arg1).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;enter&quot;</span>,ptr(<span class="built_in">this</span>.arg2).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;enter&quot;</span>,<span class="built_in">this</span>.arg3);</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;retval&quot;</span>,hexdump(retval));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;retval&quot;</span>,retval);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;leave&quot;</span>,ptr(<span class="built_in">this</span>.arg1).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;leave&quot;</span>,ptr(<span class="built_in">this</span>.arg2).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_130F0&quot;</span>,<span class="string">&quot;leave&quot;</span>,<span class="built_in">this</span>.arg3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_15F1C = base_addr.add(<span class="string">&quot;0x15F1C&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_15F1C, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;enter&quot;</span>,<span class="string">&quot;arg1&quot;</span>,ptr(<span class="built_in">this</span>.arg1).readCString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;enter&quot;</span>,<span class="string">&quot;arg2&quot;</span>,<span class="built_in">this</span>.arg2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;enter&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(<span class="built_in">this</span>.arg3));</span><br><span class="line">            hooknewstringutf();</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;leave&quot;</span>,<span class="string">&quot;arg1&quot;</span>,ptr(<span class="built_in">this</span>.arg1).readCString());</span><br><span class="line">            <span class="comment">// console.log(&quot;addr_15F1C&quot;,&quot;leave&quot;,&quot;arg2&quot;,ptr(this.arg2).readCString());</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;leave&quot;</span>,<span class="string">&quot;arg2&quot;</span>,<span class="built_in">this</span>.arg2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;leave&quot;</span>,<span class="string">&quot;arg3&quot;</span>,hexdump(<span class="built_in">this</span>.arg3));</span><br><span class="line">            <span class="comment">// console.log(&quot;addr_15F1C&quot;,&quot;leave&quot;,&quot;arg3&quot;,hexdump(ptr(this.arg3).readPointer()));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;addr_15F1C&quot;</span>,<span class="string">&quot;leave&quot;</span>,<span class="string">&quot;retval&quot;</span>,hexdump(retval));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_12644 = base_addr.add(<span class="string">&quot;0x12648&quot;</span>);</span><br><span class="line">    Interceptor.attach(addr_12644, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;x12&quot;, this.context.x12);</span></span><br><span class="line">            <span class="comment">// console.log(hexdump(this.context.x12));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.context));</span><br><span class="line">            <span class="comment">// this._x12 = this.x12;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retva</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// console.log(&quot;addr_12644 leave&quot;, this._r12);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printbytestring</span>(<span class="params">byteaddr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhello-jni.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;base_addr &quot;</span>, base_addr);</span><br><span class="line">    <span class="built_in">console</span>.log(ptr(base_addr.add(byteaddr)).readCString());</span><br><span class="line">    <span class="built_in">console</span>.log(hexdump(Memory.readByteArray(ptr(base_addr.add(byteaddr)),<span class="number">32</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setImmediate(hook_native);</span><br></pre></td></tr></table></figure><h2 id="ollvm-花指令替换"><a href="#ollvm-花指令替换" class="headerlink" title="ollvm 花指令替换"></a>ollvm 花指令替换</h2><p>判断标志: 含有大量的判断, 在判断中含有大量长数值运算的复杂运算<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-05-021003.jpg" alt="img"></p><h2 id="ollvm-虚假控制流"><a href="#ollvm-虚假控制流" class="headerlink" title="ollvm 虚假控制流"></a>ollvm 虚假控制流</h2><p>判断标准: exports 导出函数中有大量的 <code>x.</code> 和 <code>y.</code> 开头的函数<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-05-021716.jpg" alt="img"><br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-05-021804.jpg" alt="img"></p><p>当疑似加密位置的结果和入参寄存器中没有找到加密返回值的时候, 在 <code>arm64</code> 中需要关注 <code>x8</code> 寄存器, 因为在 <code>arm64</code> 中, <code>x8</code> 寄存器比较特殊, 如果返回值的长度大于 16 个字节, 那么就会将返回值内容的地址放在 <code>x8</code> 寄存器中;</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-08-025315.jpg" alt="img"><br>类似这种的返回值, 形式类似 std 字符串, 使用 <code>hexdump(this.x8.add(Process.pointerSize * 2).readPointer())</code> 进行打印;</p>]]></content>
      
      
      <categories>
          
          <category> frida </category>
          
      </categories>
      
      
        <tags>
            
            <tag> frida </tag>
            
            <tag> ollvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>frida hook so</title>
      <link href="fridahookso/"/>
      <url>fridahookso/</url>
      
        <content type="html"><![CDATA[<h1 id="frida-env"><a href="#frida-env" class="headerlink" title="frida env"></a>frida env</h1><p><a href="https://github.com/frida/frida-java-bridge/blob/master/lib/env.js">https://github.com/frida/frida-java-bridge/blob/master/lib/env.js</a></p><h1 id="IDA-判断-Thumb-指令集和-Arm-指令集"><a href="#IDA-判断-Thumb-指令集和-Arm-指令集" class="headerlink" title="IDA 判断 Thumb 指令集和 Arm 指令集"></a>IDA 判断 Thumb 指令集和 Arm 指令集</h1><ul><li>IDA - Options - General - number of opcode bytes - 设置为 4</li><li>此时查看 IDA VIew 中 opcode 的长度, 如果出现 2 个字节和 4 个字节的, 说明为 thumb 指令集</li><li>如果都是 4 个字节的, 说明是 arm 指令集;</li><li>在 Thumb 指令集下, inline hook 的偏移地址需要进行 +1 操作;</li></ul><h1 id="枚举内存中的-so-文件"><a href="#枚举内存中的-so-文件" class="headerlink" title="枚举内存中的 so 文件"></a>枚举内存中的 so 文件</h1><p>用于查看目标 module 是否被正常加载, 使用 <code>Process.enumerateModules()</code> 将当前加载的所有 so 文件打印出来</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_native</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = Process.enumerateModules();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> modules)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = modules[i];</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">module</span>.name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">module</span>.name.indexOf(<span class="string">&quot;target.so&quot;</span>) &gt; -<span class="number">1</span> )&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">module</span>.base);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="获取指定-so-文件的基地址"><a href="#获取指定-so-文件的基地址" class="headerlink" title="获取指定 so 文件的基地址"></a>获取指定 so 文件的基地址</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_module</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> baseAddr = Module.findBaseAddress(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;baseAddr&quot;</span>, baseAddr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="获取指定-so-文件的函数"><a href="#获取指定-so-文件的函数" class="headerlink" title="获取指定 so 文件的函数"></a>获取指定 so 文件的函数</h1><h2 id="通过导出函数名定位-native-方法"><a href="#通过导出函数名定位-native-方法" class="headerlink" title="通过导出函数名定位 native 方法"></a>通过导出函数名定位 native 方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_func_from_exports</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> add_c_addr = Module.findExportByName(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="string">&quot;add_c&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;add_c_addr is :&quot;</span>,add_c_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="通过-symbols-符号定位-native-方法"><a href="#通过-symbols-符号定位-native-方法" class="headerlink" title="通过 symbols 符号定位 native 方法"></a>通过 symbols 符号定位 native 方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find_func_from_symbols</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> NewStringUTF_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> symbols) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.name.indexOf(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol.name.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) &lt; <span class="number">0</span></span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">&quot;NewStringUTF&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;find target symbols&quot;</span>, symbol.name, <span class="string">&quot;address is &quot;</span>, symbol.address);</span><br><span class="line">                NewStringUTF_addr = symbol.address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;NewStringUTF_addr is &quot;</span>, NewStringUTF_addr);</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(NewStringUTF_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;args0&quot;</span>,args[<span class="number">0</span>])</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;args0&quot;</span>, args[<span class="number">0</span>], hexdump(args[<span class="number">0</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;args1&quot;</span>, args[<span class="number">1</span>], hexdump(args[<span class="number">1</span>]));</span><br><span class="line">            <span class="keyword">var</span> env = Java.vm.tryGetEnv();</span><br><span class="line">            <span class="keyword">if</span> (env != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 直接读取 c 里面的 char</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Memory readCstring is :&quot;</span>, Memory.readCString(args[<span class="number">1</span>]));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;get env error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">returnResult</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;result: &quot;</span>, Java.cast(returnResult, Java.use(<span class="string">&quot;java.lang.String&quot;</span>)));</span><br><span class="line">            <span class="keyword">var</span> env = Java.vm.tryGetEnv();</span><br><span class="line">            <span class="keyword">if</span> (env != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> jstring = env.newStringUtf(<span class="string">&quot;修改返回值&quot;</span>);</span><br><span class="line">                returnResult.replace(ptr(jstring));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="通过地址偏移-inline-hook-任意函数"><a href="#通过地址偏移-inline-hook-任意函数" class="headerlink" title="通过地址偏移 inline-hook 任意函数"></a>通过地址偏移 inline-hook 任意函数</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// get base address of target so;</span></span><br><span class="line">    <span class="keyword">var</span> libnative_lib_addr = Module.findBaseAddress(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;base module addr -&gt;&quot;</span>, libnative_lib_addr);</span><br><span class="line">    <span class="keyword">if</span> (libnative_lib_addr)&#123;</span><br><span class="line">        <span class="keyword">var</span> add_addr1 = Module.findExportByName(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="string">&quot;_Z5r0addii&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> add_addr2 = libnative_lib_addr.add(<span class="number">0x94B2</span> + <span class="number">1</span>); <span class="comment">// 32位需要加1</span></span><br><span class="line">        <span class="built_in">console</span>.log(add_addr1);</span><br><span class="line">        <span class="built_in">console</span>.log(add_addr2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主动调用</span></span><br><span class="line">    <span class="keyword">var</span> add1 = <span class="keyword">new</span> NativeFunction(add_addr1, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> add2 = <span class="keyword">new</span> NativeFunction(add_addr2, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;add1 result is -&gt;&quot;</span> + add1(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;add2 result is -&gt;&quot;</span> + add2(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">base module addr -&gt; 0xd430b000</span></span><br><span class="line"><span class="comment">0xd43144b3</span></span><br><span class="line"><span class="comment">0xd43144b3</span></span><br><span class="line"><span class="comment">add1 result is -&gt;30</span></span><br><span class="line"><span class="comment">add2 result is -&gt;30</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h1 id="通过-Intercept-拦截器打印-native-方法参数和返回值-并修改返回值"><a href="#通过-Intercept-拦截器打印-native-方法参数和返回值-并修改返回值" class="headerlink" title="通过 Intercept 拦截器打印 native 方法参数和返回值, 并修改返回值"></a>通过 Intercept 拦截器打印 native 方法参数和返回值, 并修改返回值</h1><ul><li><code>onEnter</code>: 函数(args) : 回调函数, 给定一个参数 args, 用于读取或者写入参数作为 <code>NativePointer</code> 对象的指针;</li><li><code>onLeave</code>: 函数(retval) : 回调函数给定一个参数 retval, 该参数是包含原始返回值的 NativePointer 派生对象; 可以调用 <code>retval.replace(1234)</code> 以整数 1234 替换返回值, 或者调用<code>retval.replace(ptr(&quot;0x1234&quot;))</code> 以替换为指针;</li><li>注意: <code>retval</code> 对象会在 <code>onLeave</code> 调用中回收, 因此不要将其存储在回调之外使用, 如果需要存储包含的值, 需要制作深拷贝, 如 <code>ptr(retval.toString())</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">find_func_from_exports</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> add_c_addr = Module.findExportByName(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="string">&quot;add_c&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;add_c_addr is :&quot;</span>,add_c_addr);</span><br><span class="line">    <span class="comment">// 添加拦截器</span></span><br><span class="line">    Interceptor.attach(add_c_addr,&#123;</span><br><span class="line">        <span class="comment">// 打印入参</span></span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;add_c called&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg1:&quot;</span>,args[<span class="number">0</span>].toInt32());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;arg2&quot;</span>, args[<span class="number">1</span>].toInt32());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 打印返回值</span></span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">returnValue</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;add_c result is :&quot;</span>, returnValue.toInt32());</span><br><span class="line">            <span class="comment">// 修改返回值</span></span><br><span class="line">            returnValue.replace(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="通过-Intercept-拦截器替换原方法"><a href="#通过-Intercept-拦截器替换原方法" class="headerlink" title="通过 Intercept 拦截器替换原方法"></a>通过 Intercept 拦截器替换原方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">frida_Interceptor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="comment">//这个c_getSum方法有两个int参数、返回结果为两个参数相加</span></span><br><span class="line">       <span class="comment">//这里用NativeFunction函数自己定义了一个c_getSum函数</span></span><br><span class="line">       <span class="keyword">var</span> add_method = <span class="keyword">new</span> NativeFunction(Module.findExportByName(<span class="string">&#x27;libhello.so&#x27;</span>, <span class="string">&#x27;c_getSum&#x27;</span>), </span><br><span class="line">       <span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">       <span class="comment">//输出结果 那结果肯定就是 3</span></span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&quot;result:&quot;</span>,add_method(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">       <span class="comment">//这里对原函数的功能进行替换实现</span></span><br><span class="line">       Interceptor.replace(add_method, <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">           <span class="comment">//h不论是什么参数都返回123</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">       &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]));</span><br><span class="line">       <span class="comment">//再次调用 则返回123</span></span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&quot;result:&quot;</span>,add_method(<span class="number">1</span>,<span class="number">2</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="so-层方法注册到-js-中-主动调用"><a href="#so-层方法注册到-js-中-主动调用" class="headerlink" title="so 层方法注册到 js 中, 主动调用"></a>so 层方法注册到 js 中, 主动调用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new NativeFunction(address, returnType, argTypes[, options])</span><br></pre></td></tr></table></figure><ul><li><code>address</code> : 函数地址</li><li><code>returnType</code> : 指定返回类型</li><li><code>argTypes</code> : 数组指定参数类型</li><li>类型可选: void, pointer, int, uint, long, ulong, char, uchar, float, double, int8, uint8, int16, int32, uint32, int64, uint64; 参照函数所需的 type 来定义即可;</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invoke_native_func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> baseAddr = Module.findBaseAddress(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;baseAddr&quot;</span>, baseAddr);</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x0000A28C</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> add_c_addr = baseAddr.add(offset);</span><br><span class="line">    <span class="keyword">var</span> add_c_func = <span class="keyword">new</span> NativeFunction(add_c_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>,<span class="string">&quot;int&quot;</span>]);</span><br><span class="line">    <span class="keyword">var</span> result = add_c_func(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-libart-中的-jni-方法"><a href="#hook-libart-中的-jni-方法" class="headerlink" title="hook libart 中的 jni 方法"></a>hook libart 中的 jni 方法</h1><p><code>jni</code> 全部定在在 <code>/system/lib(64)/libart.so</code> 文件中, 通过枚举 <code>symbols</code> 筛选出指定的方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_libart</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> GetStringUTFChars_addr = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jni 系统函数都在 libart.so 中</span></span><br><span class="line">    <span class="keyword">var</span> module_libart = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> symbols = module_libart.enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = symbols[i].name;</span><br><span class="line">        <span class="keyword">if</span> ((name.indexOf(<span class="string">&quot;JNI&quot;</span>) &gt;= <span class="number">0</span>) </span><br><span class="line">&amp;&amp; (name.indexOf(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span>) </span><br><span class="line">&amp;&amp; (name.indexOf(<span class="string">&quot;art&quot;</span>) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;GetStringUTFChars&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(name);</span><br><span class="line">                <span class="comment">// 获取到指定 jni 方法地址</span></span><br><span class="line">                GetStringUTFChars_addr = symbols[i].address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Interceptor.attach(GetStringUTFChars_addr, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// console.log(&quot;args[0] is : &quot;, args[0]);</span></span><br><span class="line">                <span class="comment">// console.log(&quot;args[1] is : &quot;, args[1]);</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;native args[1] is :&quot;</span>,Java.vm.getEnv().getStringUtfChars(args[<span class="number">1</span>],<span class="literal">null</span>).readCString());</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;GetStringUTFChars onEnter called from:\n&#x27;</span> +</span><br><span class="line">                    Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.FUZZY)</span><br><span class="line">                    .map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">                <span class="comment">// console.log(&quot;native args[1] is :&quot;, Java.cast(args[1], Java.use(&quot;java.lang.String&quot;)));</span></span><br><span class="line">                <span class="comment">// console.log(&quot;native args[1] is :&quot;, Memory.readCString(Java.vm.getEnv().getStringUtfChars(args[1],null)));</span></span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// retval const char*</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;GetStringUTFChars onLeave : &quot;</span>, ptr(retval).readCString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-libc-中的系统方法"><a href="#hook-libc-中的系统方法" class="headerlink" title="hook libc 中的系统方法"></a>hook libc 中的系统方法</h1><p><code>/system/lib(64)/libc.so</code> 导出的符号没有进行 <code>namemanline</code> , 直接过滤筛选即可</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook libc.so</span></span><br><span class="line"><span class="keyword">var</span> pthread_create_addr = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log(JSON.stringify(Process.enumerateModules())); </span></span><br><span class="line"><span class="comment">// Process.enumerateModules() 枚举加载的so文件</span></span><br><span class="line"><span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">&quot;libc.so&quot;</span>).enumerateSymbols();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (symbols[i].name === <span class="string">&quot;pthread_create&quot;</span>)&#123;</span><br><span class="line">        <span class="comment">// console.log(&quot;symbols name is -&gt; &quot; + symbols[i].name);</span></span><br><span class="line">        <span class="comment">// console.log(&quot;symbols address is -&gt; &quot; + symbols[i].address);</span></span><br><span class="line">        pthread_create_addr = symbols[i].address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Interceptor.attach(pthread_create_addr,&#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;args is -&gt;&quot;</span> + args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>],args[<span class="number">3</span>]);</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(retval);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>libc.so</code> 中方法替换</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook 检测frida 的方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// var exports = Process.findModuleByName(&quot;libnative-lib.so&quot;).enumerateExports(); 导出</span></span><br><span class="line">    <span class="comment">// var imports = Process.findModuleByName(&quot;libnative-lib.so&quot;).enumerateImports(); 导入</span></span><br><span class="line">    <span class="comment">// var symbols = Process.findModuleByName(&quot;libnative-lib.so&quot;).enumerateSymbols(); 符号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = Process.getModuleByName(<span class="string">&quot;libc.so&quot;</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.name === <span class="string">&quot;pthread_create&quot;</span>) &#123;</span><br><span class="line">            pthread_create_addr = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;pthread_create name is -&gt;&quot;</span>, symbol.name);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;pthread_create address is -&gt;&quot;</span>, pthread_create_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 定义方法 之后主动调用的时候使用</span></span><br><span class="line">        <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> NativeFunction(pthread_create_addr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">        Interceptor.replace(pthread_create_addr,<span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">a0, a1, a2, a3</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> detect_frida_loop = Module.findExportByName(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="string">&quot;_Z17detect_frida_loopPv&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;a0,a1,a2,a3 -&gt;&quot;</span>,a0,a1,a2,a3);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">String</span>(a2) === <span class="built_in">String</span>(detect_frida_loop)) &#123;</span><br><span class="line">                result = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;阻止frida反调试启动&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = pthread_create(a0,a1,a2,a3);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;正常启动&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>]));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-native-调用栈"><a href="#hook-native-调用栈" class="headerlink" title="hook native 调用栈"></a>hook native 调用栈</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(f, &#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;RegisterNatives called from:\n&#x27;</span> +</span><br><span class="line">        Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE)</span><br><span class="line">        .map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="jnitrace"><a href="#jnitrace" class="headerlink" title="jnitrace"></a>jnitrace</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>jnitrace</code>: <a href="https://github.com/chame1eon/jnitrace">https://github.com/chame1eon/jnitrace</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python&#96; : &#96;pip install jnitrace</span><br></pre></td></tr></table></figure><h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p><code>ndk</code> 开发是没有办法脱离 <code>[libc.so](http://libc.so)</code> 和 <code>[libart.so](http://libart.so)</code> 进行开发, 所以只要降维打击, 通过 <code>trace</code> 的方式就可以监控到 <code>so</code> 层</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-032605.jpg" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-032605.jpg"></p><h3 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace [options] -l libname packagename</span><br></pre></td></tr></table></figure><p>例如: <code>jnitrace -l [libnative-lib.so](http://libnative-lib.so) com.example.myapplication</code></p><h3 id="必要参数"><a href="#必要参数" class="headerlink" title="必要参数"></a><strong>必要参数</strong></h3><ul><li><code>-l libname</code> : 指定要<code>trace</code>的<code>.so</code>文件, 可以同时<code>trace</code>多个<code>.so</code>文件, 直接使用 <code>*</code>来<code>trace</code>所有的<code>.so</code>文件; 如: <code>-l libnative-lib.so -l libanother-lib.so</code> or <code>-l *</code></li><li><code>packagename</code> : 指定要<code>trace</code>的<code>package name</code></li></ul><h3 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a><strong>可选参数</strong></h3><ul><li><code>-m</code>: 指定是<code>spawn</code>还是<code>attach</code></li><li><code>-b</code>: 指定是<code>fuzzy</code>还是<code>accurate</code></li><li><code>-i &lt;regex&gt;</code>: 指定一个正则表达式来过滤出方法名, 例如: <code>-i Get -i RegisterNatives</code> 就只会打印出名字里包含<code>Get</code>或者<code>RegisterNatives</code>的<code>JNI methods</code></li><li><code>-e &lt;regex&gt;</code>和<code>i</code>相反，同样通过正则表达式来过滤，但这次会将指定的内容忽略掉</li><li><code>-I &lt;string&gt;</code>trace导出的方法，jnitrace认为导出的函数应该是从Java端能够直接调用的函数，所以可以包括使用RegisterNatives来注册的函数，例如<code>I stringFromJNI -I nativeMethod([B)V</code>，就包括导出名里有stringFromJNI，以及使用RegisterNames来注册，并带有nativeMethod([B)V签名的函数。</li><li><code>-o path/output.json</code>，导出输出到文件里。</li><li><code>-p path/to/script.js</code>，用于在加载jnitrace脚本之前将指定路径的Frida脚本加载到目标进程中，这可以用于在jnitrace启动之前对抗反调试。</li><li><code>-a path/to/script.js</code>，用于在加载jnitrace脚本之后将指定路径的Frida脚本加载到目标进程中</li><li><code>-ignore-env</code>，不打印所有的JNIEnv函数</li><li><code>-ignore-vm</code>，不打印所有的JavaVM函数</li></ul><h3 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h3><p>默认使用 <code>spawn</code> 启动, 可以通过 <code>-m attach</code> 设置通过 <code>attach</code> 启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -m attach -l[libnative-lib.so](http:&#x2F;&#x2F;libnative-lib.so) com.kevin.demoso1</span><br></pre></td></tr></table></figure><h3 id="设置回溯器"><a href="#设置回溯器" class="headerlink" title="设置回溯器"></a>设置回溯器</h3><p>默认情况下使用 <code>accurate</code>的精确模式来进行回溯, 可以通过 <code>-b fuzzy</code> 修改为模糊模式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -l [libnative-lib.so](http:&#x2F;&#x2F;libnative-lib.so) -b fuzzy com.kevin.demoso1</span><br></pre></td></tr></table></figure><h3 id="监控指定规则的方法"><a href="#监控指定规则的方法" class="headerlink" title="监控指定规则的方法"></a>监控指定规则的方法</h3><p>用于指定应该跟踪的方法名, 该选项可以多次提供;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -l libnative-lib.so -i RegisterNatives com.kevin.demoso1</span><br></pre></td></tr></table></figure><p>只过滤出<code>RegisterNatives</code>相关的内容</p><h3 id="忽略指定规则的方法"><a href="#忽略指定规则的方法" class="headerlink" title="忽略指定规则的方法"></a><strong>忽略指定规则的方法</strong></h3><p>用于指定在跟踪中应被忽略的方法名, 这个选项可以被多次提供;</p><p>忽略以<code>Find</code>开头的所有方法;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -l libnative-lib.so -e ^Find com.kevin.demoso</span><br></pre></td></tr></table></figure><h2 id="jnitace-计算偏移地址"><a href="#jnitace-计算偏移地址" class="headerlink" title="jnitace 计算偏移地址"></a>jnitace 计算偏移地址</h2><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-062032.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-062032.png"></p><p><code>0x8e4f3b1</code> 是方法 <code>initSN</code> 方法的绝对地址</p><p><code>0xd8e4e000</code> 是 <code>[libmyjni.so](http://libmyjni.so)</code> 基地址</p><p>使用使用 <code>initSN()V</code>的绝对地址 <code>0xd8e4f3b1</code> 减去 <code>[libmyjni.so](http://libmyjni.so)</code> 的基地址 <code>0xd8e4e000</code> , 得到偏移 <code>0x13B1</code></p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-070337.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-07-070337.png"></p><p><code>g</code> 进行跳转到 <code>0x13B1</code> 即可进入方法</p><h1 id="frida-trace"><a href="#frida-trace" class="headerlink" title="frida trace"></a>frida trace</h1><p>文档地址: <a href="https://frida.re/docs/frida-trace/">https://frida.re/docs/frida-trace/</a></p><h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Usage: frida-trace [options] target</span><br><span class="line"></span><br><span class="line"> Options:</span><br><span class="line">   --version             show program<span class="string">&#x27;s version number and exit</span></span><br><span class="line"><span class="string">   -h, --help            show this help message and exit</span></span><br><span class="line"><span class="string">   -D ID, --device=ID    connect to device with the given ID</span></span><br><span class="line"><span class="string">   -U, --usb             connect to USB device</span></span><br><span class="line"><span class="string">   -R, --remote          connect to remote frida-server</span></span><br><span class="line"><span class="string">   -H HOST, --host=HOST  connect to remote frida-server on HOST</span></span><br><span class="line"><span class="string">   -f FILE, --file=FILE  spawn FILE</span></span><br><span class="line"><span class="string">   -F, --attach-frontmost     attach to frontmost application</span></span><br><span class="line"><span class="string">   -n NAME, --attach-name=NAME     attach to NAME</span></span><br><span class="line"><span class="string">   -p PID, --attach-pid=PID     attach to PID</span></span><br><span class="line"><span class="string">   --stdio=inherit|pipe      stdio behavior when spawning (defaults to “inherit”)</span></span><br><span class="line"><span class="string">   --runtime=duk|v8          script runtime to use (defaults to “duk”)</span></span><br><span class="line"><span class="string">   --debug                   enable the Node.js compatible script debugger</span></span><br><span class="line"><span class="string">   -I MODULE, --include-module=MODULE       include MODULE</span></span><br><span class="line"><span class="string">   -X MODULE, --exclude-module=MODULE       exclude MODULE</span></span><br><span class="line"><span class="string">   -i FUNCTION, --include=FUNCTION    include FUNCTION</span></span><br><span class="line"><span class="string">   -x FUNCTION, --exclude=FUNCTION   exclude FUNCTION</span></span><br><span class="line"><span class="string">   -a MODULE!OFFSET, --add=MODULE!OFFSET    add MODULE!OFFSET</span></span><br><span class="line"><span class="string">   -T, --include-imports    include program&#x27;</span>s imports</span><br><span class="line">   -t MODULE, --include-<span class="built_in">module</span>-imports=MODULE      include MODULE imports</span><br><span class="line">   -m OBJC_METHOD, --include-objc-method=OBJC_METHOD    include OBJC_METHOD</span><br><span class="line">   -M OBJC_METHOD, --exclude-objc-method=OBJC_METHOD    exclude OBJC_METHOD</span><br><span class="line">   -s DEBUG_SYMBOL, --include-debug-symbol=DEBUG_SYMBOL    include DEBUG_SYMBOL</span><br><span class="line">   -q, --quiet           <span class="keyword">do</span> not format output messages</span><br><span class="line">   -d, --decorate        Add <span class="built_in">module</span> name to generated onEnter log statement</span><br><span class="line">   -o OUTPUT, --output=OUTPUT    dump messages to file</span><br></pre></td></tr></table></figure><h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace [options] packagename</span><br></pre></td></tr></table></figure><h3 id="启动模式"><a href="#启动模式" class="headerlink" title="启动模式"></a>启动模式</h3><p>默认使用 <code>attach</code> 模式, 可以指定 <code>-f packageName</code> 使用 <code>spawn</code> 模式启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -i strcmp -f com.gdufs.xman</span><br></pre></td></tr></table></figure><h3 id="文件输出"><a href="#文件输出" class="headerlink" title="文件输出"></a>文件输出</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -i &quot;strcmp&quot; -f com.gdufs.xman -o xman.json</span><br></pre></td></tr></table></figure><p><code>-o filepath</code> 指定输出的文件路径, 方便内容过多时进行查看</p><h3 id="trace-任意-function"><a href="#trace-任意-function" class="headerlink" title="trace 任意 function"></a>trace 任意 function</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -i &quot;strcmp&quot; com.example.demoso1</span><br></pre></td></tr></table></figure><h3 id="trace-任意-module"><a href="#trace-任意-module" class="headerlink" title="trace 任意 module"></a>trace 任意 module</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -I &quot;libnative-lib.so&quot; com.example.demoso1</span><br></pre></td></tr></table></figure><h3 id="根据地址进行-trace"><a href="#根据地址进行-trace" class="headerlink" title="根据地址进行 trace"></a>根据地址进行 trace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -a &quot;libnative-lib.so!0x9281&quot; com.example.demoso1</span><br></pre></td></tr></table></figure><h1 id="frida-hook-libart"><a href="#frida-hook-libart" class="headerlink" title="frida-hook-libart"></a>frida-hook-libart</h1><p>下载地址: <a href="https://github.com/lasting-yang/frida_hook_libart">https://github.com/lasting-yang/frida_hook_libart</a></p><h2 id="hook-art"><a href="#hook-art" class="headerlink" title="hook art"></a>hook art</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U --no-pause -f package_name -l hook_art.js</span><br></pre></td></tr></table></figure><h2 id="hook-RegisterNatives"><a href="#hook-RegisterNatives" class="headerlink" title="hook_RegisterNatives"></a>hook_RegisterNatives</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U --no-pause -f package_name -l hook_RegisterNatives.js</span><br></pre></td></tr></table></figure><h2 id="hook-artmethod"><a href="#hook-artmethod" class="headerlink" title="hook_artmethod"></a>hook_artmethod</h2><h3 id="init-libext-first-time"><a href="#init-libext-first-time" class="headerlink" title="init libext first time"></a>init libext first time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">adb push lib/libext64.so /data/<span class="built_in">local</span>/tmp/libext64.so</span><br><span class="line">adb push lib/libext.so /data/<span class="built_in">local</span>/tmp/libext.so</span><br><span class="line">adb shell su -c <span class="string">&quot;cp /data/local/tmp/libext64.so /data/app/libext64.so&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;cp /data/local/tmp/libext.so /data/app/libext.so&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;chown 1000.1000 /data/app/libext*.so&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;chmod 777 /data/app/libext*.so&quot;</span></span><br><span class="line">adb shell su -c <span class="string">&quot;ls -al /data/app/libext*&quot;</span></span><br></pre></td></tr></table></figure><h3 id="use-hook-artmethod-js"><a href="#use-hook-artmethod-js" class="headerlink" title="use hook_artmethod.js"></a>use hook_artmethod.js</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frida -U --no-pause -f package_name -l hook_artmethod.js</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">frida -U --no-pause -f package_name -l hook_artmethod.js &gt; hook_artmethod.log</span><br></pre></td></tr></table></figure><h1 id="frida-文件写入-frida-hook-libc"><a href="#frida-文件写入-frida-hook-libc" class="headerlink" title="frida 文件写入(frida/hook libc)"></a>frida 文件写入(frida/hook libc)</h1><p><code>frida api</code> 写入文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeFile</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> file = <span class="keyword">new</span> File(<span class="string">&quot;/sdcard/reg.dat&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">file.write(<span class="string">&quot;content from frida&quot;</span>);</span><br><span class="line">file.flush();</span><br><span class="line">file.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>frida 定义 NativeFunction</code> 写入文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeFileNative</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> addr_fopen = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> addr_fputs = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> addr_fclose = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 libc 的系统方法注册到 js 层</span></span><br><span class="line"><span class="keyword">var</span> fopen = <span class="keyword">new</span> NativeFunction(addr_fopen, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fputs = <span class="keyword">new</span> NativeFunction(addr_fputs, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fclose = <span class="keyword">new</span> NativeFunction(addr_fclose, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 js 层主动调用 libc 的方法</span></span><br><span class="line"><span class="comment">// 不能直接将 js 的字符串传给 libc中的方法, 需要进行转换</span></span><br><span class="line"><span class="keyword">var</span> filename = Memory.allocUtf8String(<span class="string">&quot;/sdcard/reg.dat&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> open_mode = Memory.allocUtf8String(<span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> file = fopen(filename, open_mode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = Memory.allocUtf8String(<span class="string">&quot;content from frida&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> result = fputs(buffer, file);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;fputs ret: &quot;</span>, result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭文件</span></span><br><span class="line">fclose(file);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-读写-std-string"><a href="#hook-读写-std-string" class="headerlink" title="hook 读写 std::string"></a>hook 读写 std::string</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readStdString</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isTiny = (str.readU8 &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (isTiny)&#123;</span><br><span class="line">    <span class="keyword">return</span> str.add(<span class="number">1</span>).readUtf8String();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str.add(<span class="number">2</span> * Process.pointerSize).readPointer().readUtf8String();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeStdString</span>(<span class="params">str, content</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isTiny = (str.readU8() &amp; <span class="number">1</span>) === <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (isTiny)&#123;</span><br><span class="line">    str.add(<span class="number">1</span>).writeUtf8String(content);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    str.add(<span class="number">2</span> * Process.pointerSize).readPointer().writeUtf8String(content);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-so-文件加载后马上-hook"><a href="#hook-so-文件加载后马上-hook" class="headerlink" title="hook so 文件加载后马上 hook"></a>hook so 文件加载后马上 hook</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种方式（针对较老的系统版本）</span></span><br><span class="line"><span class="keyword">var</span> dlopen = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(dlopen);</span><br><span class="line"><span class="keyword">if</span>(dlopen != <span class="literal">null</span>)&#123;</span><br><span class="line">    Interceptor.attach(dlopen,&#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> soName = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="built_in">console</span>.log(soName);</span><br><span class="line">            <span class="keyword">if</span>(soName.indexOf(<span class="string">&quot;libc.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">this</span>.hook) &#123; </span><br><span class="line">                dlopentodo();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种方式（针对新系统版本）</span></span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(android_dlopen_ext);</span><br><span class="line"><span class="keyword">if</span>(android_dlopen_ext != <span class="literal">null</span>)&#123;</span><br><span class="line">    Interceptor.attach(android_dlopen_ext,&#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> soName = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="built_in">console</span>.log(soName);</span><br><span class="line">            <span class="keyword">if</span>(soName.indexOf(<span class="string">&quot;libc.so&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">this</span>.hook) &#123;</span><br><span class="line">                dlopentodo();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dlopentodo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//todo ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-libc-kill"><a href="#hook-libc-kill" class="headerlink" title="hook libc kill"></a>hook libc kill</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceKILL</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> kill_addr = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;kill&quot;</span>);</span><br><span class="line">Interceptor.replace(kill_addr, <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">arg0, arg1</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arg0=&gt; &quot;</span>, arg0);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arg1=&gt; &quot;</span>, arg1);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;libc.so!kill called from:\n&#x27;</span> +</span><br><span class="line">        Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE)</span><br><span class="line">        .map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;,<span class="string">&quot;int&quot;</span>,[<span class="string">&quot;int&quot;</span>,<span class="string">&quot;int&quot;</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="hook-init-array"><a href="#hook-init-array" class="headerlink" title="hook init_array"></a>hook init_array</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//应用以32位在64位终端环境下运行</span></span><br><span class="line"><span class="comment">//adb install --abi armeabi-v7a &lt;path to apk&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_call_function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = Process.getModuleByName(<span class="string">&quot;linker&quot;</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; symbols.length; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (symbols[m].name == <span class="string">&quot;__dl__ZL13call_functionPKcPFviPPcS2_ES0_&quot;</span>) &#123;</span><br><span class="line">            call_function_addr = symbols[m].address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;found call_function_addr =&gt; &quot;</span>, call_function_addr)</span><br><span class="line">            hook_call_function(call_function_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_call_function</span>(<span class="params">_call_function_addr</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;hook call function begin!hooking address :=&gt;&quot;</span>,_call_function_addr)</span><br><span class="line">    Interceptor.attach(_call_function_addr,&#123;</span><br><span class="line">        onEnter:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(args[<span class="number">2</span>].readCString().indexOf(<span class="string">&quot;base.odex&quot;</span>)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;============================&quot;</span>)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;function_name =&gt;&quot;</span>,args[<span class="number">0</span>].readCString())</span><br><span class="line">                <span class="keyword">var</span> soPath = args[<span class="number">2</span>].readCString()</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;so path : =&gt;&quot;</span>,soPath)</span><br><span class="line">                <span class="keyword">var</span> soName = soPath.split(<span class="string">&quot;/&quot;</span>).pop();</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;function offset =&gt;&quot;</span>,<span class="string">&quot;0x&quot;</span>+(args[<span class="number">1</span>]-Module.findBaseAddress(soName)).toString(<span class="number">16</span>))</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;============================&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(get_call_function)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_constructor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Process.pointerSize == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> linker = Process.findModuleByName(<span class="string">&quot;linker&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> linker = Process.findModuleByName(<span class="string">&quot;linker64&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addr_call_function =<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addr_g_ld_debug_verbosity = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addr_async_safe_format_log = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (linker) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbols = linker.enumerateSymbols();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> name = symbols[i].name;</span><br><span class="line">            <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;call_function&quot;</span>) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                addr_call_function = symbols[i].address;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(name.indexOf(<span class="string">&quot;g_ld_debug_verbosity&quot;</span>) &gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                addr_g_ld_debug_verbosity = symbols[i].address;</span><br><span class="line">              </span><br><span class="line">                ptr(addr_g_ld_debug_verbosity).writeInt(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(name.indexOf(<span class="string">&quot;async_safe_format_log&quot;</span>) &gt;=<span class="number">0</span> &amp;&amp; name.indexOf(<span class="string">&#x27;va_list&#x27;</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            </span><br><span class="line">                addr_async_safe_format_log = symbols[i].address;</span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(addr_async_safe_format_log)&#123;</span><br><span class="line">        Interceptor.attach(addr_async_safe_format_log,&#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.log_level  = args[<span class="number">0</span>];</span><br><span class="line">                <span class="built_in">this</span>.tag = ptr(args[<span class="number">1</span>]).readCString()</span><br><span class="line">                <span class="built_in">this</span>.fmt = ptr(args[<span class="number">2</span>]).readCString()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">this</span>.fmt.indexOf(<span class="string">&quot;c-tor&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; <span class="built_in">this</span>.fmt.indexOf(<span class="string">&#x27;Done&#x27;</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">this</span>.function_type = ptr(args[<span class="number">3</span>]).readCString(), <span class="comment">// func_type</span></span><br><span class="line">                    <span class="built_in">this</span>.so_path = ptr(args[<span class="number">5</span>]).readCString();</span><br><span class="line">                    <span class="keyword">var</span> strs = <span class="keyword">new</span> <span class="built_in">Array</span>(); <span class="comment">//定义一数组 </span></span><br><span class="line">                    strs = <span class="built_in">this</span>.so_path.split(<span class="string">&quot;/&quot;</span>); <span class="comment">//字符分割</span></span><br><span class="line">                    <span class="built_in">this</span>.so_name = strs.pop();</span><br><span class="line">                    <span class="built_in">this</span>.func_offset  = ptr(args[<span class="number">4</span>]).sub(Module.findBaseAddress(<span class="built_in">this</span>.so_name)) </span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">&quot;func_type:&quot;</span>, <span class="built_in">this</span>.function_type,</span><br><span class="line">                        <span class="string">&#x27;\nso_name:&#x27;</span>,<span class="built_in">this</span>.so_name,</span><br><span class="line">                        <span class="string">&#x27;\nso_path:&#x27;</span>,<span class="built_in">this</span>.so_path,</span><br><span class="line">                        <span class="string">&#x27;\nfunc_offset:&#x27;</span>,<span class="built_in">this</span>.func_offset </span><br><span class="line">                     );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hook_constructor();</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="frida-dump"><a href="#frida-dump" class="headerlink" title="frida dump"></a>frida dump</h1><p>document: <a href="https://github.com/lasting-yang/frida_dump">https://github.com/lasting-yang/frida_dump</a></p><h2 id="frida-dump-so"><a href="#frida-dump-so" class="headerlink" title="frida dump so"></a>frida dump so</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump_so</span>(<span class="params">so_name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&quot;android.app.ActivityThread&quot;</span>).currentApplication();</span><br><span class="line">        <span class="keyword">var</span> dir = currentApplication.getApplicationContext().getFilesDir().getPath();</span><br><span class="line">        <span class="keyword">var</span> libso = Process.getModuleByName(so_name);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[name]:&quot;</span>, libso.name);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[base]:&quot;</span>, libso.base);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[size]:&quot;</span>, ptr(libso.size));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[path]:&quot;</span>, libso.path);</span><br><span class="line">        <span class="keyword">var</span> file_path = dir + <span class="string">&quot;/&quot;</span> + libso.name + <span class="string">&quot;_&quot;</span> + libso.base + <span class="string">&quot;_&quot;</span> + ptr(libso.size) + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> file_handle = <span class="keyword">new</span> File(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">            Memory.protect(ptr(libso.base), libso.size, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> libso_buffer = ptr(libso.base).readByteArray(libso.size);</span><br><span class="line">            file_handle.write(libso_buffer);</span><br><span class="line">            file_handle.flush();</span><br><span class="line">            file_handle.close();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[dump]:&quot;</span>, file_path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="frida-dump-dex"><a href="#frida-dump-dex" class="headerlink" title="frida dump dex"></a>frida dump dex</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_self_process_name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> NativeFunction(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> readPtr = Module.getExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read = <span class="keyword">new</span> NativeFunction(readPtr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> closePtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;close&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> close = <span class="keyword">new</span> NativeFunction(closePtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> path = Memory.allocUtf8String(<span class="string">&quot;/proc/self/cmdline&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fd = open(path, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = Memory.alloc(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = read(fd, buffer, <span class="number">0x1000</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        result = ptr(buffer).readCString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mkdir</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> mkdirPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;mkdir&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> mkdir = <span class="keyword">new</span> NativeFunction(mkdirPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> opendirPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;opendir&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> opendir = <span class="keyword">new</span> NativeFunction(opendirPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> closedirPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;closedir&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> closedir = <span class="keyword">new</span> NativeFunction(closedirPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cPath = Memory.allocUtf8String(path);</span><br><span class="line">    <span class="keyword">var</span> dir = opendir(cPath);</span><br><span class="line">    <span class="keyword">if</span> (dir != <span class="number">0</span>) &#123;</span><br><span class="line">        closedir(dir);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mkdir(cPath, <span class="number">755</span>);</span><br><span class="line">    chmod(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chmod</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chmodPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;chmod&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> chmod = <span class="keyword">new</span> NativeFunction(chmodPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line">    <span class="keyword">var</span> cPath = Memory.allocUtf8String(path);</span><br><span class="line">    chmod(cPath, <span class="number">755</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump_dex</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libart = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_DefineClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = libart.enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; symbols.length; index++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[index];</span><br><span class="line">        <span class="keyword">var</span> symbol_name = symbol.name;</span><br><span class="line">        <span class="comment">//这个DefineClass的函数签名是Android9的</span></span><br><span class="line">        <span class="comment">//_ZN3art11ClassLinker11DefineClassEPNS_6ThreadEPKcmNS_6HandleINS_6mirror11ClassLoaderEEERKNS_7DexFileERKNS9_8ClassDefE</span></span><br><span class="line">        <span class="keyword">if</span> (symbol_name.indexOf(<span class="string">&quot;ClassLinker&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;DefineClass&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;Thread&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;DexFile&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(symbol_name, symbol.address);</span><br><span class="line">            addr_DefineClass = symbol.address;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dex_maps = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> dex_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[DefineClass:]&quot;</span>, addr_DefineClass);</span><br><span class="line">    <span class="keyword">if</span> (addr_DefineClass) &#123;</span><br><span class="line">        Interceptor.attach(addr_DefineClass, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> dex_file = args[<span class="number">5</span>];</span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize) is &quot;const uint8_t* const begin_;&quot;</span></span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize + Process.pointerSize) is &quot;const size_t size_;&quot;</span></span><br><span class="line">                <span class="keyword">var</span> base = ptr(dex_file).add(Process.pointerSize).readPointer();</span><br><span class="line">                <span class="keyword">var</span> size = ptr(dex_file).add(Process.pointerSize + Process.pointerSize).readUInt();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dex_maps[base] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    dex_maps[base] = size;</span><br><span class="line">                    <span class="keyword">var</span> magic = ptr(base).readCString();</span><br><span class="line">                    <span class="keyword">if</span> (magic.indexOf(<span class="string">&quot;dex&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> process_name = get_self_process_name();</span><br><span class="line">                        <span class="keyword">if</span> (process_name != <span class="string">&quot;-1&quot;</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> dex_dir_path = <span class="string">&quot;/data/data/&quot;</span> + process_name + <span class="string">&quot;/files/dump_dex_&quot;</span> + process_name;</span><br><span class="line">                            mkdir(dex_dir_path);</span><br><span class="line">                            <span class="keyword">var</span> dex_path = dex_dir_path + <span class="string">&quot;/class&quot;</span> + (dex_count == <span class="number">1</span> ? <span class="string">&quot;&quot;</span> : dex_count) + <span class="string">&quot;.dex&quot;</span>;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;[find dex]:&quot;</span>, dex_path);</span><br><span class="line">                            <span class="keyword">var</span> fd = <span class="keyword">new</span> File(dex_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (fd &amp;&amp; fd != <span class="literal">null</span>) &#123;</span><br><span class="line">                                dex_count++;</span><br><span class="line">                                <span class="keyword">var</span> dex_buffer = ptr(base).readByteArray(size);</span><br><span class="line">                                fd.write(dex_buffer);</span><br><span class="line">                                fd.flush();</span><br><span class="line">                                fd.close();</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">&quot;[dump dex]:&quot;</span>, dex_path);</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> is_hook_libart = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_dlopen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = ptr(pathptr).readCString();</span><br><span class="line">                <span class="comment">//console.log(&quot;dlopen:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.indexOf(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.can_hook_libart = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[dlopen:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.can_hook_libart &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                dump_dex();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = ptr(pathptr).readCString();</span><br><span class="line">                <span class="comment">//console.log(&quot;android_dlopen_ext:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.indexOf(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.can_hook_libart = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[android_dlopen_ext:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.can_hook_libart &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                dump_dex();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setImmediate(dump_dex);</span><br></pre></td></tr></table></figure><h2 id="frida-dump-dex-class"><a href="#frida-dump-dex-class" class="headerlink" title="frida dump dex class"></a>frida dump dex class</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_self_process_name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> NativeFunction(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> readPtr = Module.getExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read = <span class="keyword">new</span> NativeFunction(readPtr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> closePtr = Module.getExportByName(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;close&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> close = <span class="keyword">new</span> NativeFunction(closePtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> path = Memory.allocUtf8String(<span class="string">&quot;/proc/self/cmdline&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fd = open(path, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = Memory.alloc(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = read(fd, buffer, <span class="number">0x1000</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        result = ptr(buffer).readCString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">load_all_class</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Java.available) &#123;</span><br><span class="line">        Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> DexFileclass = Java.use(<span class="string">&quot;dalvik.system.DexFile&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> BaseDexClassLoaderclass = Java.use(<span class="string">&quot;dalvik.system.BaseDexClassLoader&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> DexPathListclass = Java.use(<span class="string">&quot;dalvik.system.DexPathList&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Java.enumerateClassLoaders(&#123;</span><br><span class="line">                onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">loader</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">var</span> basedexclassloaderobj = Java.cast(loader, BaseDexClassLoaderclass);</span><br><span class="line">                        <span class="keyword">var</span> pathList = basedexclassloaderobj.pathList.value;</span><br><span class="line">                        <span class="keyword">var</span> pathListobj = Java.cast(pathList, DexPathListclass)</span><br><span class="line">                        <span class="keyword">var</span> dexElements = pathListobj.dexElements.value;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> dexElements) &#123;</span><br><span class="line">                            <span class="keyword">var</span> element = dexElements[index];</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">var</span> dexfile = element.dexFile.value;</span><br><span class="line">                                <span class="keyword">var</span> dexfileobj = Java.cast(dexfile, DexFileclass);</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">&quot;dexFile:&quot;</span>, dexfileobj);</span><br><span class="line">                                <span class="keyword">const</span> classNames = [];</span><br><span class="line">                                <span class="keyword">const</span> enumeratorClassNames = dexfileobj.entries();</span><br><span class="line">                                <span class="keyword">while</span> (enumeratorClassNames.hasMoreElements()) &#123;</span><br><span class="line">                                    <span class="keyword">var</span> className = enumeratorClassNames.nextElement().toString();</span><br><span class="line">                                    classNames.push(className);</span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        loader.loadClass(className);</span><br><span class="line">                                    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                                        <span class="built_in">console</span>.log(<span class="string">&quot;loadClass error:&quot;</span>, error);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">&quot;dexfile error:&quot;</span>, error);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">&quot;loader error:&quot;</span>, error);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;load_all_class end.&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dex_maps = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_dex_maps</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> dex <span class="keyword">in</span> dex_maps) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(dex, dex_maps[dex]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump_dex</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    load_all_class();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> base <span class="keyword">in</span> dex_maps) &#123;</span><br><span class="line">        <span class="keyword">var</span> size = dex_maps[base];</span><br><span class="line">        <span class="built_in">console</span>.log(base);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> magic = ptr(base).readCString();</span><br><span class="line">        <span class="keyword">if</span> (magic.indexOf(<span class="string">&quot;dex&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> process_name = get_self_process_name();</span><br><span class="line">            <span class="keyword">if</span> (process_name != <span class="string">&quot;-1&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> dex_path = <span class="string">&quot;/data/data/&quot;</span> + process_name + <span class="string">&quot;/files/&quot;</span> + base.toString(<span class="number">16</span>) + <span class="string">&quot;_&quot;</span> + size.toString(<span class="number">16</span>) + <span class="string">&quot;.dex&quot;</span>;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[find dex]:&quot;</span>, dex_path);</span><br><span class="line">                <span class="keyword">var</span> fd = <span class="keyword">new</span> File(dex_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (fd &amp;&amp; fd != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> dex_buffer = ptr(base).readByteArray(size);</span><br><span class="line">                    fd.write(dex_buffer);</span><br><span class="line">                    fd.flush();</span><br><span class="line">                    fd.close();</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[dump dex]:&quot;</span>, dex_path);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_dex</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libart = Process.findModuleByName(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_DefineClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = libart.enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; symbols.length; index++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[index];</span><br><span class="line">        <span class="keyword">var</span> symbol_name = symbol.name;</span><br><span class="line">        <span class="comment">//这个DefineClass的函数签名是Android9的</span></span><br><span class="line">        <span class="comment">//_ZN3art11ClassLinker11DefineClassEPNS_6ThreadEPKcmNS_6HandleINS_6mirror11ClassLoaderEEERKNS_7DexFileERKNS9_8ClassDefE</span></span><br><span class="line">        <span class="keyword">if</span> (symbol_name.indexOf(<span class="string">&quot;ClassLinker&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;DefineClass&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;Thread&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            symbol_name.indexOf(<span class="string">&quot;DexFile&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(symbol_name, symbol.address);</span><br><span class="line">            addr_DefineClass = symbol.address;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[DefineClass:]&quot;</span>, addr_DefineClass);</span><br><span class="line">    <span class="keyword">if</span> (addr_DefineClass) &#123;</span><br><span class="line">        Interceptor.attach(addr_DefineClass, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> dex_file = args[<span class="number">5</span>];</span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize) is &quot;const uint8_t* const begin_;&quot;</span></span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize + Process.pointerSize) is &quot;const size_t size_;&quot;</span></span><br><span class="line">                <span class="keyword">var</span> base = ptr(dex_file).add(Process.pointerSize).readPointer();</span><br><span class="line">                <span class="keyword">var</span> size = ptr(dex_file).add(Process.pointerSize + Process.pointerSize).readUInt();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dex_maps[base] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    dex_maps[base] = size;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;hook_dex:&quot;</span>, base, size);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> is_hook_libart = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_dlopen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = ptr(pathptr).readCString();</span><br><span class="line">                <span class="comment">//console.log(&quot;dlopen:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.indexOf(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.can_hook_libart = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[dlopen:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.can_hook_libart &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                hook_dex();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = ptr(pathptr).readCString();</span><br><span class="line">                <span class="comment">//console.log(&quot;android_dlopen_ext:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.indexOf(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.can_hook_libart = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[android_dlopen_ext:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.can_hook_libart &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                hook_dex();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setImmediate(hook_dex);</span><br></pre></td></tr></table></figure><h1 id="指针运算符和读写-API"><a href="#指针运算符和读写-API" class="headerlink" title="指针运算符和读写 API"></a>指针运算符和读写 API</h1><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-01-052956.jpg" alt="img"><br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-01-053441.jpg" alt="img"></p><h2 id="hook-so-readPointer"><a href="#hook-so-readPointer" class="headerlink" title="hook so readPointer()"></a>hook so readPointer()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> libc_addr = Process.findModuleByName(<span class="string">&quot;libc.so&quot;</span>).base;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;libc address is &quot;</span> + libc_addr);</span><br><span class="line">        <span class="comment">// 0x10 转为十进制为 16, 读取</span></span><br><span class="line">        <span class="built_in">console</span>.log(libc_addr.readByteArray(<span class="number">0x10</span>));</span><br><span class="line">        <span class="comment">// readPointer(), 从此内存位置读取 NativePointer</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;pointer size&quot;</span>, Process.pointerSize);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;readPointer() is &quot;</span> + libc_addr.readPointer());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Memory.readPointer()&quot;</span> + Memory.readPointer(libc_addr.add(Process.pointerSize)));</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h2 id="hook-so-writePointer"><a href="#hook-so-writePointer" class="headerlink" title="hook so writePointer()"></a>hook so writePointer()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> libc_addr = Process.findModuleByName(<span class="string">&quot;libc.so&quot;</span>).base;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;libc_addr : &quot;</span> + libc_addr);</span><br><span class="line">        <span class="comment">// 分配四个字节的空间地址</span></span><br><span class="line">        <span class="keyword">const</span> r = Memory.alloc(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">// 将 libc_addr 指针写入刚申请的 r 中</span></span><br><span class="line">        r.writePointer(libc_addr);</span><br><span class="line">        <span class="comment">// 读取 r 指针的数据</span></span><br><span class="line">        <span class="keyword">var</span> buffer = Memory.readByteArray(r, <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(buffer);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//libc_addr : 0x7da7fdf000</span></span><br><span class="line">        <span class="comment">//    0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span></span><br><span class="line"><span class="comment">// 00000000  00 f0 fd a7                                      ....</span></span><br></pre></td></tr></table></figure><h2 id="hook-so-readS32-readU32"><a href="#hook-so-readS32-readU32" class="headerlink" title="hook so readS32(), readU32()"></a>hook so readS32(), readU32()</h2><p>从指定内存地址读取有符号或者无符号 8/16/21/etc 或浮点数/双精度值, 并将其作为数字返回;</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> libc_addr = Process.findModuleByName(<span class="string">&quot;libc.so&quot;</span>).base;</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(libc_addr));</span><br><span class="line">        <span class="built_in">console</span>.log(libc_addr.readS32(), (libc_addr.readS32()).toString(<span class="number">16</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(libc_addr.readU32(), (libc_addr.readU32()).toString(<span class="number">16</span>));</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-03-01-062734.png" alt="img"></p><h2 id="hook-so-writeS32-writeU32"><a href="#hook-so-writeS32-writeU32" class="headerlink" title="hook so writeS32(), writeU32()"></a>hook so writeS32(), writeU32()</h2><p>将有符号或无符号8/16/32/等或浮点数/双精度值写入此内存位置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 开辟四个字节的内存空间</span></span><br><span class="line">        <span class="keyword">const</span> r = Memory.alloc(<span class="number">4</span>);</span><br><span class="line">        r.writeS32(<span class="number">0x12345678</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(r.readByteArray(<span class="number">0x10</span>));</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&lt;!--  <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span> 7d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">98</span> c0 bb a8 7d <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  xV4.&#125;.......&#125;...</span><br><span class="line"> --&gt;</span><br></pre></td></tr></table></figure><h2 id="hook-so-readByteArray-writeByteArray"><a href="#hook-so-readByteArray-writeByteArray" class="headerlink" title="hook so readByteArray(), writeByteArray()"></a>hook so readByteArray(), writeByteArray()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 定义一个需要写入的字节数组</span></span><br><span class="line">        <span class="keyword">var</span> arr = [ <span class="number">0x72</span>, <span class="number">0x6F</span>, <span class="number">0x79</span>, <span class="number">0x73</span>, <span class="number">0x75</span>, <span class="number">0x65</span>];</span><br><span class="line">       <span class="comment">//这里申请以arr大小的内存空间</span></span><br><span class="line">        <span class="keyword">var</span> r = Memory.alloc(arr.length);</span><br><span class="line">        <span class="comment">// 将 arr 写入 r 中</span></span><br><span class="line">        r.writeByteArray(arr);</span><br><span class="line">        <span class="comment">// Memory.writeByteArray(r, arr); 同样可以写入</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;memory readbyteArray: &quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(r.readByteArray(arr.length));</span><br><span class="line">        <span class="built_in">console</span>.log(Memory.readByteArray(r, arr.length));</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h2 id="hook-so-readCString-writeUtf8String"><a href="#hook-so-readCString-writeUtf8String" class="headerlink" title="hook so readCString(), writeUtf8String()"></a>hook so readCString(), writeUtf8String()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 开辟内存空间 存有字符串</span></span><br><span class="line">        <span class="keyword">var</span> r = Memory.allocUtf8String(<span class="string">&quot;你好,世界&quot;</span>);</span><br><span class="line">        <span class="comment">// 读取内存中的字符串</span></span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(r));</span><br><span class="line">        <span class="built_in">console</span>.log(r.readCString());</span><br><span class="line">        <span class="comment">// 往内存中写入新的字符串</span></span><br><span class="line">        r.writeUtf8String(<span class="string">&quot;Hello,World&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(r));</span><br><span class="line">        <span class="built_in">console</span>.log(r.readCString())</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> frida </category>
          
      </categories>
      
      
        <tags>
            
            <tag> frida </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓NDK开发</title>
      <link href="ndk/"/>
      <url>ndk/</url>
      
        <content type="html"><![CDATA[<p>参考: <a href="https://developer.android.com/ndk/guides">https://developer.android.com/ndk/guides</a></p><h1 id="JNI-简述"><a href="#JNI-简述" class="headerlink" title="JNI 简述"></a>JNI 简述</h1><ul><li>JNI: Java Native Interface 的缩写, 通常翻译为 Java 本地接口;</li><li>从 Java1.1 开始, Java Native Interface 标准成为了 Java 平台的一部分, 它允许了 Java 代码和其他语言的代码进行交互; JNI 一开始是为了本地已编译的语言, 尤其是 C 和 C++设计的, 但是现在只要调用约定受支持的语言都可以使用;</li><li>JNI不是 Android 特有的, windowd, linux 等凡是有 JVM 的地方都支持 JNI; Android 的虚拟机 Dalvik/Art 都支持 JNI 标准; 通过 JNI, 就可以打通 Android 中 Java 世界和 Native 世界;</li></ul><h1 id="NDK-简述"><a href="#NDK-简述" class="headerlink" title="NDK 简述"></a>NDK 简述</h1><ul><li>NDK: Native Development Kit的缩写</li><li>NDK 是一系列工具的集合, 是一个开发套件, 帮助开发者快速开发以及调试 C/C++ 的动态库;</li><li>为了弥补 Java 容易被反编译的问题, 一些重要的逻辑和算法可以采用 C/C++ 甚至是汇编的形式编写, 再通过 NDK 的工具最终编译生成动态库, 再通过 JNI 来完成和 Dalvik/Art 虚拟机环境的 Java 代码的交互</li></ul><h1 id="ABI-和支持的指令集"><a href="#ABI-和支持的指令集" class="headerlink" title="ABI 和支持的指令集"></a>ABI 和支持的指令集</h1><p>使用 NDK 开发的 so 不再具有跨平台特性, 需要编译提供不同平台支持 ABI: Application Binary Interface</p><table><thead><tr><th>ABI</th><th>支持的指令集</th></tr></thead><tbody><tr><td>armeabi-v7a</td><td>armeabi, Thumb-2, VFPv3-D16</td></tr><tr><td>Arm64-v8a</td><td>AArch64</td></tr><tr><td>x86</td><td>x86, MMX, SSE/2/3, SSSE3</td></tr><tr><td>x86_64</td><td>x86, MMX, SSE/2/3, SSSE3, SSE4.1,SSE4.2,POPCNT</td></tr></tbody></table><h1 id="Java-反射"><a href="#Java-反射" class="headerlink" title="Java 反射"></a>Java 反射</h1><p>Java 反射定义:</p><ol><li>对于任意一个类, 都能够知道这个类的所有属性和方法</li><li>对于任意一个类的静态属性, 都能进行静态属性的获取和设置, 静态方法的调用</li><li>对于任意一个对象, 都能够进行对象的属性的获取和设置, 对象方法的调用</li></ol><h2 id="java-反射获取类"><a href="#java-反射获取类" class="headerlink" title="java 反射获取类"></a>java 反射获取类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 某个对象.class.getClassLoader().loadClass()</span></span><br><span class="line">Class TestClazz = MainActivity.class.getClassLoader().loadClass(<span class="string">&quot;com.kevin.reflection.Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Class.forName()</span></span><br><span class="line">Class TestClazz1 = Class.forName(<span class="string">&quot;com.kevin.reflection.Test&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="java-反射获取构造方法"><a href="#java-反射获取构造方法" class="headerlink" title="java 反射获取构造方法"></a>java 反射获取构造方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflection.Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 获取无参构造方法</span></span><br><span class="line">Constructor constructor = TestClazz.getConstructor(<span class="keyword">null</span>);</span><br><span class="line">Test obj = (Test) constructor.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 获取指定参数为 String 的构造方法</span></span><br><span class="line">Constructor constructor1 = TestClazz.getConstructor(String.class);</span><br><span class="line">Test obj1 = (Test) constructor1.newInstance(<span class="string">&quot;测试字符串&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 获取私有的构造方法</span></span><br><span class="line">Constructor constructor2 = TestClazz.getDeclaredConstructor(<span class="keyword">char</span>.class);</span><br><span class="line"><span class="comment">// 暴力反射, 忽略所有访问修饰符</span></span><br><span class="line">constructor2.setAccessible(<span class="keyword">true</span>); </span><br><span class="line">Test obj2 = (Test) constructor2.newInstance(<span class="string">&#x27;a&#x27;</span>);</span><br></pre></td></tr></table></figure><h2 id="java-反射获取静态属性"><a href="#java-反射获取静态属性" class="headerlink" title="java 反射获取静态属性"></a>java 反射获取静态属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 public static 静态属性</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflection.Test&quot;</span>);</span><br><span class="line">Field publicStaticField = TestClazz.getDeclaredField(<span class="string">&quot;publicStaticField&quot;</span>);</span><br><span class="line">String publicStaticFieldValue = publicStaticField.get(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 private static 静态属性</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflection.Test&quot;</span>);</span><br><span class="line">Field privateStaticField = TestClazz.getDecalredField(<span class="string">&quot;privateStaticField&quot;</span>);</span><br><span class="line">privateStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">String privateStaticFieldValue = privateStaticField.get(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h2 id="java-反射获取动态属性"><a href="#java-反射获取动态属性" class="headerlink" title="java 反射获取动态属性"></a>java 反射获取动态属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 public 动态属性</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>); </span><br><span class="line">Constructor constructor = TestClazz.getConstructor();</span><br><span class="line">Test obj1 = (Test) constructor.newInstance();</span><br><span class="line">Field publicNonStaticField = TestClazz.getDeclaredField(<span class="string">&quot;publicNonStaticField&quot;</span>);</span><br><span class="line">String publicNoneStaticFieldValue = publicNonStaticField.get(obj1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 private 动态属性</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>); </span><br><span class="line">Constructor constructor = TestClazz.getConstructor();</span><br><span class="line">Test obj1 = (Test) constructor.newInstance();</span><br><span class="line">Field privateNonStaticField = TestClazz.getDeclaredField(<span class="string">&quot;privateNonStaticField&quot;</span>);</span><br><span class="line">privateNoneStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">String privateNonStaticFieldValue = privateNonStaticField.get(obj1);</span><br></pre></td></tr></table></figure><h2 id="java-反射获取并调用方法"><a href="#java-反射获取并调用方法" class="headerlink" title="java 反射获取并调用方法"></a>java 反射获取并调用方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取并调用非静态方法</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>);</span><br><span class="line">Constructor constructor = TestClazz.getConstructor();</span><br><span class="line">Test obj = (Test) constructor.newInstance();</span><br><span class="line">Method method = TestClazz.getDeclaredMethod(<span class="string">&quot;privateNonStaticFunc&quot;</span>, String.class);</span><br><span class="line">method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">method.invoke(obj, <span class="string">&quot;string as arg&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取并调用静态方法</span></span><br><span class="line">Class TestClazz = Class.forName(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>);</span><br><span class="line">Method method = TestClazz.getDeclaredMethod(<span class="string">&quot;privateStaticFunc&quot;</span>);</span><br><span class="line">method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">method.invoke(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h2 id="java-反射案例"><a href="#java-反射案例" class="headerlink" title="java 反射案例"></a>java 反射案例</h2><p>自定义类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.reflectiontest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;kevinTest&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String flag = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String publicStaticField = <span class="string">&quot;i am a public static field&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> String publicNonStaticField = <span class="string">&quot;i am a public non static field&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String privateStaticField = <span class="string">&quot;i am a private static field&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String privateNonStaticField = <span class="string">&quot;i am a private non static field&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test()&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String arg)</span></span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test(String arg)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String arg, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test(String arg, int num)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publicStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;public Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publicNonStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;public Non Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">privateStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateNonStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Non Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateNonStaticFunc</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Non Static Func: arg is String : &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.reflectiontest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.RequiresApi;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;kevinTest MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the &#x27;native-lib&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi(api = Build.VERSION_CODES.KITKAT)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line"></span><br><span class="line">        test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reflection</span></span><br><span class="line">    <span class="meta">@RequiresApi(api = Build.VERSION_CODES.KITKAT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// get class</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 通过 class.getClassLoader().loadClass()加载</span></span><br><span class="line">            Class TestClazz = MainActivity.class.getClassLoader().loadClass(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>);</span><br><span class="line"><span class="comment">// 使用 Class.forname()显示加载</span></span><br><span class="line">            Class TestClazz1 = Class.forName(<span class="string">&quot;com.kevin.reflectiontest.Test&quot;</span>); </span><br><span class="line"><span class="comment">// 在同一个 classloader 中, 可以直接获取</span></span><br><span class="line">            Class TestCLazz2 = Test.class; </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// constructor filed method</span></span><br><span class="line">        Class TestClazz = Test.class;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取重载的构造函数 并 创建实例</span></span><br><span class="line">            Constructor constructor = TestClazz.getConstructor();</span><br><span class="line">            Test obj1 = (Test) constructor.newInstance();</span><br><span class="line">            Constructor constructor1 = TestClazz.getConstructor(String.class);</span><br><span class="line">            Test obj2 = (Test) constructor1.newInstance(<span class="string">&quot;String arg&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Constructor constructor2 = TestClazz.getConstructor(String.class, <span class="keyword">int</span>.class);</span><br><span class="line">            Test obj3 = (Test) constructor2.newInstance(<span class="string">&quot;String arg&quot;</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">            Constructor[] constructors= TestClazz.getDeclaredConstructors();</span><br><span class="line">            <span class="keyword">for</span> (Constructor each : constructors) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;test: getDeclaredConstructors :&quot;</span> + each);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get public static filed</span></span><br><span class="line">            Field publicStaticField = TestClazz.getDeclaredField(<span class="string">&quot;publicStaticField&quot;</span>);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: getDecalredField() publicStaticFiled is &quot;</span> + publicStaticField);</span><br><span class="line">            <span class="comment">// use Field to get static field value</span></span><br><span class="line">            String publicStaticFieldValue = (String) publicStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: publicStaticFieldValue is &quot;</span> + publicStaticFieldValue);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// get private static field</span></span><br><span class="line">            Field privateStaticField = TestClazz.getDeclaredField(<span class="string">&quot;privateStaticField&quot;</span>);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: getDecalredField() privateStaticField is &quot;</span> + privateStaticField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get value from private static filed</span></span><br><span class="line">            privateStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            String privateStaticFieldValue = (String) privateStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: get private static field value is:&quot;</span> + privateStaticFieldValue);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get public non static value from obj</span></span><br><span class="line">            Field privateNonStaticField = TestClazz.getDeclaredField(<span class="string">&quot;privateNonStaticField&quot;</span>);</span><br><span class="line">            privateNonStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            String privateNonStaticFieldValue = (String) privateNonStaticField.get(obj1);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: get private non static field value is :&quot;</span> + privateNonStaticFieldValue);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get public filed from obj</span></span><br><span class="line">            Field flag = TestClazz.getDeclaredField(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            String value = (String) flag.get(obj1);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: flag value is :&quot;</span> + value);</span><br><span class="line"></span><br><span class="line">            String value1 = (String) flag.get(obj2);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: flag1 value is :&quot;</span> + value1);</span><br><span class="line"></span><br><span class="line">            String value2 = (String) flag.get(obj3);</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;test: flag2 value is :&quot;</span> + value2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// get fields use getDecalredFields() 可以获取所有属性 包含 public 和 private</span></span><br><span class="line">            Field[] fields = TestClazz.getDeclaredFields();</span><br><span class="line">            <span class="keyword">for</span> (Field each : fields)&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onCreate: getDecalredFields() is :&quot;</span> + each);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get fields use getFields() 只能获取 public 属性</span></span><br><span class="line">            Field[] fields1 = TestClazz.getFields();</span><br><span class="line">            <span class="keyword">for</span> (Field each : fields1) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onCreate: getFields() is :&quot;</span> + each);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// get method</span></span><br><span class="line">            <span class="comment">// get methods</span></span><br><span class="line">            Method[] methods = TestClazz.getMethods();</span><br><span class="line">            <span class="keyword">for</span> (Method each : methods) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;test: getMethods() is &quot;</span> + each);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Method[] methods1 = TestClazz.getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span> (Method each : methods1) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;test: getDecalredMethods() is &quot;</span> + each);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// getDecalredMethod() // invoke non static method</span></span><br><span class="line">            Method method = TestClazz.getDeclaredMethod(<span class="string">&quot;privateNonStaticFunc&quot;</span>, String.class);</span><br><span class="line">            method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            method.invoke(obj1, <span class="string">&quot;string as arg&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// invoke static method</span></span><br><span class="line">            Method method1 = TestClazz.getDeclaredMethod(<span class="string">&quot;privateStaticFunc&quot;</span>);</span><br><span class="line">            method1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            method1.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException | InstantiationException | NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Native-方法的标识"><a href="#Native-方法的标识" class="headerlink" title="Native 方法的标识"></a>Native 方法的标识</h1><ul><li>Native 方法在代码中含有 <code>native</code> 关键字修饰</li><li>Native 方法在 Java 中会有静态代码块, 使用了 <code>System.loadLibrary</code> 加载一个 <code>native-lib</code> 的 so 文件</li></ul><h1 id="Jni-函数定义和参数解析"><a href="#Jni-函数定义和参数解析" class="headerlink" title="Jni 函数定义和参数解析"></a>Jni 函数定义和参数解析</h1><ol><li><p><code>JNIEXPORT</code>: 是一个宏, 等价于<code>_ _attribute_ _((visibility (&quot;default&quot;)))</code> , 表示当前函数符号需要导出, 与之对应为<code>hidden</code>隐藏符号信息;</p></li><li><p>```<br>extern “C”</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">: 按照 C 函数进行编译, 不使用</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>name mangling</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">; 因为 C++支持重载, C++类中的函数会使用</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>name mangling</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   1. 未使用 &#96;extern &quot;C&quot;&#96;, &#96;add&#96; 方法被导出为 &#96;_Z3addii&#96;; 还原 &#96;name mangling&#96;可以使用命令: &#96;c++flit -n _Z3addii&#96; 进行还原;</span><br><span class="line">   2. 使用了&#96;extern &quot;C&quot;&#96;, &#96;add1&#96; 方法被导出为 &#96;add1&#96;;</span><br><span class="line"></span><br><span class="line">3. &#96;JNICALL&#96; : 空宏, 目前无实际意义可以删除;</span><br><span class="line"></span><br><span class="line">4. &#96;&#96;&#96;</span><br><span class="line">   JNI</span><br></pre></td></tr></table></figure><p>函数的参数:</p><ol><li><code>JNIEnv* env</code> : 一个<code>JNIEnv</code>类型的指针, 所有<code>JNI</code>函数的第一个参数都是<code>env</code>;</li><li><code>jclass</code> or <code>jobject</code>: 当方法为 <code>static</code>时, 第二个参数为 <code>jclass</code> , 当方法为非<code>static</code>时, 第二个参数为 <code>jobject</code>;</li><li>从第三个参数开始, 才是该函数真正的参数;</li></ol></li><li><p>静态注册的<code>JNI</code>方法命名遵循格式为: <code>Java_包名_类名_方法名</code> , 以<code>Java</code>开头, 用<code>_</code>进行分割</p></li></ol><h1 id="Native-打印-log-日志"><a href="#Native-打印-log-日志" class="headerlink" title="Native 打印 log 日志"></a>Native 打印 log 日志</h1><ol><li>在 C++代码中引入头文件; <code>#include &lt;android/log.h&gt;</code></li><li><code>__android_log_print(ANDROID_LOG_INFO, &quot;kevinTest&quot;, &quot;result is %d&quot;, result);</code></li></ol><h1 id="C-中导入其他-C文件"><a href="#C-中导入其他-C文件" class="headerlink" title="C++ 中导入其他 C文件"></a>C++ 中导入其他 C文件</h1><ol><li><p>在 cpp 目录下创建头文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testc.h</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NDKDEMO01_TESTC_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NDKDEMO01_TESTC_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//NDKDEMO01_TESTC_H</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_c</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>在 cpp 目录下创建</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testc.c</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;testc.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_c</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a +b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在 cpp 目录下的 <code>CMakeLists.txt</code> 中的 <code>add_library</code> 添加 <code>testc.c</code></p></li><li><p>在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">native-lib.cpp</span><br></pre></td></tr></table></figure><p>文件中就可以直接使用导入的方法了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;testc.h&quot;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_kevin_ndkdemo01_MainActivity_myStaticJni</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">    jclass)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> result = add_c(<span class="number">4</span>, <span class="number">6</span>);</span><br><span class="line">__android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;result is %d&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="JNI-和-Java-和-C-C-基础数据类型映射"><a href="#JNI-和-Java-和-C-C-基础数据类型映射" class="headerlink" title="JNI 和 Java 和 C/C++ 基础数据类型映射"></a>JNI 和 Java 和 C/C++ 基础数据类型映射</h1><h2 id="基础数据类型"><a href="#基础数据类型" class="headerlink" title="基础数据类型"></a>基础数据类型</h2><table><thead><tr><th>Java</th><th>C/C++</th><th>JNI</th><th>描述</th></tr></thead><tbody><tr><td>int</td><td>long</td><td>jint</td><td>signed 32bit</td></tr><tr><td>long</td><td>_int64</td><td>jlong</td><td>signed 64 bit</td></tr><tr><td>byte</td><td>signed char</td><td>jbyte</td><td>signed 8bit</td></tr><tr><td>boolean</td><td>unsigned char</td><td>jboolean</td><td>unsigned 8bit</td></tr><tr><td>char</td><td>unsigned short</td><td>jchar</td><td>unsigned 16bit</td></tr><tr><td>short</td><td>short</td><td>jshort</td><td>signed 16bit</td></tr><tr><td>float</td><td>float</td><td>jfloat</td><td>32 bit</td></tr><tr><td>double</td><td>double</td><td>jdouble</td><td>64 bit</td></tr><tr><td>void</td><td>void</td><td>void</td><td>N/A</td></tr></tbody></table><h2 id="引用数据类型"><a href="#引用数据类型" class="headerlink" title="引用数据类型"></a>引用数据类型</h2><table><thead><tr><th>Java</th><th>JNI</th></tr></thead><tbody><tr><td>java.lang.Object</td><td>jobject</td></tr><tr><td>java.lang.Class</td><td>jclass</td></tr><tr><td>java.lang.reflect.Field</td><td>jfieldID</td></tr><tr><td>java.lang.reflect.Method</td><td>jmethodID</td></tr><tr><td>java.lang.String</td><td>jstring</td></tr><tr><td>java.lang.Throwable</td><td>jthrowable</td></tr></tbody></table><h2 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h2><table><thead><tr><th>Java</th><th>JNI</th></tr></thead><tbody><tr><td>int[]</td><td>jintArray</td></tr><tr><td>byte[]</td><td>jbyteArray</td></tr><tr><td>short[]</td><td>jshortArray</td></tr><tr><td>long[]</td><td>jlongArray</td></tr><tr><td>float[]</td><td>jfloatArray</td></tr><tr><td>double[]</td><td>jdoubleArray</td></tr><tr><td>char[]</td><td>jcharArray</td></tr><tr><td>boolean[]</td><td>jbooleanArray</td></tr><tr><td>Object[] 引用类型的数组</td><td>jobjectArray</td></tr></tbody></table><h2 id="访问-String-对象"><a href="#访问-String-对象" class="headerlink" title="访问 String 对象"></a>访问 String 对象</h2><p>从 <code>java</code> 中传入的 <code>String</code> 对象在本地方法中对应的是 <code>jstring</code> 类型, <code>jstring</code>类型和 c 中的 char* 不同, 无法直接使用;</p><p>常用的方法:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 String 对象</span></span><br><span class="line">jstring NewString(const jchar* unicodeChars, jsize len): 创建一个 Unicode 格式的 String 对象</span><br><span class="line">jstring NewStringUTF(const char* bytes): 创建一个 UTF-8 格式的 String 对象</span><br><span class="line"></span><br><span class="line"><span class="comment">// String 对象转 char*</span></span><br><span class="line">const jchar* GetStringChars(jstring string, jboolean* isCopy): 将 string 对象转换成 Unicode 格式的 char* </span><br><span class="line">const char* GetStringUTFChars(jstring string, jboolean* isCopy): 将 string 对象转换成 UTF-8 类型</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放 char* 指针</span></span><br><span class="line">void ReleaseStringChars(jstring string, const jchar* chars) : 释放指向 Unicode 格式的 char* 指针</span><br><span class="line">void ReleaseStringUTFChars(jstring string, const char* utf): 释放指向 UTF-8 格式的 char*指针</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 string 长度</span></span><br><span class="line">jsize GetStringUTFLength(jstring string): 获取 string 对应 UTF-8 的 char*长度</span><br><span class="line">jsize GetStringLength(jstring string): 获取 string 对应 Unicode 格式的 char* 长度</span><br></pre></td></tr></table></figure><p>代码示例:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 java 的 string 类型转为 native 的 char* 互转</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_getStringToChar(JNIEnv *env, jobject, jstring inputStr)&#123;</span><br><span class="line">    <span class="comment">// string 转 char*</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* nativeChar = (env-&gt;GetStringUTFChars(inputStr, <span class="literal">nullptr</span>));</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;string from java is %s&quot;</span>, nativeChar);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(inputStr, nativeChar);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char* 转 string</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fromNativeChar = <span class="string">&quot;char* from native&quot;</span>;</span><br><span class="line">    jstring result = env-&gt;NewStringUTF(fromNativeChar);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>env.GetStringUTFChars(jstring string, jboolean* isCopy)</code> 将传入的 jstring 转换成 UTF-8 的格式, 这样就可以在 C/C++中使用了</li><li><code>env.ReleaseStringUTFChars(jstring string, const char* utf)</code> 在使用完你所转换之后的对象之后，需要显示调用ReleaseStringUTFChars方法，让JVM释放转换成UTF-8的string的对象的空间，如果不显示的调用的话，JVM中会一直保存该对象，不会被垃圾回收器回收，因此就会导致内存溢出</li></ul><h2 id="访问-Array-对象"><a href="#访问-Array-对象" class="headerlink" title="访问 Array 对象"></a>访问 Array 对象</h2><p>和 String 对象一样, 在 c/c++中不能直接访问 jarray 对象, 需要使用 JNIEnv 指针指向的一些方法进行转换;</p><p>常用方法:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取数组长度</span></span><br><span class="line">jsize GetArrayLength(jarray array) : 获取数组的长度</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数组对应的指针</span></span><br><span class="line">jboolean* GetBooleanArrayElements(jbooleanArray array, jboolean* isCopy): 获取 boolean 数组指针</span><br><span class="line"></span><br><span class="line">jbyte* GetByteArrayElements(jbyteArray array, jboolean* isCopy): 获取 byte 数组指针</span><br><span class="line"></span><br><span class="line">jchar* GetCharArrayElements(jcharArray array, jboolean* isCopy): 获取 char 数组指针</span><br><span class="line"></span><br><span class="line">jshort* GetShortArrayElements(jshortArray array, jboolean* isCopy): 获取 short 数组指针</span><br><span class="line"></span><br><span class="line">jint* GetIntArrayElements(jintArray array, jboolean* isCopy): 获取 int 数组指针</span><br><span class="line"></span><br><span class="line">jlong* GetLongArrayElements(jlongArray array, jboolean* isCopy): 获取 long 数组指针</span><br><span class="line"></span><br><span class="line">jfloat* GetFloatArrayElements(jfloatArray array, jboolean* isCopy): 获取 float 数组指针</span><br><span class="line"></span><br><span class="line">jdouble* GetDoubleArrayElements(jdoubleArray array, jboolean* isCopy): 获取 double 数组指针</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历数组</span></span><br><span class="line">jint sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    sum += arrayptr[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放数组指针</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseBooleanArrayElements</span><span class="params">(jbooleanArray <span class="built_in">array</span>, jboolean* elems,</span></span></span><br><span class="line">    jint mode):  释放 boolean 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseByteArrayElements</span><span class="params">(jbyteArray <span class="built_in">array</span>, jbyte* elems,</span></span></span><br><span class="line">    jint mode): 释放 byte 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseCharArrayElements</span><span class="params">(jcharArray <span class="built_in">array</span>, jchar* elems,</span></span></span><br><span class="line">    jint mode): 释放 char 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseShortArrayElements</span><span class="params">(jshortArray <span class="built_in">array</span>, jshort* elems,</span></span></span><br><span class="line">    jint mode): 释放 short 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseIntArrayElements</span><span class="params">(jintArray <span class="built_in">array</span>, jint* elems,</span></span></span><br><span class="line">    jint mode): 释放 int 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseLongArrayElements</span><span class="params">(jlongArray <span class="built_in">array</span>, jlong* elems,</span></span></span><br><span class="line">    jint mode): 释放 long 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseFloatArrayElements</span><span class="params">(jfloatArray <span class="built_in">array</span>, jfloat* elems,</span></span></span><br><span class="line">    jint mode): 释放 float 数组指针</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReleaseDoubleArrayElements</span><span class="params">(jdoubleArray <span class="built_in">array</span>, jdouble* elems,</span></span></span><br><span class="line">    jint mode): 释放 double 数组指针</span><br></pre></td></tr></table></figure><p>代码示例:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// native 使用 java 的 bytes array</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_getByteArray(JNIEnv *env, jobject, jintArray inputIntArray)&#123;</span><br><span class="line">    <span class="comment">// 获取数组长度</span></span><br><span class="line">    jint length = env-&gt;GetArrayLength(inputIntArray);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native 数组长度为 %d&quot;</span>, length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数组元素的指针</span></span><br><span class="line">    jint* arrayptr = env-&gt;GetIntArrayElements(inputIntArray, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据指针和索引获取数组中的对应值</span></span><br><span class="line">    jint sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        sum += arrayptr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native sum is: %d&quot;</span>, sum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放数组指针</span></span><br><span class="line">    env-&gt;ReleaseIntArrayElements(inputIntArray, arrayptr, <span class="number">0</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="访问自定义-Java-对象数组"><a href="#访问自定义-Java-对象数组" class="headerlink" title="访问自定义 Java 对象数组"></a>访问自定义 Java 对象数组</h2><p>JNI 提供了两个单独的方法来访问对象数组的元素, 通过这两个方法可以获取和设置单个对象数组的元素;<br>JNI 无法一次获取到对象数组的所有元素</p><p>常用方法:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jobject GetObjectArrayElement(jobjectArray array, jsize index): 获取 java 对象数组中指定索引位置的值</span><br><span class="line"></span><br><span class="line">void SetObjectArrayElement(jobjectArray array, jsize index, jobject value): 设置 java 对象数组中指定索引位置的值</span><br></pre></td></tr></table></figure><p>代码示例:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// native 使用 java 的 对象数组</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_getStringArray(JNIEnv *env, jobject, jobjectArray inputStringArray)&#123;</span><br><span class="line">    jstring str1 = (jstring) env-&gt;GetObjectArrayElement(inputStringArray, <span class="number">0</span>);</span><br><span class="line">    jstring str2 = (jstring) env-&gt;GetObjectArrayElement(inputStringArray, <span class="number">1</span>);</span><br><span class="line">    jstring str3 = (jstring) env-&gt;GetObjectArrayElement(inputStringArray, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *char1 = env-&gt;GetStringUTFChars(str1, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *char2 = env-&gt;GetStringUTFChars(str2, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *char3 = env-&gt;GetStringUTFChars(str3, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native inputStringArray is : %s %s %s&quot;</span>,</span><br><span class="line">                        char1, char2, char3);</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(str1, char1);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(str2, char2);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(str3, char3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="描述符"><a href="#描述符" class="headerlink" title="描述符"></a>描述符</h1><h2 id="类描述符"><a href="#类描述符" class="headerlink" title="类描述符"></a>类描述符</h2><ul><li>类描述符是类的完整名称(包名+类名), 在 jni 中, 需要将原来的<code>.</code> 分隔符替换成 <code>/</code> 分隔符;</li><li>类描述符常用于 <code>env.FindClass()</code>, 获取 <code>jclass</code> 的时候使用</li></ul><h2 id="域描述符"><a href="#域描述符" class="headerlink" title="域描述符"></a>域描述符</h2><h3 id="基本数据类型域描述符"><a href="#基本数据类型域描述符" class="headerlink" title="基本数据类型域描述符"></a>基本数据类型域描述符</h3><table><thead><tr><th>域描述符</th><th>java 基础数据类型</th></tr></thead><tbody><tr><td>Z</td><td>boolean</td></tr><tr><td>B</td><td>byte</td></tr><tr><td>C</td><td>char</td></tr><tr><td>S</td><td>short</td></tr><tr><td>I</td><td>int</td></tr><tr><td>J</td><td>long</td></tr><tr><td>F</td><td>float</td></tr><tr><td>D</td><td>double</td></tr><tr><td>V</td><td>void</td></tr></tbody></table><h3 id="引用数据类型域描述符"><a href="#引用数据类型域描述符" class="headerlink" title="引用数据类型域描述符"></a>引用数据类型域描述符</h3><p>格式为: <code>L + 该类型的类描述符 + ;</code><br>String 类型的域描述符: <code>&quot;Ljava/lang/String;&quot;</code><br>Object 类型的域描述符: <code>&quot;Ljava/lang/Object;&quot;</code></p><h2 id="函数描述符"><a href="#函数描述符" class="headerlink" title="函数描述符"></a>函数描述符</h2><p>格式为: <code>(参数的域描述符叠加)返回值的域描述符</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String test()&#96; 函数描述符为: &#96;&quot;Ljava&#x2F;lang&#x2F;String&quot;&#96;</span><br><span class="line">&#96;int f(int i, Object object)&#96; 函数描述符为: &#96;&quot;(ILjava&#x2F;lang&#x2F;Object;)I&quot;&#96;</span><br><span class="line">&#96;void set(byte[] bytes)&#96; : 函数描述符为: &#96;&quot;([B)V&quot;</span><br></pre></td></tr></table></figure><h2 id="数组描述符"><a href="#数组描述符" class="headerlink" title="数组描述符"></a>数组描述符</h2><p>格式为: <code>[ + 其他类型的域描述符</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int[]&#96; 描述符为: &#96;[I&#96;</span><br><span class="line">&#96;float[]&#96; 描述符为: &#96;[F&#96;</span><br><span class="line">&#96;String[]&#96; 描述符为: &#96;[Ljava&#x2F;lang&#x2F;String;</span><br></pre></td></tr></table></figure><p>多维数组类型的描述符格式为: <code>n 个 [ + 该类型的域描述符</code><br><code>int[][]</code> 描述符为: <code>[[I</code><br><code>float[][]</code> 描述符为: <code>[[F</code></p><h1 id="JNI-获取-Java-层"><a href="#JNI-获取-Java-层" class="headerlink" title="JNI 获取 Java 层"></a>JNI 获取 Java 层</h1><h2 id="JNI-获取-Java-类"><a href="#JNI-获取-Java-类" class="headerlink" title="JNI 获取 Java 类"></a>JNI 获取 Java 类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jnienv 获取 java 类</span></span><br><span class="line">jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/ndkdemo01/Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// jnienv 通过 java 层传入的对象获取该对象的类</span></span><br><span class="line">jclass TestClass = env-&gt;GetObjectClass(obj); <span class="comment">// obj 为 java 层传入的 Test 对象</span></span><br></pre></td></tr></table></figure><p><code>env.FindClass()</code> 传入的参数为: 对应的 java 类的路径, java 中用<code>.</code> 分割, <code>jni</code> 中使用 <code>/</code> 分割; <code>com/kevin/ndkdemo01/Test</code> 是类描述符, 常在 jni 层查找 java 层对应的类时使用;</p><h2 id="JNI-获取-Java-层属性"><a href="#JNI-获取-Java-层属性" class="headerlink" title="JNI 获取 Java 层属性"></a>JNI 获取 Java 层属性</h2><p>获取 java 层属性常用 API</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取静态属性的 FieldID</span></span><br><span class="line"><span class="function">jfieldID <span class="title">GetStaticFieldID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// clazz : 对应的 jclass</span></span></span><br><span class="line"><span class="function"><span class="comment">// name: 该属性名称</span></span></span><br><span class="line"><span class="function"><span class="comment">// sig: 该属性的域描述符</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 获取非静态属性的 FieldID</span></span></span><br><span class="line"><span class="function">jfieldID <span class="title">GetFieldID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// clazz: 对应的 jclass </span></span></span><br><span class="line"><span class="function"><span class="comment">// name: 该属性的名称</span></span></span><br><span class="line"><span class="function"><span class="comment">// sig: 该属性的域描述符</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 获取非静态属性对应的值</span></span></span><br><span class="line"><span class="function">jobject <span class="title">GetObjectField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jboolean <span class="title">GetBooleanField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jbyte <span class="title">GetByteField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jchar <span class="title">GetCharField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jshort <span class="title">GetShortField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jint <span class="title">GetIntField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jlong <span class="title">GetLongField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jfloat <span class="title">GetFloatField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jdouble <span class="title">GetDoubleField</span><span class="params">(jobject obj, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 获取类的静态属性对应的值</span></span></span><br><span class="line"><span class="function">jobject <span class="title">GetStaticObjectField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jboolean <span class="title">GetStaticBooleanField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jbyte <span class="title">GetStaticByteField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jchar <span class="title">GetStaticCharField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jshort <span class="title">GetStaticShortField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jint <span class="title">GetStaticIntField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jlong <span class="title">GetStaticLongField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jfloat <span class="title">GetStaticFloatField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function">jdouble <span class="title">GetStaticDoubleField</span><span class="params">(jclass clazz, jfieldID fieldID)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 设置非静态属性对应的值</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetObjectField</span><span class="params">(jobject obj, jfieldID fieldID, jobject value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetBooleanField</span><span class="params">(jobject obj, jfieldID fieldID, jboolean value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetByteField</span><span class="params">(jobject obj, jfieldID fieldID, jbyte value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetCharField</span><span class="params">(jobject obj, jfieldID fieldID, jchar value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetShortField</span><span class="params">(jobject obj, jfieldID fieldID, jshort value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetIntField</span><span class="params">(jobject obj, jfieldID fieldID, jint value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetLongField</span><span class="params">(jobject obj, jfieldID fieldID, jlong value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetFloatField</span><span class="params">(jobject obj, jfieldID fieldID, jfloat value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetDoubleField</span><span class="params">(jobject obj, jfieldID fieldID, jdouble value)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 设置静态属性对应的值</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticObjectField</span><span class="params">(jclass clazz, jfieldID fieldID, jobject value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticBooleanField</span><span class="params">(jclass clazz, jfieldID fieldID, jboolean value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticByteField</span><span class="params">(jclass clazz, jfieldID fieldID, jbyte value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticCharField</span><span class="params">(jclass clazz, jfieldID fieldID, jchar value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticShortField</span><span class="params">(jclass clazz, jfieldID fieldID, jshort value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticIntField</span><span class="params">(jclass clazz, jfieldID fieldID, jint value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticLongField</span><span class="params">(jclass clazz, jfieldID fieldID, jlong value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticFloatField</span><span class="params">(jclass clazz, jfieldID fieldID, jfloat value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStaticDoubleField</span><span class="params">(jclass clazz, jfieldID fieldID, jdouble value)</span></span></span><br></pre></td></tr></table></figure><p>JNI 获取类的静态属性</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_jniGetJava(JNIEnv *env, jobject) &#123;</span><br><span class="line">    <span class="comment">// jnienv 获取 java 类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/ndkdemo01/Test&quot;</span>);</span><br><span class="line">    <span class="comment">// jnienv 获取 java 类的静态属性</span></span><br><span class="line">    jfieldID publicStaticField_filedid = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;publicStaticField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring publicStaticFiled_value = (jstring)env-&gt;GetStaticObjectField(TestClass, publicStaticField_filedid);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* native_publicStaticFiled_value = env-&gt;GetStringUTFChars(publicStaticFiled_value, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native publicStaticFiled value is %s&quot;</span>,</span><br><span class="line">                        native_publicStaticFiled_value);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(publicStaticFiled_value, native_publicStaticFiled_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JNI 获取对象的属性</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 获取 java 对象的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_jniGetJavaObjFiled(JNIEnv *env, jobject, jobject testObj) &#123;</span><br><span class="line">    <span class="comment">// env 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/ndkdemo01/Test&quot;</span>);</span><br><span class="line">    jfieldID publicNonStaticFiledId = env-&gt;GetFieldID(TestClass, <span class="string">&quot;publicNonStaticField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring publicNonStaticFieldValue = (jstring) env-&gt;GetObjectField(testObj, publicNonStaticFiledId);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *nativeChar = env-&gt;GetStringUTFChars(publicNonStaticFieldValue, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native public NonStatic Field value is %s&quot;</span>,</span><br><span class="line">                        nativeChar);</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(publicNonStaticFieldValue, nativeChar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JNI-获取-Java-层方法"><a href="#JNI-获取-Java-层方法" class="headerlink" title="JNI 获取 Java 层方法"></a>JNI 获取 Java 层方法</h2><p>获取 java 层方法常用 API</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 java 类的静态方法</span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetStaticMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// clazz: 对应的 jclass</span></span></span><br><span class="line"><span class="function"><span class="comment">// name: 对应的方法名</span></span></span><br><span class="line"><span class="function"><span class="comment">// sig: 对应的函数描述符</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 获取 java 非静态方法</span></span></span><br><span class="line"><span class="function">jmethodID <span class="title">GetMethodID</span><span class="params">(jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">const</span> <span class="keyword">char</span>* sig)</span></span></span><br><span class="line"><span class="function"><span class="comment">// clazz: 对应的 jclass</span></span></span><br><span class="line"><span class="function"><span class="comment">// name: 对应的方法名</span></span></span><br><span class="line"><span class="function"><span class="comment">// sig: 对应的函数描述符</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 调用静态方法</span></span></span><br><span class="line"><span class="function">NativeType CallStatic&lt;type&gt;<span class="title">Method</span><span class="params">(JNIEnv *env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">jmethodID methodID, ...)</span></span>;</span><br><span class="line"></span><br><span class="line">NativeType CallStatic&lt;type&gt;MethodA(JNIEnv *env, jclass clazz,</span><br><span class="line">jmethodID methodID, jvalue *args);</span><br><span class="line"></span><br><span class="line">NativeType CallStatic&lt;type&gt;MethodV(JNIEnv *env, jclass clazz,</span><br><span class="line">jmethodID methodID, va_list args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// clazz: 对应的 jlazz</span></span><br><span class="line"><span class="comment">// methodID: 方法对应的 MethodID</span></span><br><span class="line"><span class="comment">// ...：变参列表</span></span><br><span class="line"><span class="comment">// jvalue *args：Java值数组</span></span><br><span class="line"><span class="comment">// va_list args：指向变参列表的指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用非静态方法</span></span><br><span class="line">NativeType Call&lt;type&gt;Method(JNIEnv *env, jobject obj,</span><br><span class="line">jmethodID methodID, ...);</span><br><span class="line"></span><br><span class="line">NativeType Call&lt;type&gt;MethodA(JNIEnv *env, jobject obj,</span><br><span class="line">jmethodID methodID, <span class="keyword">const</span> jvalue *args);</span><br><span class="line"></span><br><span class="line">NativeType Call&lt;type&gt;MethodV(JNIEnv *env, jobject obj,</span><br><span class="line">jmethodID methodID, va_list args);</span><br><span class="line"><span class="comment">// obj: java 对象</span></span><br><span class="line"><span class="comment">// methodID: 实例方法 ID</span></span><br><span class="line"><span class="comment">// ... : 变参列表</span></span><br><span class="line"><span class="comment">// jvalue *args: 参数数组</span></span><br><span class="line"><span class="comment">// va_list args: 指向变参列表的指针</span></span><br></pre></td></tr></table></figure><p>JNI 获取并调用类的静态方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_jniGetJavaStaticMethod(JNIEnv *env, jobject)&#123;</span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/ndkdemo01/Test&quot;</span>);</span><br><span class="line">    jmethodID publicStaticMethodID = env-&gt;GetStaticMethodID(TestClass, <span class="string">&quot;publicStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallStaticVoidMethod(TestClass, publicStaticMethodID);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native 调用 publicStaticMethod&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JNI 获取并调用非静态方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 获取 java 非静态方法</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_ndkdemo01_MainActivity_jniGetJavaNonStaticMethod(JNIEnv *env, jobject, jobject TestObj)&#123;</span><br><span class="line">    jclass TestClass = env-&gt;GetObjectClass(TestObj);</span><br><span class="line">    jmethodID publicNonStaticMethodID = env-&gt;GetMethodID(TestClass, <span class="string">&quot;publicNonStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallVoidMethod(TestObj, publicNonStaticMethodID);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;native public Nonstatic func&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="JNI-OnLoad"><a href="#JNI-OnLoad" class="headerlink" title="JNI_OnLoad"></a>JNI_OnLoad</h1><p>负责 Java 方法和本地函数的链接工作;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jint JNI_OnLoad(JavaVM* vm, void* reserved)</span><br></pre></td></tr></table></figure><ul><li>参数: 该函数的格式固定, 其中第一个参数为 <code>JavaVM* vm</code>, 第二个参数保留;</li><li>作用: 该函数通常用于处理一些动态注册, 逻辑准备, 参数初始化的功能;</li><li>返回值: <code>JNI</code>的版本号, 如 <code>JNI_VERSION_1_4</code> ;</li><li>运行时机: 运行时机早于其他的 JNI 函数, 在静态代码块中调用 <code>System.loadLibrary()</code> 或者 <code>System.load()</code> 的时候就会调用;</li></ul><h1 id="RegisterNatives"><a href="#RegisterNatives" class="headerlink" title="RegisterNatives"></a>RegisterNatives</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jint RegisterNatives(jclass clazz, const JNINativeMethod* methods, jint nMethods)</span><br></pre></td></tr></table></figure><ul><li><p>clazz: java 层对应的类描述符</p></li><li><p>methods: JNINativeMethod 结构体,定义如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature;</span><br><span class="line">    <span class="keyword">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br><span class="line"><span class="comment">// name: Java 方法名</span></span><br><span class="line"><span class="comment">// signature: Java 函数签名</span></span><br><span class="line"><span class="comment">// fnPtr: native 函数指针</span></span><br></pre></td></tr></table></figure></li><li><p>nMethods: 注册的方法数量</p></li></ul><h2 id="动态注册代码"><a href="#动态注册代码" class="headerlink" title="动态注册代码"></a>动态注册代码</h2><ol><li>定义一个 java 层需要动态注册的方法</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.kevin;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NativeLib</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title">getName</span><span class="params">(<span class="keyword">int</span> number)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>本地声明一个该方法实现的函数, 并动态注册</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">getName</span><span class="params">(JNIEnv* env, jobject thiz, <span class="keyword">int</span> number)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">&quot;Hello from jni !!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *CLASS_NAME = <span class="string">&quot;com/github/kevin/NativeLib&quot;</span>; <span class="comment">// 类名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> JNINativeMethod method = &#123; <span class="comment">// 本地方法描述</span></span><br><span class="line">    <span class="string">&quot;getName&quot;</span>, <span class="comment">// Java 方法名</span></span><br><span class="line">    <span class="string">&quot;(I)Ljava/lang/String;&quot;</span>,  <span class="comment">//方法签名</span></span><br><span class="line">    (<span class="keyword">void</span> *) getName <span class="comment">// 绑定本地函数 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> bindNative(JNIEnv* env)&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line">    clazz = env-&gt;FindClass(CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;RegisterNatives(clazz, &amp;method, <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_6) != JNI_OK)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> res = bindNative(env);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="JavaVM"><a href="#JavaVM" class="headerlink" title="JavaVM"></a>JavaVM</h1><h2 id="JavaVM-定义"><a href="#JavaVM-定义" class="headerlink" title="JavaVM 定义"></a>JavaVM 定义</h2><p><code>JavaVM</code>是一个虚拟机在<code>JNI</code>层的代表, 一个进程只有一个<code>JavaVM</code>, 所有的线程共用一个<code>JavaVM</code>;</p><h2 id="JavaVM-2-种获取方式"><a href="#JavaVM-2-种获取方式" class="headerlink" title="JavaVM 2 种获取方式"></a>JavaVM 2 种获取方式</h2><ol><li><p>通过 <code>JNI_OnLoad</code> 来获取 <code>JavaVM</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>&#123;</span><br><span class="line">  <span class="comment">// 直接获取到 JavaVM* vm</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>通过 <code>JNIEnv</code> 来获取 <code>JavaVM</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 JNIEnv 获取 JavaVM</span></span><br><span class="line">JavaVM* vm = <span class="literal">nullptr</span>;</span><br><span class="line">env-&gt;GetJavaVM(&amp;vm);</span><br></pre></td></tr></table></figure><h2 id="JavaVM-相关-api"><a href="#JavaVM-相关-api" class="headerlink" title="JavaVM 相关 api"></a>JavaVM 相关 api</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">DestroyJavaVM</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> functions-&gt;DestroyJavaVM(<span class="keyword">this</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">AttachCurrentThread</span><span class="params">(JNIEnv** p_env, <span class="keyword">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> functions-&gt;AttachCurrentThread(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">DetachCurrentThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> functions-&gt;DetachCurrentThread(<span class="keyword">this</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">GetEnv</span><span class="params">(<span class="keyword">void</span>** env, jint version)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> functions-&gt;GetEnv(<span class="keyword">this</span>, env, version); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">AttachCurrentThreadAsDaemon</span><span class="params">(JNIEnv** p_env, <span class="keyword">void</span>* thr_args)</span></span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">return</span> functions-&gt;AttachCurrentThreadAsDaemon(<span class="keyword">this</span>, p_env, thr_args); &#125;</span><br></pre></td></tr></table></figure><p><strong>链接到虚拟机</strong></p><p><code>JNIEnv</code> 指针仅在创建它的线程中有效, 如果我们需要在其他线程中访问 <code>JVM</code>, 那么必须先调用 <code>AttachCurrentThread</code> 将当前线程与 <code>JVM</code> 进行关联, 然后才能获得<code>JNIEnv</code> 对象; 当不使用该线程的时候, 需要调用 <code>DetachCurrentThread</code> 来解除链接;</p><p><code>jint AttachCurrentThread(JavaVM* vm , JNIEnv** env , JavaVMAttachArgs* args);</code></p><ul><li>vm: 虚拟机对象指针</li><li>env: 用来保存得到的 JNIEnv 的指针</li><li>args: 链接参数, 参数结构如下所示</li><li>return: 链接成功返回 0, 链接失败返回其他</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JavaVMAttachArgs</span> &#123;</span></span><br><span class="line">    jint        version;    <span class="comment">/* must be &gt;= JNI_VERSION_1_2 */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;       <span class="comment">/* NULL or name of thread as modified UTF-8 str */</span></span><br><span class="line">    jobject     group;      <span class="comment">/* global ref of a ThreadGroup object, or NULL */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>卸载虚拟机</strong></p><p><code>jint DetachCurrentThread(JavaVM* vm);</code></p><p><strong>解除与虚拟机的链接</strong></p><p><code>jint DetachCurrentThread(JavaVM* vm);</code></p><p><strong>卸载虚拟机</strong></p><p><code>jint DestroyJavaVM(JavaVM* vm);</code></p><p><strong>获取 JNIEnv</strong></p><p><code>jint GetEnv(void** env, jint version)</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jnit JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_6) == JNI_OK)&#123;</span><br><span class="line">      __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;jni-&gt;%s&quot;</span>, <span class="string">&quot;vm-&gt;GetEnv((void **) &amp;env, JNI_VERSION_1_6)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="JNIEnv"><a href="#JNIEnv" class="headerlink" title="JNIEnv"></a>JNIEnv</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p><code>JNIEnv*</code> 是 <code>Java Native Interface Environment</code> , 是一个 <code>JNI</code> 接口指针, 指向了本地方法的函数表, 该函数表的每个成员执行了一个 <code>jni</code> 函数</p><h2 id="JNIEnv-特性"><a href="#JNIEnv-特性" class="headerlink" title="JNIEnv 特性"></a>JNIEnv 特性</h2><ol><li><code>JNIEnv</code> 只在创建它的线程中生效, 不能跨线程传递, 不同线程的 <code>JNIEnv</code> 彼此独立</li><li><code>native</code> 环境中创建的线程, 如果需要访问 <code>JNIEnv</code>, 必须调用 <code>AttachCurrentThread</code> 关联, 并使用 <code>DetachCurrentThread</code> 解除链接</li></ol><h2 id="获取-JNIEnv"><a href="#获取-JNIEnv" class="headerlink" title="获取 JNIEnv"></a>获取 <code>JNIEnv</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vm-&gt;GetEnv()&#96; 在主线程获取 &#96;JNIEnv</span><br><span class="line">JNIEnv *env &#x3D; nullptr;</span><br><span class="line">if (vm-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_6) &#x3D;&#x3D; JNI_OK)&#123;</span><br><span class="line">__android_log_print(ANDROID_LOG_INFO, &quot;kevinTest&quot;, &quot;jni-&gt;%s&quot;, &quot;vm-&gt;GetEnv((void **) &amp;env, JNI_VERSION_1_6)&quot;);</span><br><span class="line">&#125;</span><br><span class="line">vm-&gt;GetEnv()&#96; 在子线程中获取 &#96;JNIEnv</span><br><span class="line">&#x2F;&#x2F; 从 JNI_OnLoad中获取的 vm 保存为全局变量 globalvm</span><br><span class="line">&#x2F;&#x2F; 使用 AttachCurrentThread 对子线程进行注册</span><br><span class="line">&#x2F;&#x2F; globalvm-&gt;AttachCurrentThread(&amp;threadenv, nullptr);</span><br><span class="line">&#x2F;&#x2F; 再使用 vm-&gt;GetEnv()获取 JNIEnv</span><br><span class="line">if (globalvm-&gt;AttachCurrentThread(&amp;threadenv, nullptr)&#x3D;&#x3D; JNI_OK)&#123;</span><br><span class="line">    if (globalvm-&gt;GetEnv((void**)&amp;threadenv, JNI_VERSION_1_6) &#x3D;&#x3D; JNI_OK)&#123;</span><br><span class="line">__android_log_print(ANDROID_LOG_INFO, &quot;kevinTest&quot;, &quot;jni-&gt;get jnienv from thread %p&quot;, threadenv);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">globalvm-&gt;DetachCurrentThread();</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li><p><code>JNIEnv</code>是与一个<code>ClassLoader</code>绑定的, 当使用<code>env-&gt;FindClass()</code>进行类的查询和加载时, 便是使用的这个<code>ClassLoader</code></p></li><li><p><code>JNIEnv</code>是当前<code>Java</code>线程的执行环境, 一个<code>JVM</code>对应一个<code>JavaVM</code>结构, 而一个<code>JVM</code>中可能创建多个<code>Java</code>线程, 使用<code>pthread_create</code>新建的线程当使用<code>AttachCurrentTread(&amp;env, nullptr)</code>获得到<code>JNIEnv</code>后, 该<code>JNIEnv</code>的<code>CLassLoader</code>并不是主线程的<code>ClassLoader</code>, 因此也无法加载<code>app</code>自己的 <code>Class</code></p></li><li><p>解决子线程无法获取主线程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader</span><br></pre></td></tr></table></figure><p>问题:</p><ul><li>保存全局<code>ClassLoader</code>, 之后在子线程中使用全局<code>ClassLoader</code></li><li>在主线程中获取到要使用的<code>Class</code>, 创建全局引用</li></ul></li></ul><h1 id="JNI-访问成员属性汇总"><a href="#JNI-访问成员属性汇总" class="headerlink" title="JNI 访问成员属性汇总"></a>JNI 访问成员属性汇总</h1><h2 id="定义-Test-类测试"><a href="#定义-Test-类测试" class="headerlink" title="定义 Test 类测试"></a>定义 <code>Test</code> 类测试</h2><ul><li><p><code>Test</code> 类定义代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.reflectiontest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;kevinTest&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String flag = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String publicStaticField = <span class="string">&quot;i am a public static field&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> String publicNonStaticField = <span class="string">&quot;i am a public non static field&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String privateStaticField = <span class="string">&quot;i am a private static field&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String privateNonStaticField = <span class="string">&quot;i am a private non static field&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test()&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String arg)</span></span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test(String arg)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String arg, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        flag = <span class="string">&quot;Test(String arg, int num)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publicStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;public Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publicNonStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;public Non Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">privateStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateNonStaticFunc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Non Static Func: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateNonStaticFunc</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;private Non Static Func: arg is String : &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="获取-Field-静态属性的方法"><a href="#获取-Field-静态属性的方法" class="headerlink" title="获取 Field 静态属性的方法"></a>获取 <code>Field</code> 静态属性的方法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于获取非基础数据类型的属性</span></span><br><span class="line">jobject     (*GetStaticObjectField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于获取 8 种基础数据类型</span></span><br><span class="line">jboolean    (*GetStaticBooleanField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jbyte       (*GetStaticByteField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jchar       (*GetStaticCharField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jshort      (*GetStaticShortField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jint        (*GetStaticIntField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jlong       (*GetStaticLongField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jfloat      (*GetStaticFloatField)(JNIEnv*, jclass, jfieldID);</span><br><span class="line">jdouble     (*GetStaticDoubleField)(JNIEnv*, jclass, jfieldID);</span><br></pre></td></tr></table></figure><h2 id="设置-Field-静态属性的方法"><a href="#设置-Field-静态属性的方法" class="headerlink" title="设置 Field 静态属性的方法"></a>设置 <code>Field</code> 静态属性的方法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>        (*SetStaticObjectField)(JNIEnv*, jclass, jfieldID, jobject);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticBooleanField)(JNIEnv*, jclass, jfieldID, jboolean);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticByteField)(JNIEnv*, jclass, jfieldID, jbyte);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticCharField)(JNIEnv*, jclass, jfieldID, jchar);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticShortField)(JNIEnv*, jclass, jfieldID, jshort);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticIntField)(JNIEnv*, jclass, jfieldID, jint);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticLongField)(JNIEnv*, jclass, jfieldID, jlong);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticFloatField)(JNIEnv*, jclass, jfieldID, jfloat);</span><br><span class="line"><span class="keyword">void</span>        (*SetStaticDoubleField)(JNIEnv*, jclass, jfieldID, jdouble);</span><br></pre></td></tr></table></figure><h2 id="获取-Field-动态属性的方法"><a href="#获取-Field-动态属性的方法" class="headerlink" title="获取 Field 动态属性的方法"></a>获取 <code>Field</code> 动态属性的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于获取非基础数据类型的属性</span></span><br><span class="line">jobject     (*GetObjectField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于获取 8 种基础数据类型</span></span><br><span class="line">jboolean    (*GetBooleanField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jbyte       (*GetByteField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jchar       (*GetCharField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jshort      (*GetShortField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jint        (*GetIntField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jlong       (*GetLongField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jfloat      (*GetFloatField)(JNIEnv*, jobject, jfieldID);</span><br><span class="line">jdouble     (*GetDoubleField)(JNIEnv*, jobject, jfieldID);</span><br></pre></td></tr></table></figure><h2 id="设置-Field-动态属性的方法"><a href="#设置-Field-动态属性的方法" class="headerlink" title="设置 Field 动态属性的方法"></a>设置 <code>Field</code> 动态属性的方法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>        (*SetObjectField)(JNIEnv*, jobject, jfieldID, jobject);</span><br><span class="line"><span class="keyword">void</span>        (*SetBooleanField)(JNIEnv*, jobject, jfieldID, jboolean);</span><br><span class="line"><span class="keyword">void</span>        (*SetByteField)(JNIEnv*, jobject, jfieldID, jbyte);</span><br><span class="line"><span class="keyword">void</span>        (*SetCharField)(JNIEnv*, jobject, jfieldID, jchar);</span><br><span class="line"><span class="keyword">void</span>        (*SetShortField)(JNIEnv*, jobject, jfieldID, jshort);</span><br><span class="line"><span class="keyword">void</span>        (*SetIntField)(JNIEnv*, jobject, jfieldID, jint);</span><br><span class="line"><span class="keyword">void</span>        (*SetLongField)(JNIEnv*, jobject, jfieldID, jlong);</span><br><span class="line"><span class="keyword">void</span>        (*SetFloatField)(JNIEnv*, jobject, jfieldID, jfloat);</span><br><span class="line"><span class="keyword">void</span>        (*SetDoubleField)(JNIEnv*, jobject, jfieldID, jdouble);</span><br></pre></td></tr></table></figure><h2 id="访问类的静态属性"><a href="#访问类的静态属性" class="headerlink" title="访问类的静态属性"></a>访问类的静态属性</h2><ul><li><p>访问类的静态属性</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 访问非私有的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getStaticField(JNIEnv *env, jobject)&#123;</span><br><span class="line">    <span class="comment">// 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到静态 public 属性的 fieldID</span></span><br><span class="line">    <span class="comment">// public static String publicStaticField = &quot;i am a public static field&quot;;</span></span><br><span class="line">    jfieldID publicStaticFieldid = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;publicStaticField&quot;</span>,</span><br><span class="line">                                                            <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过 GetStaticObjectFiled 找到对应属性的值</span></span><br><span class="line">    jstring publicStaticField = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,</span><br><span class="line">                                                                                    publicStaticFieldid));</span><br><span class="line">    <span class="comment">// 将 jstring 转成 char*</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *publicStaticFieldValue = env-&gt;GetStringUTFChars(publicStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到public 静态属性 %s&quot;</span>, publicStaticFieldValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到静态 private 属性的 FieldID</span></span><br><span class="line">    <span class="comment">// private static String privateStaticField = &quot;i am a private static field&quot;;</span></span><br><span class="line">    jfieldID privateStaticFieldID = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;privateStaticField&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring privateStaticField = (jstring)env-&gt;GetStaticObjectField(TestClass, privateStaticFieldID);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *privateStaticFieldValue = env-&gt;GetStringUTFChars(privateStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到 private 静态属性 %s&quot;</span>,</span><br><span class="line">                        privateStaticFieldValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="修改类的静态属性"><a href="#修改类的静态属性" class="headerlink" title="修改类的静态属性"></a>修改类的静态属性</h2><p><code>SetStaticObjectField</code> 静态的<code>private</code>和<code>public</code>修改的方法相同;</p><ul><li><p>修改类的静态属性</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 访问类的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getStaticField(JNIEnv *env, jobject)&#123;</span><br><span class="line">    <span class="comment">// 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到静态 public 属性的 fieldID</span></span><br><span class="line">    <span class="comment">// public static String publicStaticField = &quot;i am a public static field&quot;;</span></span><br><span class="line">    jfieldID publicStaticFieldid = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;publicStaticField&quot;</span>,</span><br><span class="line">                                                            <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过 GetStaticObjectFiled 找到对应属性的值</span></span><br><span class="line">    jstring publicStaticField = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,publicStaticFieldid));</span><br><span class="line">    <span class="comment">// 将 jstring 转成 char*</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *publicStaticFieldValue = env-&gt;GetStringUTFChars(publicStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到public 静态属性 %s&quot;</span>, publicStaticFieldValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改 public static 属性的值</span></span><br><span class="line">    <span class="comment">// void SetStaticObjectField(jclass clazz, jfieldID fieldID, jobject value)</span></span><br><span class="line">    jstring changeValue = env-&gt;NewStringUTF(<span class="string">&quot;change the value&quot;</span>);</span><br><span class="line">    env-&gt;SetStaticObjectField(TestClass, publicStaticFieldid, changeValue);</span><br><span class="line">    jstring publicStaticFieldChange = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,publicStaticFieldid));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *publicStaticFieldChangeValue = env-&gt;GetStringUTFChars(publicStaticFieldChange, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到public 静态属性 改变为: %s&quot;</span>, publicStaticFieldChangeValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="访问对象的属性"><a href="#访问对象的属性" class="headerlink" title="访问对象的属性"></a>访问对象的属性</h2><ul><li><p>访问对象的属性</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 访问对象的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getObjectField(JNIEnv *env, jobject obj, jobject inputObj)&#123;</span><br><span class="line">    <span class="comment">// 访问对象的私有属性 private String privateNonStaticField = &quot;i am a private non static field&quot;;</span></span><br><span class="line">    <span class="comment">// 1. 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. 获取属性ID</span></span><br><span class="line">    jfieldID privateNonStaticFieldID = env-&gt;GetFieldID(TestClass, <span class="string">&quot;privateNonStaticField&quot;</span>,</span><br><span class="line">                                                       <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 3. 获取对象的值</span></span><br><span class="line">    jstring privateNonStaticField = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetObjectField(inputObj,privateNonStaticFieldID));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. jstring 转 char* 并打印</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* privateNonStaticFieldValue = env-&gt;GetStringUTFChars(privateNonStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;privateNoneStaticFieldValue is %s&quot;</span>,</span><br><span class="line">                        privateNonStaticFieldValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="修改对象的属性"><a href="#修改对象的属性" class="headerlink" title="修改对象的属性"></a>修改对象的属性</h2><ul><li><p>修改对象的属性</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 访问类的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getStaticField(JNIEnv *env, jobject)&#123;</span><br><span class="line">    <span class="comment">// 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到静态 public 属性的 fieldID</span></span><br><span class="line">    <span class="comment">// public static String publicStaticField = &quot;i am a public static field&quot;;</span></span><br><span class="line">    jfieldID publicStaticFieldid = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;publicStaticField&quot;</span>,</span><br><span class="line">                                                            <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过 GetStaticObjectFiled 找到对应属性的值</span></span><br><span class="line">    jstring publicStaticField = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,</span><br><span class="line">                                                                                    publicStaticFieldid));</span><br><span class="line">    <span class="comment">// 将 jstring 转成 char*</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *publicStaticFieldValue = env-&gt;GetStringUTFChars(publicStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到public 静态属性 %s&quot;</span>, publicStaticFieldValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到静态 private 属性的 FieldID</span></span><br><span class="line">    <span class="comment">// private static String privateStaticField = &quot;i am a private static field&quot;;</span></span><br><span class="line">    jfieldID privateStaticFieldID = env-&gt;GetStaticFieldID(TestClass, <span class="string">&quot;privateStaticField&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring privateStaticField = (jstring)env-&gt;GetStaticObjectField(TestClass, privateStaticFieldID);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *privateStaticFieldValue = env-&gt;GetStringUTFChars(privateStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到 private 静态属性 %s&quot;</span>,</span><br><span class="line">                        privateStaticFieldValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改 public static 属性的值</span></span><br><span class="line">    <span class="comment">// void SetStaticObjectField(jclass clazz, jfieldID fieldID, jobject value)</span></span><br><span class="line">    jstring changeValue = env-&gt;NewStringUTF(<span class="string">&quot;change the value&quot;</span>);</span><br><span class="line">    env-&gt;SetStaticObjectField(TestClass, publicStaticFieldid, changeValue);</span><br><span class="line">    jstring publicStaticFieldChange = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,</span><br><span class="line">                                                                               publicStaticFieldid));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *publicStaticFieldChangeValue = env-&gt;GetStringUTFChars(publicStaticFieldChange, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到public 静态属性 改变为: %s&quot;</span>, publicStaticFieldChangeValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改 private static 属性值</span></span><br><span class="line">    jstring changeValue2 = env-&gt;NewStringUTF(<span class="string">&quot;change private the value&quot;</span>);</span><br><span class="line">    env-&gt;SetStaticObjectField(TestClass, privateStaticFieldID, changeValue2);</span><br><span class="line">    jstring privateStaticFieldChange = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetStaticObjectField(TestClass,</span><br><span class="line">                                                                                      privateStaticFieldID));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *privateStaticFieldChangeValue = env-&gt;GetStringUTFChars(privateStaticFieldChange,</span><br><span class="line">                                                                       <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;获取到private 静态属性 改变为: %s&quot;</span>, privateStaticFieldChangeValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jni 访问对象的属性</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getObjectField(JNIEnv *env, jobject obj, jobject inputObj)&#123;</span><br><span class="line">    <span class="comment">// 访问对象的私有属性 private String privateNonStaticField = &quot;i am a private non static field&quot;;</span></span><br><span class="line">    <span class="comment">// 1. 获取类</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. 获取属性ID</span></span><br><span class="line">    jfieldID privateNonStaticFieldID = env-&gt;GetFieldID(TestClass, <span class="string">&quot;privateNonStaticField&quot;</span>,</span><br><span class="line">                                                       <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 3. 获取对象的值</span></span><br><span class="line">    jstring privateNonStaticField = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetObjectField(inputObj,                                                                       privateNonStaticFieldID));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. jstring 转 char* 并打印</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* privateNonStaticFieldValue = env-&gt;GetStringUTFChars(privateNonStaticField, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;privateNoneStaticFieldValue is %s&quot;</span>,</span><br><span class="line">                        privateNonStaticFieldValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 修改对象的属性</span></span><br><span class="line">    jstring newString = env-&gt;NewStringUTF(<span class="string">&quot;modified new String&quot;</span>);</span><br><span class="line">    env-&gt;SetObjectField(inputObj, privateNonStaticFieldID, newString);</span><br><span class="line">    <span class="comment">// 6. 获取对象的值</span></span><br><span class="line">    jstring privateNonStaticField1 = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;GetObjectField(inputObj,                                                      privateNonStaticFieldID));</span><br><span class="line">    <span class="comment">// 7. jstring 转 char* 并打印</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* privateNonStaticFieldValue1 = env-&gt;GetStringUTFChars(privateNonStaticField1, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;privateNoneStaticFieldValue is %s&quot;</span>,</span><br><span class="line">                        privateNonStaticFieldValue1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="访问和修改数组类型的属性"><a href="#访问和修改数组类型的属性" class="headerlink" title="访问和修改数组类型的属性"></a>访问和修改数组类型的属性</h2><p><code>env-&gt;GetArrayLength</code>: 获取数组的长度</p><p><code>env-&gt;GetIntArrayElements</code>: 获取数组首元素的指针</p><p><code>env-&gt;SetIntArrayRegion</code>: 修改数组的值</p><ul><li><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getArrayField(JNIEnv *env, jobject obj, jobject inputObj)&#123;</span><br><span class="line">    <span class="comment">// 1. 获取 class</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    <span class="comment">// private int[] ArrayField = &#123;1, 2, 3, 4&#125;;</span></span><br><span class="line">    <span class="comment">// 2. 获取 fieldID</span></span><br><span class="line">    jfieldID ArrayFieldID = env-&gt;GetFieldID(TestClass, <span class="string">&quot;ArrayField&quot;</span>, <span class="string">&quot;[I&quot;</span>);</span><br><span class="line">    <span class="comment">// 3. 获取 filedobj</span></span><br><span class="line">    jintArray ArrayFiledObj = <span class="keyword">static_cast</span>&lt;jintArray&gt;(env-&gt;GetObjectField(inputObj, ArrayFieldID));</span><br><span class="line">    <span class="comment">// 4. 获取 jintArray 的长度</span></span><br><span class="line">    jint length = env-&gt;GetArrayLength(ArrayFiledObj);</span><br><span class="line">    <span class="comment">// 5. 获取 jintArray 首元素的指针</span></span><br><span class="line">    <span class="keyword">int</span> *<span class="built_in">array</span> = env-&gt;GetIntArrayElements(ArrayFiledObj, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="comment">// 6. 遍历打印</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;array[%d]-&gt;%d&quot;</span>, i, <span class="built_in">array</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7. 定义新的jintArray</span></span><br><span class="line">    jint jni_array[length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        jni_array[i] = <span class="number">10</span> - i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//void SetIntArrayRegion(jintArray array, jsize start, jsize len,</span></span><br><span class="line">    <span class="keyword">const</span> jint *ptr = jni_array;</span><br><span class="line">    env-&gt;SetIntArrayRegion(ArrayFiledObj, <span class="number">0</span>, length, ptr);</span><br><span class="line">    <span class="keyword">int</span> *array1 = env-&gt;GetIntArrayElements(ArrayFiledObj, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="comment">// 6. 遍历打印</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;array[%d]-&gt;%d&quot;</span>, i, array1[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h1 id="JNI-访问成员方法汇总"><a href="#JNI-访问成员方法汇总" class="headerlink" title="JNI 访问成员方法汇总"></a>JNI 访问成员方法汇总</h1><h2 id="访问构造函数"><a href="#访问构造函数" class="headerlink" title="访问构造函数"></a>访问构造函数</h2><p>对于构造函数的调用来说, 只能通过<code>NewObject</code>和<code>AllocObject</code>来调用; 因为构造函数本身首先不是静态函数, 自然不能通过类名进行调用; 其次, 如果按照一般的函数进行调用的话, 还需要传入对象, 而此时还没有对象, 因此只能是使用创建对象的方式来调用;</p><ul><li><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 调用 构造函数</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT jobject JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_getInitMethod(JNIEnv *env, jobject obj)&#123;</span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    <span class="comment">//  Test(String arg, int num)</span></span><br><span class="line">    jmethodID initMethodID = env-&gt;GetMethodID(TestClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>);</span><br><span class="line">    jstring inputStr = env-&gt;NewStringUTF(<span class="string">&quot;构造函数字符串&quot;</span>);</span><br><span class="line">    jobject newObj = env-&gt;NewObject(TestClass, initMethodID, inputStr, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="访问静态函数"><a href="#访问静态函数" class="headerlink" title="访问静态函数"></a>访问静态函数</h2><p>对于静态函数来说, 可以通过传入类名, 直接通过 <code>CallStaticXXXMethod</code> 调用;</p><ol><li><code>CallStaticXXXMethod</code></li><li><code>CallStaticXXXMethodV</code></li><li><code>CallStaticXXXMethodA</code></li></ol><p>这三个接口都可以完成函数的调用, 只不过是传参的方式不同;</p><ul><li><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 调用 静态函数</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_callStaticMethod(JNIEnv *env, jobject obj)&#123;</span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 调用 public 静态方法</span></span><br><span class="line">  <span class="comment">// public static void publicStaticFunc()</span></span><br><span class="line">    jmethodID jmethodId = env-&gt;GetStaticMethodID(TestClass, <span class="string">&quot;publicStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallStaticVoidMethod(TestClass, jmethodId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 private 静态方法</span></span><br><span class="line">  <span class="comment">// private static void privateStaticFunc()</span></span><br><span class="line">    jmethodID jmethidID2 = env-&gt;GetStaticMethodID(TestClass, <span class="string">&quot;privateStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallStaticVoidMethod(TestClass, jmethidID2);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调用 带有参数和返回值的静态方法</span></span><br><span class="line">    <span class="comment">// public static String publicStaticFunc_string(String arg)</span></span><br><span class="line">    jmethodID jmethodID3 = env-&gt;GetStaticMethodID(TestClass, <span class="string">&quot;publicStaticFunc_string&quot;</span>,</span><br><span class="line">                                                  <span class="string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>);</span><br><span class="line">    jstring arg = env-&gt;NewStringUTF(<span class="string">&quot;字符串参数&quot;</span>);</span><br><span class="line">    jstring result = <span class="keyword">static_cast</span>&lt;jstring&gt;(env-&gt;CallStaticObjectMethod(TestClass, jmethodID3, arg));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *logResutl = env-&gt;GetStringUTFChars(result, <span class="literal">nullptr</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;jni log result is : %s&quot;</span>, logResutl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="访问非静态函数"><a href="#访问非静态函数" class="headerlink" title="访问非静态函数"></a>访问非静态函数</h2><p>对于非静态函数来说, 可以通过传入类名, 直接通过<code>CallXXXMethod</code>调用;</p><ul><li><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_callMethod(JNIEnv *env, jobject obj)&#123;</span><br><span class="line">    <span class="comment">// 创建实例</span></span><br><span class="line">    jclass TestClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    jmethodID jmethodId = env-&gt;GetMethodID(TestClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>);</span><br><span class="line">    jstring arg1 = env-&gt;NewStringUTF(<span class="string">&quot;字符串参数&quot;</span>);</span><br><span class="line">    jobject testObj = env-&gt;NewObject(TestClass, jmethodId, arg1, <span class="number">100</span>);</span><br><span class="line">    <span class="comment">// 调用对象的方法</span></span><br><span class="line">    <span class="comment">// public void publicNonStaticFunc()</span></span><br><span class="line">    jmethodID jmethodId2 = env-&gt;GetMethodID(TestClass, <span class="string">&quot;publicNonStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallVoidMethod(testObj, jmethodId2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  private void privateNonStaticFunc()</span></span><br><span class="line">    jmethodID jmethodId3 = env-&gt;GetMethodID(TestClass, <span class="string">&quot;privateNonStaticFunc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    env-&gt;CallVoidMethod(testObj, jmethodId3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="访问父类的函数"><a href="#访问父类的函数" class="headerlink" title="访问父类的函数"></a>访问父类的函数</h2><p><code>CallNonvirtualXXXMethod()</code>通过子类对象调用父类的方法</p><ul><li><p>code</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_callObjFaterMethod(JNIEnv *env, jobject obj, jobject BundleObj)&#123;</span><br><span class="line">    <span class="comment">// jni 层调用 android log</span></span><br><span class="line">    jclass LogClass = env-&gt;FindClass(<span class="string">&quot;android/util/Log&quot;</span>);</span><br><span class="line">    <span class="comment">// public static int i(String tag, String msg)</span></span><br><span class="line">    jmethodID logMehodid = env-&gt;GetStaticMethodID(LogClass, <span class="string">&quot;i&quot;</span>,</span><br><span class="line">                                                  <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)I&quot;</span>);</span><br><span class="line">    jstring arg1 = env-&gt;NewStringUTF(<span class="string">&quot;kevinTest&quot;</span>);</span><br><span class="line">    jstring arg2 = env-&gt;NewStringUTF(<span class="string">&quot;onCreate called&quot;</span>);</span><br><span class="line">    env-&gt;CallStaticIntMethod(LogClass, logMehodid, arg1, arg2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取父类</span></span><br><span class="line">    jclass AppCompatActivityClass = env-&gt;FindClass(<span class="string">&quot;androidx/appcompat/app/AppCompatActivity&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取要调用的父类方法 id</span></span><br><span class="line">    jmethodID jmethodId = env-&gt;GetMethodID(AppCompatActivityClass, <span class="string">&quot;onCreate&quot;</span>,</span><br><span class="line">                                           <span class="string">&quot;(Landroid/os/Bundle;)V&quot;</span>);</span><br><span class="line">    <span class="comment">// void CallNonvirtualVoidMethod(jobject obj, jclass clazz, jmethodID methodID, ...)</span></span><br><span class="line">    <span class="comment">// 调用 CallNonvirtualVoidMethod() 传入对象, 父类名称, 父类方法 id, 参数 进行调用</span></span><br><span class="line">    env-&gt;CallNonvirtualVoidMethod(obj, AppCompatActivityClass, jmethodId, BundleObj);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// error  java.lang.IllegalStateException: Already attached 反复调用 super.onCreate() 方法导致</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="JNI-创建对象"><a href="#JNI-创建对象" class="headerlink" title="JNI 创建对象"></a>JNI 创建对象</h1><ol><li><p>通过 <code>FIndClass</code> 查找到对应的类</p></li><li><p>通过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetMethodID</span><br></pre></td></tr></table></figure><p>找到对应的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmethodID</span><br></pre></td></tr></table></figure><ol><li>构造函数名称统一为 <code>&lt;init&gt;</code></li><li>通过函数描述符来区分重载</li></ol></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni 创建 java 对象</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_kevin_reflectiontest_MainActivity_newObject(JNIEnv *env, jobject)&#123;</span><br><span class="line">    <span class="comment">// NewObject 创建实例</span></span><br><span class="line">    jclass TestClazz = env-&gt;FindClass(<span class="string">&quot;com/kevin/reflectiontest/Test&quot;</span>);</span><br><span class="line">    jmethodID jmethodId = env-&gt;GetMethodID(TestClazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">    jstring arg = env-&gt;NewStringUTF(<span class="string">&quot;I am from JNI : Test(String arg)&quot;</span>);</span><br><span class="line">    jobject testobj = env-&gt;NewObject(TestClazz, jmethodId, arg);</span><br><span class="line">    <span class="keyword">if</span> (testobj != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">        __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;NewObject success! %p&quot;</span>, &amp;testobj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="动态注册和静态注册"><a href="#动态注册和静态注册" class="headerlink" title="动态注册和静态注册"></a>动态注册和静态注册</h1><p>对于任意一个 <code>jni</code> 函数来说, 在该函数调用前, 必须要完成 <code>java</code> 函数与 <code>so</code> 中地址的绑定, 这个绑定过程可以是主动的也可以是被动的;</p><p>被动绑定是由 <code>Dalvik/ART</code> 虚拟机在调用前查找并完成地址的绑定, 这就是静态注册;</p><p>主动注册就是由 <code>app</code> 自己完成的地址绑定;</p><h2 id="静态注册"><a href="#静态注册" class="headerlink" title="静态注册"></a>静态注册</h2><p>对应的函数名: <code>Java_包名_类名_方法名</code> , 通过指定的方式进行命名的 <code>jni</code> 方法</p><p>优点: 静态注册简单明了, 语义清晰</p><p>缺点: 不够安全, 必须要遵守注册规则从而导致名字过长; 由于要保留符号名, 很容易通过 <code>ida</code> 直接定位到方法地址</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java native method</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// jni method</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_afei_jnidemo_MainActivity_stringFromJNI(JNIEnv* env, jobject jobject)&#123;</span><br><span class="line"><span class="comment">// pass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h2><p>在 <code>JNI_OnLoad</code> 中通过 <code>RegisterNatives</code> 方法手动完成 <code>native</code> 方法和 <code>so</code> 中的方法的绑定, 这样虚拟机就可以通过这个函数银蛇关系直接找到相应的方法了;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_kevin_registerdemo_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv* env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(JNIEnv *env, jobject, jint a ,jint b)</span></span>&#123;</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;result is : %d&quot;</span>, a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//typedef struct &#123;</span></span><br><span class="line"><span class="comment">//    const char* name;</span></span><br><span class="line"><span class="comment">//    const char* signature;</span></span><br><span class="line"><span class="comment">//    void*       fnPtr;</span></span><br><span class="line"><span class="comment">//&#125; JNINativeMethod;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//jint RegisterNatives(jclass clazz, const JNINativeMethod* methods, </span></span><br><span class="line"><span class="comment">//jint nMethods)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在静态代码块 System.loadLibrary 或者 System.load 的时候自动执行 JNI_Onload</span></span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span></span>&#123;</span><br><span class="line">    JNIEnv *env = <span class="literal">nullptr</span>;</span><br><span class="line">    vm-&gt;GetEnv(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> **&gt;(&amp;env), JNI_VERSION_1_6);</span><br><span class="line"></span><br><span class="line">    jclass MainActivityClass = env-&gt;FindClass(<span class="string">&quot;com/kevin/registerdemo/MainActivity&quot;</span>);</span><br><span class="line">    JNINativeMethod method[] = &#123;</span><br><span class="line">            &#123;<span class="string">&quot;add&quot;</span>, <span class="string">&quot;(II)V&quot;</span>, (<span class="keyword">void</span> *) add&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    jint result = env-&gt;RegisterNatives(MainActivityClass,  method, <span class="number">1</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;kevinTest&quot;</span>, <span class="string">&quot;registerNatives result is : %d&quot;</span>, result);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="so-加载执行顺序"><a href="#so-加载执行顺序" class="headerlink" title="so 加载执行顺序"></a>so 加载执行顺序</h1><h2 id="常用加载so的方法"><a href="#常用加载so的方法" class="headerlink" title="常用加载so的方法"></a>常用加载<code>so</code>的方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.loadLibrary()&#96;: 自动读取&#96;so&#96;文件的文件名, 不需要加&#96;.so</span><br></pre></td></tr></table></figure><p>例如: <code>System.loadLibrary(&quot;native-lib&quot;);</code></p><p><code>System.load()</code>: 需要指定<code>so</code>的绝对路径</p><p>例如: <code>System.load(&quot;/data/data/xxx/test.so&quot;)</code></p><h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><ol><li><code>extern &quot;C&quot; void _init(void)&#123;&#125;</code></li><li><code>__attribute__((constructor, visibility (&quot;hidden&quot;))) void initarray_1(void)&#123;&#125;</code></li><li><code>extern &quot;C&quot; jint JNI_OnLoad(JavaVM *vm, void *reserved)&#123;&#125;</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> so </category>
          
      </categories>
      
      
        <tags>
            
            <tag> so </tag>
            
            <tag> ndk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向环境搭建</title>
      <link href="androidenv/"/>
      <url>androidenv/</url>
      
        <content type="html"><![CDATA[<h1 id="google-系统镜像"><a href="#google-系统镜像" class="headerlink" title="google 系统镜像"></a>google 系统镜像</h1><ul><li>推荐<code>8.1.0 OPM7.181205.001</code></li><li>下载地址: <a href="https://developers.google.com/android/images">https://developers.google.com/android/images</a></li><li>国内镜像: <a href="http://aosp.opersys.com/">http://aosp.opersys.com/</a></li></ul><h1 id="sdk-工具包"><a href="#sdk-工具包" class="headerlink" title="sdk 工具包"></a>sdk 工具包</h1><ul><li>包含 adb, fastboot, systrace 等</li><li>下载地址: <a href="https://developer.android.com/studio/releases/platform-tools">https://developer.android.com/studio/releases/platform-tools</a></li></ul><h1 id="twrp-管理工具"><a href="#twrp-管理工具" class="headerlink" title="twrp 管理工具"></a>twrp 管理工具</h1><ul><li>下载地址: <a href="https://twrp.me/Devices/">https://twrp.me/Devices/</a></li></ul><h1 id="SuperSU"><a href="#SuperSU" class="headerlink" title="SuperSU"></a>SuperSU</h1><ul><li>下载地址: <a href="https://supersuroot.org/download/">https://supersuroot.org/download/</a></li></ul><h1 id="Magisk"><a href="#Magisk" class="headerlink" title="Magisk"></a>Magisk</h1><ul><li>下载地址: <a href="https://github.com/topjohnwu/Magisk/releases">https://github.com/topjohnwu/Magisk/releases</a></li></ul><h1 id="apktool"><a href="#apktool" class="headerlink" title="apktool"></a>apktool</h1><ul><li>下载地址: <a href="https://bitbucket.org/iBotPeaches/apktool/downloads/">https://bitbucket.org/iBotPeaches/apktool/downloads/</a></li></ul><h1 id="wifiADB"><a href="#wifiADB" class="headerlink" title="wifiADB"></a>wifiADB</h1><ul><li>下载地址: <a href="https://play.google.com/store/apps/details?id=com.ttxapps.wifiadb&amp;hl=en_US">https://play.google.com/store/apps/details?id=com.ttxapps.wifiadb&amp;hl=en_US</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># connect</span></span><br><span class="line">adb connect ip:port</span><br><span class="line">adb shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># disconnect</span></span><br><span class="line">adb disconnect</span><br></pre></td></tr></table></figure><h1 id="安卓系统设置"><a href="#安卓系统设置" class="headerlink" title="安卓系统设置"></a>安卓系统设置</h1><h2 id="wifi-显示错误"><a href="#wifi-显示错误" class="headerlink" title="wifi 显示错误"></a>wifi 显示错误</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">settings put global captive_portal_http_url https://www.google.cn/generate_204</span><br><span class="line">settings put global captive_portal_https_url https://www.google.cn/generate_204</span><br><span class="line">settings put global ntp_server 1.hk.pool.ntp.org</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h1 id="frida-frida-tools-objection-版本"><a href="#frida-frida-tools-objection-版本" class="headerlink" title="frida frida-tools objection 版本"></a>frida frida-tools objection 版本</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保证安装的顺序 否则可能会导致安装的版本不对</span></span><br><span class="line">pip install frida==12.8.0</span><br><span class="line">pip install frida-tools==5.3.0</span><br><span class="line">pip install objection==1.8.4</span><br></pre></td></tr></table></figure><h1 id="BurpSuite-破解版"><a href="#BurpSuite-破解版" class="headerlink" title="BurpSuite 破解版"></a>BurpSuite 破解版</h1><p><a href="https://blog.csdn.net/u014549283/article/details/81248886">https://blog.csdn.net/u014549283/article/details/81248886</a></p><h1 id="brook"><a href="#brook" class="headerlink" title="brook"></a>brook</h1><p><a href="https://github.com/txthinking/brook">https://github.com/txthinking/brook</a></p><h1 id="010editor-过期处理"><a href="#010editor-过期处理" class="headerlink" title="010editor 过期处理"></a>010editor 过期处理</h1><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-11-27-082817.jpg" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-11-27-082817.jpg"></p><h1 id="miniconda"><a href="#miniconda" class="headerlink" title="miniconda"></a>miniconda</h1><p>pyenv依赖问题一直很麻烦，可以切到miniconda</p><ol><li>下载安装脚本（建议科学）：<br>proxychains wget</li></ol><p><a href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh">https://repo.anaconda.com/miniconda/Miniconda3-lat…</a></p><ol><li>给安装脚本可执行权限<br>chmod +x Miniconda3-latest-Linux-x86_64.sh</li><li>运行安装脚本：<br>sh Miniconda3-latest-Linux-x86_64.sh</li><li>安装python3.8.0环境（建议科学）<br>proxychains conda create -n py380 python=3.8.0</li><li>切换到python3.8.0<br>conda activate py380</li><li>安装frida 12.8.0全家桶（建议科学）<br>proxychains pip install frida12.8.0<br>proxychains pip install frida-tools5.3.0<br>proxychains pip install objection==1.8.4</li><li>为了新建的终端默认的env在py380，可以将下面这句话放在/root/.bashrc的末尾，然后source一下。</li></ol><p>conda activate py380</p><ol><li>也可以把这句话放在/root/.bashrc的末尾，source之后只要运行mfrida命令即可切换到py380环境。</li></ol><p>alias mfrida=”conda activate py380”</p><ol><li>第七条和第八条二选一即可。开始享受12.8.0全家桶吧~</li></ol><h1 id="charles-破解版"><a href="#charles-破解版" class="headerlink" title="charles 破解版"></a>charles 破解版</h1><p><a href="https://www.zzzmode.com/mytools/charles/">https://www.zzzmode.com/mytools/charles/</a></p><h1 id="fastboot"><a href="#fastboot" class="headerlink" title="fastboot"></a>fastboot</h1><p><code>r0ysue</code> 星球直接搜索 <code>fastboot</code> 即可</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-11-28-085946.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-11-28-085946.png"></p><h1 id="android-系统刷机教程"><a href="#android-系统刷机教程" class="headerlink" title="android 系统刷机教程"></a>android 系统刷机教程</h1><p><a href="https://github.com/r0ysue/AndroidSecurityStudy/blob/master/FRIDA/A01/README.md">https://github.com/r0ysue/AndroidSecurityStudy/blob/master/FRIDA/A01/README.md</a></p><h1 id="charles-抓包"><a href="#charles-抓包" class="headerlink" title="charles 抓包"></a>charles 抓包</h1><ul><li><a href="http://zhaoxincheng.com/index.php/2020/07/16/%E5%AE%89%E5%8D%937-0%E5%8F%8A%E4%BB%A5%E4%B8%8A%E6%8A%93%E5%8C%85%E8%AF%81%E4%B9%A6%E5%B0%8F%E6%8A%80%E5%B7%A7/">http://zhaoxincheng.com/index.php/2020/07/16/安卓7-0及以上抓包证书小技巧/</a></li></ul><ol><li>将证书安装到 user 下</li><li>用re管理器把<code>/data/misc/user/0/cacerts-added/</code>这个路径下面的文件复制到<code>/system/etc/security/cacerts</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> env </category>
          
      </categories>
      
      
        <tags>
            
            <tag> env </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一行命令内网穿透</title>
      <link href="neiwangchuangtou/"/>
      <url>neiwangchuangtou/</url>
      
        <content type="html"><![CDATA[<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>本地搭建 web 服务</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">&quot;Kevin&quot;</span></span><br><span class="line">__time__ = <span class="string">&quot;2021/2/24&quot;</span></span><br><span class="line">__blog__ = <span class="string">&quot;https://kevinspider.github.io/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   app.run()</span><br></pre></td></tr></table></figure><p>运行起来之后, 可以通过本地端口 <code>http://127.0.0.1:5000/</code> 进行正常访问</p><h1 id="穿透"><a href="#穿透" class="headerlink" title="穿透"></a>穿透</h1><p>开启了本地服务之后, 接下来可以通过 <code>localhost</code> 命令将本地网站提供给所有人访问<br><code>ssh -R 80:localhost:5000 localhost.run</code><br>返回的外网地址为:<br><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-02-24-021047.png" alt="img"><br>直接访问即可: <a href="http://zhangyang-9d453a8b.localhost.run/">http://zhangyang-9d453a8b.localhost.run</a></p>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> others </tag>
            
            <tag> 内网穿透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xposed</title>
      <link href="xposed/"/>
      <url>xposed/</url>
      
        <content type="html"><![CDATA[<h1 id="Xposed-简介"><a href="#Xposed-简介" class="headerlink" title="Xposed 简介"></a>Xposed 简介</h1><p>Xposed 是可以在不修改 apk 的情况下影响程序运行, 修改系统的框架<br>基于它可以制作出很多功能强大的模块, 且在功能不冲突的情况下同时运行;<br>在这个框架下, 我们可以加载自己编写的插件 app, 实现对目标 apk 的注入, 拦截等;</p><h1 id="xposed-原理"><a href="#xposed-原理" class="headerlink" title="xposed 原理"></a>xposed 原理</h1><p>控制 <code>zygote</code> 进程, 通过替换<code>/system/bin/app_precess</code> 程序控制 <code>zygote</code> 进程, 使得它在系统启动的过程中加载 <code>Xposed framework</code> 的一个 <code>jar</code> 文件 (<code>XposedBridge.jar</code>), 从而完成对 <code>zygote</code> 进程机器创建的虚拟机的劫持, 并且能够允许开发者独立替代任何<code>class</code>, 例如 <code>framework</code>本身, 系统 UI 又或者任意一个 app;</p><h1 id="Xposed-开发范式"><a href="#Xposed-开发范式" class="headerlink" title="Xposed 开发范式"></a>Xposed 开发范式</h1><p>新建 android 项目, 在 AndroidManifest.xml 文件中, Application中 activity 标签上面添加以下代码:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;xposedmodule&quot;</span><br><span class="line">    android:value=&quot;true&quot; /&gt;   <span class="comment">&lt;!--定义 xposed 这是一个 xposed 模块--&gt;</span></span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;xposeddescription&quot;</span><br><span class="line">    android:value=&quot;这是一个Xposed例程&quot; /&gt;  <span class="comment">&lt;!-- 关于模块的描述 --&gt;</span></span><br><span class="line">&lt;meta-data</span><br><span class="line">    android:name=&quot;xposedminversion&quot;</span><br><span class="line">    android:value=&quot;53&quot; /&gt;   <span class="comment">&lt;!-- 该模块支持的最低版本 本例为 53 --&gt;</span></span><br></pre></td></tr></table></figure><p>在 AndroidStudio3.1 中, 自动配置 XposedBridgeApi.jar;</p><p>在 项目/app/src/main/ 目录下找到 build.gradle, 添加以下代码:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileOnly &#x27;de.robv.android.xposed:api:82&#x27;</span><br><span class="line">compileOnly &#x27;de.robv.android.xposed:api:82:sources&#x27;</span><br></pre></td></tr></table></figure><p>结果如下:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly &#x27;de.robv.android.xposed:api:82&#x27;</span><br><span class="line">    compileOnly &#x27;de.robv.android.xposed:api:82:sources&#x27;</span><br><span class="line">    implementation fileTree(dir: &quot;libs&quot;, include: [&quot;*.jar&quot;])</span><br><span class="line">    implementation &#x27;androidx.appcompat:appcompat:1.2.0&#x27;</span><br><span class="line">    implementation &#x27;androidx.constraintlayout:constraintlayout:2.0.4&#x27;</span><br><span class="line">    testImplementation &#x27;junit:junit:4.12&#x27;</span><br><span class="line">    androidTestImplementation &#x27;androidx.test.ext:junit:1.1.2&#x27;</span><br><span class="line">    androidTestImplementation &#x27;androidx.test.espresso:espresso-core:3.3.0&#x27;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 Project 模式下, 找到 /app/src/main/java/包名/ , 即在 MainActivity 同级目录下, 创建 java 类;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.xposed03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;包名&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>告诉 xposed 框架入口类的位置, 在 /app/src/main 目录下创建 assets 文件夹, 在该 assets 文件中创建 xposed_init.txt 文件, 在里面定义入口类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.kevin.xposed03.Hook</span><br></pre></td></tr></table></figure><h1 id="Hook-获取类和设置类的静态属性"><a href="#Hook-获取类和设置类的静态属性" class="headerlink" title="Hook 获取类和设置类的静态属性"></a>Hook 获取类和设置类的静态属性</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kevin.xposed03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;Hook&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam lpparam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleLoadPackage: Hook starting&quot;</span>);</span><br><span class="line"><span class="comment">//        xposed 是全局 hook, 必须实现 IXposedHookLoadPackage 的接口</span></span><br><span class="line"><span class="comment">//        handleLoadPackage 是 hook 之后的回调, 其中传入的参数 lpparam 携带了包名信息, 需要进行过滤</span></span><br><span class="line">        <span class="keyword">if</span> (!lpparam.packageName.equals(<span class="string">&quot;com.xiaojianbang.xposeddemo&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleLoadPackage: find target package&quot;</span>);</span><br><span class="line"><span class="comment">//        hook 修改类的静态属性</span></span><br><span class="line"><span class="comment">//        1. 找到要 hook 的类 p1:要 hook 的类名 p2:classLoader</span></span><br><span class="line">        Class&lt;?&gt; targetClazz = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        2. setStaticIntField p1: findClass 的目标类 p2: 字段名称 p3: 要设置的值</span></span><br><span class="line">        XposedHelpers.setStaticIntField(targetClazz, <span class="string">&quot;staticInt&quot;</span>, <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">int</span> staticInt = XposedHelpers.getStaticIntField(targetClazz, <span class="string">&quot;staticInt&quot;</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleLoadPackage: xposed staticInt is &quot;</span> + staticInt);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        设置 String 类型的静态变量的值</span></span><br><span class="line">        XposedHelpers.setStaticObjectField(targetClazz,<span class="string">&quot;Tag&quot;</span>, <span class="string">&quot;kevin&quot;</span>);</span><br><span class="line">        String hookTag = (String) XposedHelpers.getStaticObjectField(targetClazz, <span class="string">&quot;Tag&quot;</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleLoadPackage: xposed hookTag is &quot;</span> + hookTag);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>hadnleLoadPackage() 是 hook 之后的回调函数, 传入的参数 lpparam 携带了大量的信息;</li><li>lpparam.packageName 可以获取到加载的包名, xposed 是全局 hook, 需要使用包名进行过滤</li><li>lpparam.classLoader 可以获取到当前的 classLoader</li><li>XposedHelpers.findClass(类名字符串, 当前的 classLoader 对象) 获取到要 hook 的类</li><li>XposedHelpers.setStaticIntField(要 hook 的类, 静态字段名字符串, 要设置的值) 给类的静态属性赋值</li><li>XposedHelpers.getStaticIntFiled(要 hook 的类, 静态字段名字符串) 获取 int 类型的类的静态属性</li><li>XposedHelpers.setStaticObjectField(要 hook 的类, 静态字段名字符串, 要设置的值) 给非基础数据类型的类的静态属性赋值</li><li>XposedHelpers.getStaticObjectField(要 hook 的类, 静态字段名字符串) 获取非基础数据类型的类的静态属性的值</li></ul><h1 id="Hook-构造函数"><a href="#Hook-构造函数" class="headerlink" title="Hook 构造函数"></a>Hook 构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        hook 构造函数</span></span><br><span class="line">Class&lt;?&gt; targetClazz = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookConstructor(targetClazz, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line"><span class="comment">//            hook 方法需要实现 XC_MethodHook 抽象类, 实现 beforeHookedMethod 方法和 afterHookedMethod 方法</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: 这是无参构造函数前&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: 这是无参构造函数后&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        hook 有参构造函数</span></span><br><span class="line"><span class="comment">//        参数要 hook 的 class 和传入的参数类型 都是字节码 </span></span><br><span class="line">        XposedHelpers.findAndHookConstructor(targetClazz, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                param.args[<span class="number">0</span>] = <span class="string">&quot;Xposed 专题&quot;</span>;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: 这是有参构造函数前&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: 这是有参构造函数后&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-普通方法"><a href="#Hook-普通方法" class="headerlink" title="Hook 普通方法"></a>Hook 普通方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    hook 普通方法</span></span><br><span class="line"><span class="comment">//    xposed 中 hook 普通方法 无论是 static / not static / private / public 都是调用 findAndHookMethod</span></span><br><span class="line">Class&lt;?&gt; targetClazz = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(targetClazz, <span class="string">&quot;publicFunc&quot;</span>, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: publicFunc hooked before input param is: &quot;</span> + param.args[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;beforeHookedMethod: publicFunc hooked after&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-复杂参数"><a href="#Hook-复杂参数" class="headerlink" title="Hook 复杂参数"></a>Hook 复杂参数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        hook 复杂参数</span></span><br><span class="line"><span class="comment">//        参数 1: String</span></span><br><span class="line"><span class="comment">//        参数 2: String[][]</span></span><br><span class="line"><span class="comment">//        参数 3: Map</span></span><br><span class="line"><span class="comment">//        参数 4: ArrayList</span></span><br><span class="line">Class&lt;?&gt; targetClazz = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                targetClazz,</span><br><span class="line">                <span class="string">&quot;complexParameterFunc&quot;</span>,</span><br><span class="line">                String.class, <span class="comment">// &quot;java.lang.String&quot;</span></span><br><span class="line">                String[][].class, <span class="comment">// &quot;[[Ljava.lang.String;&quot;</span></span><br><span class="line">                Map.class, <span class="comment">// &quot;java.util.Map&quot;</span></span><br><span class="line">                ArrayList.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;beforeHookedMethod: complexParameterFunc hooked before&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;beforeHookedMethod: complexParameterFunc hooked after&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-自定义类"><a href="#Hook-自定义类" class="headerlink" title="Hook 自定义类"></a>Hook 自定义类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        hook 自定义类</span></span><br><span class="line"><span class="comment">//        获取自定义的类</span></span><br><span class="line"><span class="comment">//        获取 class 字节码的方法</span></span><br><span class="line"><span class="comment">//          1. 类名.class</span></span><br><span class="line"><span class="comment">//          2. 对象.getClass()</span></span><br><span class="line"><span class="comment">//          3. Class.forName()</span></span><br><span class="line"><span class="comment">//          4. &quot;java.lang.String&quot; 传入类的路径字符串</span></span><br><span class="line"><span class="comment">//          5. new DexClassLoader().loadClass 动态加载</span></span><br><span class="line"><span class="comment">//          6. XposedHelpers.findClass()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Class&lt;?&gt; Animal =  XposedHelpers.findClass(&quot;com.xiaojianbang.xposeddemo.Animal&quot;,lpparam.classLoader);</span></span><br><span class="line"><span class="comment">//        Class&lt;?&gt; Animal = lpparam.classLoader.loadClass(&quot;com.xiaojianbang.xposeddemo.Animal&quot;);</span></span><br><span class="line">        Class&lt;?&gt; Animal = Class.forName(<span class="string">&quot;com.xiaojianbang.xposeddemo.Animal&quot;</span>, <span class="keyword">false</span>, lpparam.classLoader);</span><br><span class="line"></span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                targetClazz,</span><br><span class="line">                <span class="string">&quot;Inner&quot;</span>,</span><br><span class="line">                Animal,</span><br><span class="line">                String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;beforeHookedMethod: Inner&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">&quot;afterHookedMethod: Inner&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-替换函数"><a href="#Hook-替换函数" class="headerlink" title="Hook 替换函数"></a>Hook 替换函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        hook 替换函数</span></span><br><span class="line"><span class="comment">//        不是在方法执行前或后增加内容, 而是直接覆盖该方法, 可以调用原有方法</span></span><br><span class="line">Class&lt;?&gt; targetClazz = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(targetClazz, <span class="string">&quot;repleaceFunc&quot;</span>, <span class="keyword">new</span> XC_MethodReplacement() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">replaceHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;replaceHookedMethod: 替换原有的方法 repleaceFunc&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-内部类并获取对象的属性"><a href="#Hook-内部类并获取对象的属性" class="headerlink" title="Hook 内部类并获取对象的属性"></a>Hook 内部类并获取对象的属性</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; InnerClass = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo$InnerClass&quot;</span>, lpparam.classLoader);</span><br><span class="line">XposedHelpers.findAndHookMethod(InnerClass, <span class="string">&quot;innerFunc&quot;</span>, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">        <span class="keyword">int</span> aa = XposedHelpers.getIntField(param.thisObject, <span class="string">&quot;innerPublicInt&quot;</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;beforeHookedMethod: innerPublicInt is &quot;</span> + aa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>内部类为 类名$内部类名</li><li>获取当前对象 param.thisObject 获取当前的对象</li></ul><h1 id="Hook-主动调用"><a href="#Hook-主动调用" class="headerlink" title="Hook 主动调用"></a>Hook 主动调用</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class targetClass = XposedHelpers.findClass(<span class="string">&quot;com.xiaojianbang.xposeddemo.Demo&quot;</span>, lpparam.classLoader);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;beforeHookedMethod: 调用前&quot;</span>);</span><br><span class="line">XposedHelpers.callMethod(targetClass.newInstance(), <span class="string">&quot;refl&quot;</span>);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;beforeHookedMethod: 调用后&quot;</span>);</span><br></pre></td></tr></table></figure><h1 id="Hook-打印调用栈"><a href="#Hook-打印调用栈" class="headerlink" title="Hook 打印调用栈"></a>Hook 打印调用栈</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.e(<span class="string">&quot;调用栈 tag&quot;</span>, <span class="string">&quot;Stack&quot;</span>, <span class="keyword">new</span> Throwable(<span class="string">&quot;手动抛出异常&quot;</span>));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> xposed </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xposed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>objection 指南</title>
      <link href="objection/"/>
      <url>objection/</url>
      
        <content type="html"><![CDATA[<h1 id="objectiong"><a href="#objectiong" class="headerlink" title="objectiong"></a>objectiong</h1><h2 id="objection-启动"><a href="#objection-启动" class="headerlink" title="objection 启动"></a>objection 启动</h2><h3 id="attach-启动"><a href="#attach-启动" class="headerlink" title="attach 启动"></a>attach 启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g -d packagename explore</span><br></pre></td></tr></table></figure><h3 id="spawn-启动"><a href="#spawn-启动" class="headerlink" title="spawn 启动"></a>spawn 启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--startup-command</span><br><span class="line">objection -g packagename explore --startup-command &#39;android hooking watch class_method android.app.AlertDialog.onCreate --dump-args --dump-backtrace --dump-return&#39;</span><br></pre></td></tr></table></figure><h3 id="连接远程自定义端口"><a href="#连接远程自定义端口" class="headerlink" title="连接远程自定义端口"></a>连接远程自定义端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -N -h 192.168.0.1 -p 6666 -g com.kevin.demo1 explore</span><br></pre></td></tr></table></figure><h2 id="objection-memory"><a href="#objection-memory" class="headerlink" title="objection memory"></a>objection memory</h2><h3 id="memory-list-modules"><a href="#memory-list-modules" class="headerlink" title="memory list modules"></a>memory list modules</h3><p>查看内存中加载的 <code>module</code> , 可以方便获取 <code>.so</code> 的基地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory list modules [--json module.json]</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h3 id="memory-list-exports"><a href="#memory-list-exports" class="headerlink" title="memory list exports"></a>memory list exports</h3><p>查看指定 <code>module</code> 的导出函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory list exports [libssl.so](http:&#x2F;&#x2F;libssl.so) [--json exports.json]</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h2 id="objection-android"><a href="#objection-android" class="headerlink" title="objection android"></a>objection android</h2><h3 id="解除-ssl-pinning"><a href="#解除-ssl-pinning" class="headerlink" title="解除 ssl pinning"></a>解除 ssl pinning</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android sslpinning disable</span><br></pre></td></tr></table></figure><h3 id="获取当前的-activity"><a href="#获取当前的-activity" class="headerlink" title="获取当前的 activity"></a>获取当前的 <code>activity</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking get current_activity</span><br></pre></td></tr></table></figure><h3 id="获取当前的所有-activities"><a href="#获取当前的所有-activities" class="headerlink" title="获取当前的所有 activities"></a>获取当前的所有 <code>activities</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list activities</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h3 id="获取当前的所有-services"><a href="#获取当前的所有-services" class="headerlink" title="获取当前的所有 services"></a>获取当前的所有 <code>services</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list services</span><br></pre></td></tr></table></figure><h3 id="获取当前所有的-receivers"><a href="#获取当前所有的-receivers" class="headerlink" title="获取当前所有的 receivers"></a>获取当前所有的 <code>receivers</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list receivers</span><br></pre></td></tr></table></figure><h3 id="获取当前加载的所有-classes"><a href="#获取当前加载的所有-classes" class="headerlink" title="获取当前加载的所有 classes"></a>获取当前加载的所有 <code>classes</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list classes</span><br></pre></td></tr></table></figure><h3 id="获取指定-class-下的所有-methods"><a href="#获取指定-class-下的所有-methods" class="headerlink" title="获取指定 class 下的所有 methods"></a>获取指定 <code>class</code> 下的所有 <code>methods</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list class_methods com.kevin.demoso1.MainActivity</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h3 id="模糊查询-class"><a href="#模糊查询-class" class="headerlink" title="模糊查询 class"></a>模糊查询 <code>class</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes Main</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h3 id="模糊查询-method"><a href="#模糊查询-method" class="headerlink" title="模糊查询 method"></a>模糊查询 <code>method</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking search methods jni</span><br></pre></td></tr></table></figure><h3 id="查找指定-class-的对象实例"><a href="#查找指定-class-的对象实例" class="headerlink" title="查找指定 class 的对象实例"></a>查找指定 <code>class</code> 的对象实例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android heap search instances com.kevin.demoso1.MainActivity</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><h3 id="调用实例对象的方法"><a href="#调用实例对象的方法" class="headerlink" title="调用实例对象的方法"></a>调用实例对象的方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android heap execute 0x1eea myfirstjni --return-string</span><br></pre></td></tr></table></figure><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-084704.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-084704.png"></p><h3 id="启动指定-activity"><a href="#启动指定-activity" class="headerlink" title="启动指定 activity"></a>启动指定 <code>activity</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android intent launch_activity com.kevin.demoso1.MainActivity</span><br></pre></td></tr></table></figure><h3 id="启动指定-service"><a href="#启动指定-service" class="headerlink" title="启动指定 service"></a>启动指定 <code>service</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android intent launch_service com.kevin.demoso1.MainService</span><br></pre></td></tr></table></figure><h3 id="监控指定的-class"><a href="#监控指定的-class" class="headerlink" title="监控指定的 class"></a>监控指定的 <code>class</code></h3><p>定位到了关键 <code>class</code> , 可以通过 <code>watch class</code> 来监控该类下的所有方法, 帮助定位</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class com.kevin.demoso1.MainActivity --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-091131.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-091131.png"></p><h3 id="监控指定的-method"><a href="#监控指定的-method" class="headerlink" title="监控指定的 method"></a>监控指定的 <code>method</code></h3><p>通过 <code>watch class_method</code> 监控可疑的方法, 对方法的参数, 返回值和调用栈进行打印;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method com.kevin.demoso1.MainActivity.myfirstjniJNI --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-091541.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2020-09-02-091541.png"></p><h3 id="过滤-objection-结果"><a href="#过滤-objection-结果" class="headerlink" title="过滤 objection 结果"></a>过滤 objection 结果</h3><p><code>objection log</code> 默认是不能用 <code>grep</code> 进行过滤的, 但是可以通过</p><p><code>objection -g packagename run commandline | grep keyword</code> 进行过滤</p><p>例如: <code>objection -g com.android.settings run memory list modules | grep libc</code></p><p>还可以通过查看 <code>~/.objection/objection.log</code> 来查看日志信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ~&#x2F;.objection&#x2F;objection.log | grep -i display</span><br></pre></td></tr></table></figure><h2 id="一次-hook-多个类"><a href="#一次-hook-多个类" class="headerlink" title="一次 hook 多个类"></a>一次 hook 多个类</h2><ol><li><p>获取到指定的包下面的所有的类</p><p><code>android hooking search class okhttp</code></p></li><li><p>复制 <code>class</code> , 创建 txt 进行替换, 在类名前面加上 <code>android hooking watch class</code></p></li><li><p>使用 <code>objection -g packagename explore -c file.txt</code> 进行批量 <code>hook</code></p><p><code>objection -g com.kevin.Test explore -c hooklist.txt</code></p></li></ol><h2 id="objection指定参数进行-hook"><a href="#objection指定参数进行-hook" class="headerlink" title="objection指定参数进行 hook"></a><code>objection</code>指定参数进行 <code>hook</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method 指定类和方法 参数类型, 参数类型</span><br></pre></td></tr></table></figure><p>例如: <code>android hooking watch class_method javax.crypto.Mac.getInstance java.lang.String</code></p><h1 id="wallbreaker"><a href="#wallbreaker" class="headerlink" title="wallbreaker"></a>wallbreaker</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone [https:&#x2F;&#x2F;github.com&#x2F;hluwa&#x2F;Wallbreaker](https:&#x2F;&#x2F;github.com&#x2F;hluwa&#x2F;Wallbreaker) ~&#x2F;.objection&#x2F;plugins&#x2F;Wallbreaker</span><br></pre></td></tr></table></figure><h2 id="objection-加载插件"><a href="#objection-加载插件" class="headerlink" title="objection 加载插件"></a>objection 加载插件</h2><h3 id="加载-wallbreaker"><a href="#加载-wallbreaker" class="headerlink" title="加载 wallbreaker"></a>加载 <code>wallbreaker</code></h3><p>启动时加载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g [com.app.name](http:&#x2F;&#x2F;com.app.name) explore -P ~&#x2F;.objection&#x2F;plugins</span><br></pre></td></tr></table></figure><p>启动后加载</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugin load &#x2F;Users&#x2F;zhangyang&#x2F;.objection&#x2F;plugins&#x2F;Wallbreaker</span><br></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ol><li><code>plugin wallbreaker classsearch &lt;pattern&gt;</code> 查找指定的类</li><li><code>plugin wallbreaker classdump &lt;classname&gt; [--fullname]</code> <code>dump</code> 指定的类</li><li><code>plugin wallbreaker objectsearch &lt;classname&gt;</code> 查找指定的类的实例</li><li><code>plugin wallbreaker objectdump &lt;handle&gt; [--fullname]</code> <code>dump</code> 指定的类的实例</li></ol><h1 id="dexdump"><a href="#dexdump" class="headerlink" title="dexdump"></a>dexdump</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;hluwa&#x2F;FRIDA-DEXDump ~&#x2F;.objection&#x2F;plugins&#x2F;dexdump</span><br></pre></td></tr></table></figure><h2 id="加载-dexdump插件"><a href="#加载-dexdump插件" class="headerlink" title="加载 dexdump插件"></a>加载 <code>dexdump</code>插件</h2><p>启动 <code>objection</code> , 读取插件, 这里要注意路径, <code>Wallbreaker</code> 直接读取 <code>plugins</code> 即可, 但是 <code>fridadexdump</code> 需要读取到 <code>dexdump</code> 目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.hello.qqc explore -P ~/.objection/plugins/dexdump/</span><br><span class="line"></span><br><span class="line"><span class="comment"># to dump all found dex.</span></span><br><span class="line">plugin dexdump dump </span><br><span class="line"></span><br><span class="line"><span class="comment"># to search and print all dex</span></span><br><span class="line">plugin dexdump search</span><br></pre></td></tr></table></figure><h2 id="python-中使用-dexdump"><a href="#python-中使用-dexdump" class="headerlink" title="python 中使用 dexdump"></a>python 中使用 dexdump</h2><p><code>pip3 install frida-dexdump</code><br><code>frida-dexdump -h</code><br><code>frida-dexdump dump</code> 直接脱当前应用</p><p>arguments:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-n: [Optional] Specify target process name, when spawn mode, it requires an application package name. If not specified, use frontmost application.</span><br><span class="line">-p: [Optional] Specify pid when multiprocess. If not specified, dump all.</span><br><span class="line">-f: [Optional] Use spawn mode, default is <span class="built_in">disable</span>.</span><br><span class="line">-s: [Optional] When spawn mode, start dump work after sleep few seconds. default is 10s.</span><br><span class="line">-d: [Optional] Enable deep search maybe detected more dex, but speed will be slower.</span><br><span class="line">-h: show <span class="built_in">help</span>.</span><br></pre></td></tr></table></figure><h2 id="查找脱下的-dex"><a href="#查找脱下的-dex" class="headerlink" title="查找脱下的 dex"></a>查找脱下的 <code>dex</code></h2><p>进入存放脱下来的 <code>dex</code> 文件目录, 一般是在 <code>~/.objection/plugins/包名</code> 路径下</p><p>定位主文件</p><ul><li>通过文件大小判断 <code>ls -lht</code></li><li>通过 <code>grep -rnli &quot;mainactivity&quot; *</code> 获取当前目录下含有 <code>MainActivity</code> 的目标文件</li></ul><h2 id="重打包"><a href="#重打包" class="headerlink" title="重打包"></a>重打包</h2><ol><li><code>apktool d -s xxx.apk</code> 保留壳的 <code>dex</code> 文件</li><li>删除原 <code>dex</code> 文件, 将脱壳后的文件全部复制进来, 将文件名修改为 <code>classes.dex</code> <code>classes2.dex</code> <code>classes3.dex</code></li><li>修改 <code>AndroidManifest.xml</code> 文件中的 <code>application</code> 节点下面的 <code>android:name</code> 属性, 原来的是 <code>android:name=&quot;com.SecShell.SecShell.ApplicationWrapper&quot;</code> ，这是梆梆壳启动的地方，现在我们需要修改为脱壳后的 <code>dex</code> 中继承了 <code>Application</code> 的类，我们搜索 <code>extends Appliaction</code> ，可以找到是 <code>cn.net.tokyo.ccg.base.App</code></li><li><code>apktool b 包名</code> 进行重打包</li></ol>]]></content>
      
      
      <categories>
          
          <category> objection </category>
          
      </categories>
      
      
        <tags>
            
            <tag> objection </tag>
            
            <tag> wallbreaker </tag>
            
            <tag> dexdump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>frida hook java</title>
      <link href="fridahookjava/"/>
      <url>fridahookjava/</url>
      
        <content type="html"><![CDATA[<h1 id="Frida-启动"><a href="#Frida-启动" class="headerlink" title="Frida 启动"></a>Frida 启动</h1><h2 id="attach-启动"><a href="#attach-启动" class="headerlink" title="attach 启动"></a>attach 启动</h2><p>直接附加到指定包名的应用中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U com.kevin.android -l hook.js --no-pause</span><br></pre></td></tr></table></figure><p>直接附加到当前应用中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">frida -UF -l hook.js --no-pause</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import frida</span><br><span class="line"></span><br><span class="line">def on_message(message,data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;message&quot;</span>,message)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;data&quot;</span>,data)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">session = device.attach(<span class="string">&quot;com.kevin.demo1&quot;</span>)</span><br><span class="line"></span><br><span class="line">with open(<span class="string">&quot;./demo1.js&quot;</span>,<span class="string">&quot;r&quot;</span>) as f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h2 id="spawn-启动"><a href="#spawn-启动" class="headerlink" title="spawn 启动"></a>spawn 启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.kevin.android -l demo1.js --no-pause</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import frida</span><br><span class="line"></span><br><span class="line">def on_message(message,data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;message&quot;</span>,message)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;data&quot;</span>,data)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.kevin.demo1&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"></span><br><span class="line">with open(<span class="string">&quot;./rpc_demo.js&quot;</span>,<span class="string">&#x27;r&#x27;</span>) as f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"></span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h1 id="frida-server-自定义端口"><a href="#frida-server-自定义端口" class="headerlink" title="frida-server 自定义端口"></a>frida-server 自定义端口</h1><h2 id="frida-server"><a href="#frida-server" class="headerlink" title="frida server"></a>frida server</h2><p>更改 frida server 默认端口: 27042 并开启远程连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su -</span><br><span class="line"><span class="built_in">cd</span> /data/<span class="built_in">local</span>/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入 wifiadb 对应的 ip 和自定义端口</span></span><br><span class="line">./frida-server -l 192.168.0.1:6666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用默认端口启动</span></span><br><span class="line">./frida-server -l 192.168.0.1</span><br></pre></td></tr></table></figure><h2 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h2><p>frida 远程连接自定义端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接指定 6666 端口</span></span><br><span class="line">frida -H 192.168.0.1:6666 com.demo1.app -l demo1.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认使用端口 27042</span></span><br><span class="line">frida -H 192.168.0.1 -l demo1.js</span><br></pre></td></tr></table></figure><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"></span><br><span class="line">jsCode = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">console.log(&quot;test&quot;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        print(<span class="string">f&quot;[*] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(message)</span><br><span class="line"><span class="comment"># ./fs120800 -l &quot;0.0.0.0:6666&quot;</span></span><br><span class="line"><span class="comment"># adb wifi 10.0.0.23</span></span><br><span class="line">process = frida.get_device_manager().add_remote_device(<span class="string">&#x27;127.0.0.1:6666&#x27;</span>).attach(<span class="string">&#x27;com.kevin.app&#x27;</span>)</span><br><span class="line">script = process.create_script(jsCode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,message)</span><br><span class="line">script.load()</span><br><span class="line"><span class="built_in">input</span>()</span><br></pre></td></tr></table></figure><h1 id="Frida-rpc-远程调用"><a href="#Frida-rpc-远程调用" class="headerlink" title="Frida rpc 远程调用"></a>Frida rpc 远程调用</h1><h2 id="python-1"><a href="#python-1" class="headerlink" title="python"></a>python</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span>(<span class="params">message, data</span>):</span></span><br><span class="line"><span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">print(<span class="string">f&quot;[*] <span class="subst">&#123;message[<span class="string">&#x27;payload&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./fs120800 -l &quot;0.0.0.0:6666&quot;</span></span><br><span class="line"><span class="comment"># adb wifi 10.0.0.123</span></span><br><span class="line"><span class="comment"># 远程 frida-server 路径 adb wifi 的 ip : frida-server 启动的端口</span></span><br><span class="line">session = frida.get_device_manager().add_remote_device(<span class="string">&#x27;10.0.0.123:6666&#x27;</span>).attach(<span class="string">&#x27;com.example.demoso1&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/Users/zhangyang/codes/fridaProject/rpcDemo/hook.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    jsCode = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;加载代码&quot;, jsCode)</span></span><br><span class="line">script = session.create_script(jsCode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;加密&quot;,&quot;1213&quot;)</span></span><br><span class="line"><span class="comment"># encodeResult = script.exports.invokemethod01(&quot;123&quot;)</span></span><br><span class="line"><span class="comment"># decodeResult = script.exports.invokemethod02(encodeResult)</span></span><br><span class="line"><span class="comment"># print(decodeResult)</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/encrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#data解密</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_class</span>():</span></span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    res = script.exports.invokemethod01(postdata)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decrypt&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span><span class="comment">#url加密</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_class</span>():</span></span><br><span class="line">    data = request.get_data()</span><br><span class="line">    json_data = json.loads(data.decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    postdata = json_data.get(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    print(postdata)</span><br><span class="line">    res = script.exports.invokemethod02(postdata)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure><h2 id="js"><a href="#js" class="headerlink" title="js"></a>js</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///&lt;reference path=&#x27;/Users/zhangyang/node_modules/@types/frida-gum/index.d.ts&#x27;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 先 hook 方法 method01</span></span><br><span class="line"><span class="comment">// function hookmethod1()&#123;</span></span><br><span class="line"><span class="comment">//     Java.perform(function()&#123;</span></span><br><span class="line"><span class="comment">//         var targetClass = Java.use(&quot;com.example.demoso1.MainActivity&quot;);</span></span><br><span class="line"><span class="comment">//         targetClass.method01.implementation = function(str)&#123;</span></span><br><span class="line"><span class="comment">//             console.log(&quot;str is &quot;, str);</span></span><br><span class="line"><span class="comment">//             var result = this.method01(str);</span></span><br><span class="line"><span class="comment">//             console.log(&quot;result is &quot;, result);</span></span><br><span class="line"><span class="comment">//             return result;</span></span><br><span class="line"><span class="comment">//         &#125;</span></span><br><span class="line"><span class="comment">//     &#125;)</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主动调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fridamethod01</span>(<span class="params">inputStr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">null</span>;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> targetClass = Java.use(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>);</span><br><span class="line">        result = targetClass.method01(inputStr);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fridamethod02</span>(<span class="params">inputStr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// public native String method02(String str);</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>,&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">ins</span>)</span>&#123;</span><br><span class="line">                result = ins.method02(inputStr);</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优先测试 js 中的主动调用</span></span><br><span class="line"><span class="comment">// function main()&#123;</span></span><br><span class="line"><span class="comment">//     console.log(&quot;你好 -&gt; 结果为:&quot;, fridamethod01(&quot;你好&quot;));</span></span><br><span class="line"><span class="comment">//     console.log(&quot;27cae29a0913f6791705ca10be31a3e0 -&gt; 结果为&quot;, fridamethod02(&quot;27cae29a0913f6791705ca10be31a3e0&quot;))</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// setImmediate(main);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于主动调用设置 rpc</span></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    invokemethod01: fridamethod01,</span><br><span class="line">    invokemethod02: fridamethod02,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><p>tmp.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;data&quot;</span>: <span class="string">&quot;62feb9a98a01945ab06c0dd7823adc57&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">siege -c30 -r1 <span class="string">&quot;&lt;http://127.0.0.1:5000/encrypt&gt; POST &lt; tmp.json&quot;</span></span><br></pre></td></tr></table></figure><h2 id="nps-进行内网穿透"><a href="#nps-进行内网穿透" class="headerlink" title="nps 进行内网穿透"></a>nps 进行内网穿透</h2><ol><li><p>nps server 启动</p><p>mac: <code>sudo nps start</code></p></li><li><p>新建客户端</p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-01-14-032324.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-01-14-032324.png"></p><p>安卓手机连接客户端 <code>./npc -server=10.0.0.124:8024 -vkey=hm40rtjpf2j3c1up -type=tcp</code></p></li><li><p>给客户端添加和 frida server 的端口映射</p><p>安卓手机启动 frida-server: <code>./fs12800 -l 0.0.0.0:6666</code></p><p><img src="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-01-14-032703.png" alt="https://kevinspider-1258012111.cos.ap-shanghai.myqcloud.com/2021-01-14-032703.png"></p><p>将目标 frida-server 的端口映射到 56666 端口上</p></li><li><p>python 脚本更改和 frida-server 的连接</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session = frida.get_device_manager().add_remote_device(<span class="string">&#x27;10.0.0.124:56666&#x27;</span>).attach(<span class="string">&#x27;com.example.demoso1&#x27;</span>)</span><br></pre></td></tr></table></figure><p>此时就可以将 frida-server 开放到公网了;</p></li></ol><h1 id="Hook-普通方法"><a href="#Hook-普通方法" class="headerlink" title="Hook 普通方法"></a>Hook 普通方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> UtilsClass = Java.use(<span class="string">&quot;com.kevin.app.Utils&quot;</span>);</span><br><span class="line">        UtilsClass.getCalc.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 打印信息</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;a:&#x27;</span> + a + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;b:&#x27;</span> + b);</span><br><span class="line">        <span class="comment">// 调用原方法获取结果</span></span><br><span class="line">        <span class="keyword">var</span> value = <span class="built_in">this</span>.getCalc(a, b);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;result:&#x27;</span>,value);</span><br><span class="line">            <span class="comment">// 修改返回值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">123456</span>;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-重载方法"><a href="#Hook-重载方法" class="headerlink" title="Hook 重载方法"></a>Hook 重载方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> UtilsClass = Java.use(<span class="string">&quot;com.kevin.app.Utils&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重载无参方法</span></span><br><span class="line">        UtilsClass.test.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hook overload no args&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.test();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重载有参方法 - 基础数据类型</span></span><br><span class="line">UtilsClass.test.overload(<span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hook overload int args&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> myNum = <span class="number">9999</span>;</span><br><span class="line">            <span class="keyword">var</span> oriResult = <span class="built_in">this</span>.test(num);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;oriResult is :&quot;</span> + oriResult);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.test(myNum);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重载有参方法 - 引用数据类型</span></span><br><span class="line">        UtilsClass.test.overload(<span class="string">&#x27;com.kevin.app.Money&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">money</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hook Money args&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.test(money);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// hook 指定方法的所有重载</span></span><br><span class="line">        <span class="keyword">var</span> ClassName = Java.use(<span class="string">&quot;com.xiaojianbang.app.Utils&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> overloadsLength = ClassName.test.overloads.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overloadsLength; i++)&#123;</span><br><span class="line">            ClassName.test.overloads[i].implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 遍历打印 arguments </span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> a = <span class="number">0</span>; a &lt; <span class="built_in">arguments</span>.length; a++)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(a + <span class="string">&quot; : &quot;</span> + <span class="built_in">arguments</span>[a]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 调用原方法</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.test.apply(<span class="built_in">this</span>,<span class="built_in">arguments</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-构造方法"><a href="#Hook-构造方法" class="headerlink" title="Hook 构造方法"></a>Hook 构造方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook 构造方法 $init</span></span><br><span class="line">        <span class="keyword">var</span> MoneyClass = Java.use(<span class="string">&quot;com.kevin.app.Money&quot;</span>);</span><br><span class="line">        MoneyClass.$init.overload().implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hook Money $init&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.$init();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-对象"><a href="#Hook-对象" class="headerlink" title="Hook 对象"></a>Hook 对象</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook instance</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>,&#123;</span><br><span class="line">            onMatch : <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;find it!!&quot;</span>, instance.getInfo());</span><br><span class="line">                <span class="comment">// something to do...</span></span><br><span class="line">            &#125;,</span><br><span class="line">            </span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;compelete!!!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-动静态成员属性"><a href="#Hook-动静态成员属性" class="headerlink" title="Hook 动静态成员属性"></a>Hook 动静态成员属性</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> MoneyClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get static properties</span></span><br><span class="line">        <span class="comment">// need to use .value</span></span><br><span class="line">        <span class="keyword">var</span> ori_property = MoneyClass.flag.value;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;ori_property: &quot;</span>, ori_property);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// change static properties </span></span><br><span class="line">        MoneyClass.flag.value = <span class="string">&quot;change the value&quot;</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;change to : &quot;</span>, MoneyClass.flag.value);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// get dynamic properties </span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>,&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                instance.num.value = <span class="number">50000</span>;</span><br><span class="line">                <span class="comment">// 当对象的成员属性和成员方法名重复时,成员属性前加`_`,进行区分</span></span><br><span class="line">                instance._name.value = <span class="string">&quot;ouyuan&quot;</span>; </span><br><span class="line">                <span class="built_in">console</span>.log(instance._name.value, instance.num.value, instance.flag.value);</span><br><span class="line">            &#125;,</span><br><span class="line">            </span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;complete!!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-内部类"><a href="#Hook-内部类" class="headerlink" title="Hook 内部类"></a>Hook 内部类</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perfor(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook 内部类</span></span><br><span class="line">        <span class="comment">// 内部类使用$进行分隔 不使用.</span></span><br><span class="line">        <span class="keyword">var</span> InnerClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.Money$innerClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 重写内部类的 $init 方法</span></span><br><span class="line">        InnerClass.$init.overload(<span class="string">&quot;java.lang.String&quot;</span>,<span class="string">&quot;int&quot;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;x: &quot;</span>,x);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;y: &quot;</span>,y);</span><br><span class="line">            <span class="built_in">this</span>.$init(x,y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h1 id="Hook-匿名类"><a href="#Hook-匿名类" class="headerlink" title="Hook 匿名类"></a>Hook 匿名类</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接口, 抽象类, 不可以被new</span></span><br><span class="line"><span class="comment">// 接口, 抽象类 要使用必须要实例化, 实例化不是通过new, 而是通过实现接口方法, 继承抽象类等方式</span></span><br><span class="line"><span class="comment">// new __接口__&#123;&#125; 可以理解成 new 了一个实现接口的匿名类, 在匿名类的内部(花括号内),实现了这个接口</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook 匿名类</span></span><br><span class="line">        <span class="comment">// 匿名类在 smail中以 $1, $2 等方式存在, 需要通过 java 行号去 smail 找到准确的匿名类名称 </span></span><br><span class="line">        <span class="keyword">var</span> NiMingClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.MainActivity$1&quot;</span>);</span><br><span class="line">        NiMingClass.getInfo.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;kevin change 匿名类&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h1 id="Hook-类的所有方法"><a href="#Hook-类的所有方法" class="headerlink" title="Hook 类的所有方法"></a>Hook 类的所有方法</h1><ul><li><code>Java.enumerateLoadedClasses()</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">name,handle</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(name,handle);</span><br><span class="line">                    <span class="comment">// 利用反射 获取类中的所有方法</span></span><br><span class="line">                    <span class="keyword">var</span> TargetClass = Java.use(name);</span><br><span class="line">                    <span class="comment">// return Method Object List</span></span><br><span class="line">                    <span class="keyword">var</span> methodsList = TargetClass.class.getDeclaredMethods(); </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methodsList.length; i++)&#123;</span><br><span class="line">                        <span class="comment">// Method Objection getName()</span></span><br><span class="line">                        <span class="built_in">console</span>.log(methodsList[i].getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            </span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;complete!!!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Java.enumerateLoadedClassesSync()</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// return String[] class name</span></span><br><span class="line">        <span class="keyword">var</span> classList = Java.enumerateLoadedClassesSync();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; classList.length; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> targetClass = classList[i];</span><br><span class="line">            <span class="keyword">if</span> (targetClass.indexOf(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;hook the class: &quot;</span>, targetClass);</span><br><span class="line">            <span class="keyword">var</span> TargetClass = Java.use(targetClass);</span><br><span class="line">                <span class="comment">// 利用反射获取类中的所有方法</span></span><br><span class="line">            <span class="keyword">var</span> methodsList = TargetClass.class.getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> k=<span class="number">0</span>; k &lt; methodsList.length; k++)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(methodsList[k].getName());</span><br><span class="line">            &#125;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h1 id="Hook-类的所有方法及重载"><a href="#Hook-类的所有方法及重载" class="headerlink" title="Hook 类的所有方法及重载"></a>Hook 类的所有方法及重载</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// hook md5 class in app</span></span><br><span class="line">        <span class="comment">// 1. iterate classes</span></span><br><span class="line">        <span class="keyword">var</span> classList = Java.enumerateLoadedClassesSync();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; classList.length; i++)&#123;</span><br><span class="line">            <span class="comment">// 筛选过滤 只遍历 MD5 下面的方法</span></span><br><span class="line">            <span class="keyword">if</span> (classList[i].indexOf(<span class="string">&quot;com.xiaojianbang.app.MD5&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> className = classList[i];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;class name is :&quot;</span>, className);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2. get methods of the class</span></span><br><span class="line">                <span class="comment">// 返回一个 Methods对象的数组</span></span><br><span class="line">                <span class="keyword">var</span> methodsList = Java.use(className).class.getDeclaredMethods();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> k=<span class="number">0</span>; k&lt;methodsList.length; k++)&#123;                    </span><br><span class="line">                    <span class="comment">// console.log(&quot;method is :&quot;,methodsList[k],typeof(methodsList[k]));</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 3. Method object.getName() --&gt; methodName and class[methodName] to hook method</span></span><br><span class="line">                    <span class="keyword">var</span> methodName = methodsList[k].getName(); <span class="comment">// </span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// console.log(&#x27;methodName&#x27;,methodName);</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 4. use apply and arguments to implementation</span></span><br><span class="line">                    <span class="keyword">var</span> hookClass = Java.use(className);</span><br><span class="line">                    <span class="comment">// 5. overloads</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> o = <span class="number">0</span>; o&lt; hookClass[methodName].overloads.length; o++)&#123;</span><br><span class="line">                        hookClass[methodName].overloads[o].implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">var</span> a=<span class="number">0</span>; a&lt;<span class="built_in">arguments</span>.length; a++)&#123;</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">&#x27;argument &#x27;</span>,a,<span class="built_in">arguments</span>[a]);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// return this[methodName].apply(this,arguments);</span></span><br><span class="line">                            <span class="keyword">return</span> <span class="string">&quot;fucking the md5&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-动态加载的-dex"><a href="#Hook-动态加载的-dex" class="headerlink" title="Hook 动态加载的 dex"></a>Hook 动态加载的 dex</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            onMatch : <span class="function"><span class="keyword">function</span>(<span class="params">loader</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// loadClass or findClass</span></span><br><span class="line">                    <span class="keyword">if</span> (loader.loadClass(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>))&#123;</span><br><span class="line">                        Java.classFactory.loader = loader;</span><br><span class="line">                        <span class="keyword">var</span> hookClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.Dynamic&quot;</span>);</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">&quot;success hook it :&quot;</span>, hookClass);</span><br><span class="line">                        <span class="comment">// something to do;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="comment">// pass</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            </span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;complete !!! &quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-主动构造数组"><a href="#Hook-主动构造数组" class="headerlink" title="Hook 主动构造数组"></a>Hook 主动构造数组</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mainArray</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> myCharList = Java.array(<span class="string">&quot;char&quot;</span>,[<span class="string">&#x27;一&#x27;</span>,<span class="string">&#x27;去&#x27;</span>,<span class="string">&#x27;二&#x27;</span>,<span class="string">&#x27;三&#x27;</span>,<span class="string">&#x27;里&#x27;</span>]);</span><br><span class="line">        <span class="keyword">var</span> myStringList = Java.array(<span class="string">&quot;java.lang.String&quot;</span>,[<span class="string">&quot;一&quot;</span>,<span class="string">&quot;二&quot;</span>,<span class="string">&quot;三&quot;</span>]);</span><br><span class="line">        <span class="keyword">var</span> ArrayClass = Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(ArrayClass.toString(myCharList));</span><br><span class="line">        <span class="built_in">console</span>.log(ArrayClass.toString(myStringList));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-cast-强制类型转换"><a href="#Hook-cast-强制类型转换" class="headerlink" title="Hook cast 强制类型转换"></a>Hook cast 强制类型转换</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java.cast() 子类可以强转成父类, 父类不能转成子类</span></span><br><span class="line"><span class="comment">// 可以使用Java.cast()将子类强转成父类, 再调用父类的动态方法</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">castDemo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> JuiceHandle = <span class="literal">null</span>; <span class="comment">// 用来存储内存中找到的Juice对象</span></span><br><span class="line">        <span class="keyword">var</span> WaterClass = Java.use(<span class="string">&quot;com.r0ysue.a0526printout.Water&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        Java.choose(<span class="string">&quot;com.r0ysue.a0526printout.Juice&quot;</span>,&#123;</span><br><span class="line">onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                JuiceHandle = instance;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;instance:&quot;</span>, instance);</span><br><span class="line">                <span class="comment">// 调用Juice对象的方法</span></span><br><span class="line">                <span class="built_in">console</span>.log(JuiceHandle.fillEnergy());</span><br><span class="line">                <span class="comment">// 子类Juice转父类Water 并调用父类的动态方法</span></span><br><span class="line">                <span class="keyword">var</span> WaterInstance = Java.cast(JuiceHandle,WaterClass);</span><br><span class="line">                <span class="built_in">console</span>.log(WaterInstance.still(WaterInstance));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-打印类实现的接口"><a href="#Hook-打印类实现的接口" class="headerlink" title="Hook 打印类实现的接口"></a>Hook 打印类实现的接口</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">searchInterface</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">name,handle</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (name.indexOf(<span class="string">&quot;com.r0ysue.a0526printout&quot;</span>) &gt; -<span class="number">1</span>) &#123; <span class="comment">// 使用包名进行过滤</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;find class&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> targetClass = Java.use(name);</span><br><span class="line">                    <span class="keyword">var</span> interfaceList = targetClass.class.getInterfaces(); <span class="comment">// 使用反射获取类实现的接口数组</span></span><br><span class="line">                    <span class="keyword">if</span> (interfaceList.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(name) <span class="comment">// 打印类名</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> interfaceList) &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;\t&quot;</span>, interfaceList[i].toString()); <span class="comment">// 直接打印接口名称</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-enum-枚举"><a href="#Hook-enum-枚举" class="headerlink" title="Hook enum 枚举"></a>Hook enum 枚举</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enumPrint</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.r0ysue.a0526printout.Signal&quot;</span>,&#123;</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;find it ,&#x27;</span>,instance);</span><br><span class="line">                <span class="built_in">console</span>.log(instance.class.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-获取-context"><a href="#Hook-获取-context" class="headerlink" title="Hook 获取 context"></a>Hook 获取 context</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContext</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&quot;android.app.ActivityThread&quot;</span>).currentApplication();</span><br><span class="line">        <span class="built_in">console</span>.log(currentApplication);</span><br><span class="line">        <span class="keyword">var</span> context = currentApplication.getApplicationContext();</span><br><span class="line">        <span class="built_in">console</span>.log(context);</span><br><span class="line">        <span class="keyword">var</span> packageName = context.getPackageName();</span><br><span class="line">        <span class="built_in">console</span>.log(packageName);</span><br><span class="line">        <span class="built_in">console</span>.log(currentApplication.getPackageName());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-主动调用构造方法"><a href="#Hook-主动调用构造方法" class="headerlink" title="Hook 主动调用构造方法"></a>Hook 主动调用构造方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> StringClass = Java.use(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> MoneyClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>);</span><br><span class="line">        MoneyClass.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;hook Money init&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> myX = StringClass.new(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> myY = <span class="number">9999</span>;</span><br><span class="line">            <span class="built_in">this</span>.$init(myX,myY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-主动调用静态方法"><a href="#Hook-主动调用静态方法" class="headerlink" title="Hook 主动调用静态方法"></a>Hook 主动调用静态方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main_rsa</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> RSA = Java.use(<span class="string">&quot;com.xiaojianbang.app.RSA&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> StringClass = Java.use(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> base64Class = Java.use(<span class="string">&quot;android.util.Base64&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> myBytes = StringClass.$new(<span class="string">&quot;Hello World&quot;</span>).getBytes();</span><br><span class="line">        <span class="keyword">var</span> result = RSA.encrypt(myBytes);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;result is :&quot;</span>, result);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;json result is: &quot;</span>,<span class="built_in">JSON</span>.stringify(result));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;base64 result is :&quot;</span>, base64Class.encodeToString(result,<span class="number">0</span>));</span><br><span class="line">        <span class="comment">// console.log(&quot;new String is : &quot;, StringClass.$new(result)); // 加密之后的内容有很多不可见字符, 不能直接 new String()</span></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main_rsa);</span><br></pre></td></tr></table></figure><h1 id="Hook-主动调用动态方法"><a href="#Hook-主动调用动态方法" class="headerlink" title="Hook 主动调用动态方法"></a>Hook 主动调用动态方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 非静态方法的主动调用 自定义instance 并调用 非静态方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main_getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> instance = Java.use(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>).$new(<span class="string">&quot;日元&quot;</span>,<span class="number">300000</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(instance.getInfo());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历所有的对象并调用 需要进行过滤</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main_instance_getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.xiaojianbang.app.Money&quot;</span>,&#123;</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(instance.getInfo());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-frida-和-python-交互"><a href="#Hook-frida-和-python-交互" class="headerlink" title="Hook frida 和 python 交互"></a>Hook frida 和 python 交互</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">frida 传递参数</span><br><span class="line">function main()&#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        console.log(&quot;enter perform&quot;);</span><br><span class="line">        &#x2F;&#x2F; 获取要hook的类</span><br><span class="line">        var TextViewClass &#x3D; Java.use(&quot;android.widget.TextView&quot;);</span><br><span class="line">        &#x2F;&#x2F; 要hook的方法</span><br><span class="line">        TextViewClass.setText.overload(&#39;java.lang.CharSequence&#39;).implementation &#x3D; function (ori_input) &#123;</span><br><span class="line">            console.log(&#39;enter&#39;, &#39;java.lang.CharSequence&#39;);</span><br><span class="line">            console.log(&#39;ori_input&#39;,ori_input.toString());</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 定义用于接受python传参的data</span><br><span class="line">            var receive_data;</span><br><span class="line">            &#x2F;&#x2F; 将原参数传递给python 在python中进行处理</span><br><span class="line">            send(ori_input.toString());</span><br><span class="line">            &#x2F;&#x2F; recv 从python接收传递的内容 默认传过来的是个json对象</span><br><span class="line">            recv(function (json_data) &#123;</span><br><span class="line">                console.log(&#39;data from python &#39; + json_data.data);</span><br><span class="line">                receive_data &#x3D; json_data.data;</span><br><span class="line">                console.log(typeof (receive_data));</span><br><span class="line">            &#125;).wait(); &#x2F;&#x2F;wait() 等待python处理 阻塞</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 转java字符串</span><br><span class="line">            receive_data &#x3D; Java.use(&quot;java.lang.String&quot;).$new(receive_data);</span><br><span class="line">            this.setText(receive_data);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br><span class="line">python 处理收到的参数</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ &#x3D; &quot;K&quot;</span><br><span class="line">__time__ &#x3D; &quot;2020-08-06 09:48&quot;</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">import base64</span><br><span class="line">import frida</span><br><span class="line">from loguru import logger</span><br><span class="line"></span><br><span class="line">def on_message(message,data):</span><br><span class="line">    logger.info(str(message)) # dict</span><br><span class="line">    logger.info(str(data) if data else &quot;None&quot;)</span><br><span class="line"></span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;error&#39;:</span><br><span class="line">        logger.error(&#39;error:&#39; + str(message[&#39;description&#39;]))</span><br><span class="line">        logger.error(&#39;stack: &#39; + str(message[&#39;stack&#39;]))</span><br><span class="line"></span><br><span class="line">    if message[&#39;type&#39;] &#x3D;&#x3D; &#39;send&#39;:</span><br><span class="line">        logger.info(&#39;get message [*] --&gt; &#39; + message[&#39;payload&#39;])</span><br><span class="line"></span><br><span class="line">        payload &#x3D; message[&#39;payload&#39;]</span><br><span class="line">        # 处理逻辑 sending to the server: YWFhOmJiYg&#x3D;&#x3D;</span><br><span class="line">        tmp &#x3D; payload.split(&#39;:&#39;)</span><br><span class="line">        sts &#x3D; tmp[0]</span><br><span class="line">        need_to_db64 &#x3D; tmp[1]</span><br><span class="line">        user_pass &#x3D; base64.b64decode(need_to_db64.encode()).decode()</span><br><span class="line"></span><br><span class="line">        mine_str &#x3D; &#39;admin&#39; + &#39;:&#39; + user_pass.split(&#39;:&#39;)[-1]</span><br><span class="line">        mine_b64_str &#x3D; base64.b64encode(mine_str.encode()).decode()</span><br><span class="line">        mine_b64_str &#x3D; sts + mine_b64_str</span><br><span class="line">        logger.info(mine_b64_str)</span><br><span class="line"></span><br><span class="line">        # python返回数据给js script.post</span><br><span class="line">        script.post(&#123;&#39;data&#39;:mine_b64_str&#125;)</span><br><span class="line">        logger.info(&#39;python complete&#39;)</span><br><span class="line"></span><br><span class="line">device &#x3D; frida.get_usb_device()</span><br><span class="line"># pid &#x3D; device.spawn([&#39;com.kevin.demo04&#39;])</span><br><span class="line"># time.sleep(1)</span><br><span class="line">session &#x3D; device.attach(&#39;com.kevin.demo02&#39;)</span><br><span class="line">with open(&#39;.&#x2F;hulianhutong.js&#39;,&#39;r&#39;) as f:</span><br><span class="line">    script &#x3D; session.create_script(f.read())</span><br><span class="line"></span><br><span class="line">script.on(&quot;message&quot;,on_message)</span><br><span class="line">script.load()</span><br><span class="line">input()</span><br></pre></td></tr></table></figure><h1 id="Hook-打印-char"><a href="#Hook-打印-char" class="headerlink" title="Hook 打印 char"></a>Hook 打印 char</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打印char字符, 直接调用java.lang.Character toString()即可</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> CharClass = Java.use(<span class="string">&quot;java.lang.Character&quot;</span>);</span><br><span class="line">        CharClass.toString.overload(<span class="string">&quot;char&quot;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">inputChar</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.toString(inputChar);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;inputChar, result: &quot;</span>, inputChar, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-打印-char-数组"><a href="#Hook-打印-char-数组" class="headerlink" title="Hook 打印 char 数组"></a>Hook 打印 char 数组</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用 java.util.Arrays 的 toString 方法 打印 [C </span></span><br><span class="line"><span class="comment">// 2. 使用 js 的 JSON.stringify 打印 [C</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printCharArray</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ArrayClass = Java.use(<span class="string">&quot;java.util.Arrays&quot;</span>);</span><br><span class="line">        ArrayClass.toString.overload(<span class="string">&#x27;[C&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 1. java.util.Arrays.toString()</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.toString(charArray);</span><br><span class="line">            <span class="comment">// 2. javascript JSON.stringify()</span></span><br><span class="line">            <span class="keyword">var</span> result1 = <span class="built_in">JSON</span>.stringify(charArray);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;charArray, result : &#x27;</span>, charArray, result);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;charArray, result :&#x27;</span>, charArray, result1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-打印和修改-HashMap"><a href="#Hook-打印和修改-HashMap" class="headerlink" title="Hook 打印和修改 HashMap"></a>Hook 打印和修改 HashMap</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">遍历打印</span><br><span class="line">function main()&#123;</span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">        var targetClass &#x3D; Java.use(&quot;com.xiaojianbang.app.ShufferMap&quot;);</span><br><span class="line">        targetClass.show.implementation &#x3D; function(map)&#123;</span><br><span class="line">            &#x2F;&#x2F; 遍历 map</span><br><span class="line">        var result &#x3D; &quot;&quot;;</span><br><span class="line">        var it &#x3D; map.keySet().iterator();</span><br><span class="line">        while (it.hasNext())&#123;</span><br><span class="line">            var keyStr &#x3D; it.next();</span><br><span class="line">            var valueStr &#x3D; map.get(keyStr);</span><br><span class="line">                result +&#x3D; valueStr;</span><br><span class="line">        &#125;</span><br><span class="line">            console.log(&quot;result :&quot;, result);</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; 修改 map</span><br><span class="line">            map.put(&quot;pass&quot;,&quot;fxxk&quot;);</span><br><span class="line">            map.put(&quot;code&quot;,&quot;Hello World&quot;);</span><br><span class="line">            console.log(JSON.stringify(map));</span><br><span class="line">            this.show(map);</span><br><span class="line">            </span><br><span class="line">            return this.show(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br><span class="line">cast打印 HashMap</span><br><span class="line">function main()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var HashMapNode &#x3D; Java.use(&quot;java.util.HashMap$Node&quot;);</span><br><span class="line">        var targetClass &#x3D; Java.use(&quot;com.xiaojianbang.app.ShufferMap&quot;);</span><br><span class="line">        </span><br><span class="line">        var targetClass.show.implementation &#x3D; function(map)&#123;</span><br><span class="line">            var result &#x3D; &quot;&quot;;</span><br><span class="line">            var iterator &#x3D; map.entrySet().iterator();</span><br><span class="line">            while (iterator.hasNext()) &#123;</span><br><span class="line">                console.log(&quot;entry&quot;, iterator.next());</span><br><span class="line">                var entry &#x3D; Java.cast(iterator.next(), HashMapNode);</span><br><span class="line">                console.log(entry.getKey());</span><br><span class="line">                console.log(entry.getValue());</span><br><span class="line">                return +&#x3D; entry.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            console.log(&quot;result is :&quot;, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><p><code>toString()</code>打印</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> targetClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.ShufferMap&quot;</span>);</span><br><span class="line">        targetClass.show.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">map</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 直接调用 toString()</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;打印hashmap: -&gt; &quot;</span> + map.toString());</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.show.apply(<span class="built_in">this</span>,<span class="built_in">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printHashMap</span>(<span class="params">flag, param_hm</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> HashMap = Java.use(<span class="string">&#x27;java.util.HashMap&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> args_map = Java.cast(param_hm, HashMap);</span><br><span class="line">        send(flag +<span class="string">&quot;:&quot;</span> + args_map.toString());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-打印-byte-数组"><a href="#Hook-打印-byte-数组" class="headerlink" title="Hook 打印 byte 数组"></a>Hook 打印 byte 数组</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">方法 1</span><br><span class="line">function main()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">            var StringClass &#x3D; Java.use(&quot;java.lang.String&quot;);</span><br><span class="line">            var byteArray &#x3D; StringClass.$new(&quot;Hello World&quot;).getBytes();</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; load r0gson</span><br><span class="line">        &#x2F;&#x2F; openClassFile 返回 dex对象, dex对象.load()加载dex文件内容</span><br><span class="line">            Java.openClassFile(&quot;&#x2F;data&#x2F;local&#x2F;tmp&#x2F;r0gson.dex&quot;).load();</span><br><span class="line">            var gson &#x3D; Java.use(&quot;com.r0ysue.gson.Gson&quot;);</span><br><span class="line">            console.log(gson.$new().toJson(byteArray));</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; &#x2F;&#x2F; console byte[]</span><br><span class="line">            &#x2F;&#x2F; var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">            &#x2F;&#x2F; console.log(ByteString.of(byteArray).hex()); &#x2F;&#x2F; byte转16进制字符串</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; &#x2F;&#x2F; 创建自定义Java数组 并打印</span><br><span class="line">            &#x2F;&#x2F; var MyArray &#x3D; Java.array(&quot;byte&quot;,[13,4,4,2]);</span><br><span class="line">            &#x2F;&#x2F; console.log(gson.$new().toJson(MyArray));</span><br><span class="line"></span><br><span class="line">            var TargetClass &#x3D; Java.use(&quot;com.xiaojianbang.app.ShufferMap&quot;);</span><br><span class="line">            TargetClass.show.implementation &#x3D;  function(map)&#123;</span><br><span class="line">                console.log(gson.$new().toJson(map));</span><br><span class="line">                return this.show(map);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br><span class="line">方法 2</span><br><span class="line">&#x2F;&#x2F; 1. 使用 java.util.Arrays.toString() 打印 [B</span><br><span class="line">&#x2F;&#x2F; 2. 使用 javascript JSON.stringify() 打印 [B</span><br><span class="line"></span><br><span class="line">function printByteArray()&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var ArrayClass &#x3D; Java.use(&quot;java.util.Arrays&quot;);</span><br><span class="line">        ArrayClass.toString.overload(&#39;[B&#39;).implementation &#x3D; function(byteArray)&#123;</span><br><span class="line">&#x2F;&#x2F; 1. 使用 java.util.Arrays.toString() 打印 [B</span><br><span class="line">            var result &#x3D; this.toString(byteArray);</span><br><span class="line">&#x2F;&#x2F; 2. 使用 javascript JSON.stringify() 打印 [B</span><br><span class="line">            var result1 &#x3D; JSON.stringify(byteArray);</span><br><span class="line">            </span><br><span class="line">            console.log(&#39;byteArray,result: &#39;, byteArray, result);</span><br><span class="line">            console.log(&#39;byteArray,result1 :&#39;, byteArray, result1);</span><br><span class="line"></span><br><span class="line">            return result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">方法 3</span><br><span class="line">function printByteArray(byteArray)&#123;</span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">var ByteString &#x3D; Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span><br><span class="line">console.log(ByteString.of(byteArray).hex())</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-打印调用栈"><a href="#Hook-打印调用栈" class="headerlink" title="Hook 打印调用栈"></a>Hook 打印调用栈</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStacks</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;====== printStacks start ====== &quot;</span> + name + <span class="string">&quot;==============================&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sample 1</span></span><br><span class="line">    <span class="keyword">var</span> throwable = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new());</span><br><span class="line">    <span class="built_in">console</span>.log(throwable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sample 2</span></span><br><span class="line">    <span class="keyword">var</span> exception = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>).$new());</span><br><span class="line">    <span class="built_in">console</span>.log(exception);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;====== printStacks end ======== &quot;</span> + name + <span class="string">&quot;==============================&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-gson-打印"><a href="#Hook-gson-打印" class="headerlink" title="Hook gson 打印"></a>Hook gson 打印</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> StringClass = Java.use(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> byteArray = StringClass.$new(<span class="string">&quot;Hello World&quot;</span>).getBytes();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// load r0gson</span></span><br><span class="line">        <span class="comment">// openClassFile 返回 dex对象, dex对象.load()加载dex文件内容</span></span><br><span class="line">            Java.openClassFile(<span class="string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).load();</span><br><span class="line">            <span class="keyword">var</span> gson = Java.use(<span class="string">&quot;com.r0ysue.gson.Gson&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(gson.$new().toJson(byteArray));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// // console byte[]</span></span><br><span class="line">            <span class="comment">// var ByteString = Java.use(&quot;com.android.okhttp.okio.ByteString&quot;);</span></span><br><span class="line">            <span class="comment">// console.log(ByteString.of(byteArray).hex()); // byte转16进制字符串</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// // 创建自定义Java数组 并打印</span></span><br><span class="line">            <span class="comment">// var MyArray = Java.array(&quot;byte&quot;,[13,4,4,2]);</span></span><br><span class="line">            <span class="comment">// console.log(gson.$new().toJson(MyArray));</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> TargetClass = Java.use(<span class="string">&quot;com.xiaojianbang.app.ShufferMap&quot;</span>);</span><br><span class="line">            TargetClass.show.implementation =  <span class="function"><span class="keyword">function</span>(<span class="params">map</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(gson.$new().toJson(map));</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.show(map);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h1 id="Hook-打印-non-ascii-和特殊字符"><a href="#Hook-打印-non-ascii-和特殊字符" class="headerlink" title="Hook 打印 non-ascii 和特殊字符"></a>Hook 打印 non-ascii 和特殊字符</h1><p>一些特殊字符和不可见字符, 可以先通过编码再解码的方式进行 <code>hook</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ֏(<span class="keyword">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">return</span> x + <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>针对上面的<code>֏</code>, 直接用<code>js</code>编码, 在通过<code>类名[js解码的方法名]</code>进行<code>implementation</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> targetClass = <span class="string">&quot;com.example.hooktest.MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> hookCls = Java.use(targetClass);</span><br><span class="line">            <span class="keyword">var</span> methods = hookCls.class.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> methods) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(methods[i].toString());</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="built_in">encodeURIComponent</span>(methods[i].toString().replace(<span class="regexp">/^.*?\.([^\s\.\(\)]+)\(.*?$/</span>, <span class="string">&quot;$1&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            hookCls[<span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%D6%8F&quot;</span>)]</span><br><span class="line">                .implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;original call: fun(&quot;</span> + x + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="built_in">this</span>[<span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%D6%8F&quot;</span>)](<span class="number">900</span>);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h1 id="简易-wallbreaker-内存打印"><a href="#简易-wallbreaker-内存打印" class="headerlink" title="简易 wallbreaker 内存打印"></a>简易 wallbreaker 内存打印</h1><p>内存漫游, 打印实例的字段和方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Class = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">        </span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">inspectObject</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> obj_class = Java.cast(obj.getClass(), Class);</span><br><span class="line">            <span class="keyword">var</span> fields = obj_class.getDeclaredFields();</span><br><span class="line">            <span class="keyword">var</span> methods = obj_class.getMethods();</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Inspectiong &quot;</span> + obj.getClass().toString());</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\t Fields:&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> fields)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\t\t&quot;</span> + fields[i].toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\t Methods:&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> methods)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\t\t&quot;</span> + methods[i].toString())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Java.choose(<span class="string">&quot;com.baidu.lbs.waimai.WaimaiActivity&quot;</span>,&#123;</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;complete!&quot;</span>);</span><br><span class="line">                </span><br><span class="line">            &#125;,</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;find instance&quot;</span>, instance);</span><br><span class="line">                inspectObject(instance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><h1 id="hook-frida-实现-runnable"><a href="#hook-frida-实现-runnable" class="headerlink" title="hook frida 实现 runnable"></a>hook frida 实现 runnable</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// https://developer.android.com/reference/android/view/WindowManager.LayoutParams.html#FLAG_SECURE</span></span><br><span class="line">   <span class="keyword">var</span> FLAG_SECURE = <span class="number">0x2000</span>;</span><br><span class="line">   <span class="keyword">var</span> Runnable = Java.use(<span class="string">&quot;java.lang.Runnable&quot;</span>);</span><br><span class="line">   <span class="keyword">var</span> DisableSecureRunnable = Java.registerClass(&#123;</span><br><span class="line">      name: <span class="string">&quot;me.bhamza.DisableSecureRunnable&quot;</span>,</span><br><span class="line">      implements: [Runnable],</span><br><span class="line">      fields: &#123;</span><br><span class="line">          activity: <span class="string">&quot;android.app.Activity&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">       methods: &#123;</span><br><span class="line">          $init: [&#123;</span><br><span class="line">             returnType: <span class="string">&quot;void&quot;</span>,</span><br><span class="line">             argumentTypes: [<span class="string">&quot;android.app.Activity&quot;</span>],</span><br><span class="line">             implementation: <span class="function"><span class="keyword">function</span> (<span class="params">activity</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.activity.value = activity;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;],</span><br><span class="line">          run: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">             <span class="keyword">var</span> flags = <span class="built_in">this</span>.activity.value.getWindow().getAttributes().flags.value; <span class="comment">// get current value</span></span><br><span class="line">             flags &amp;= ~FLAG_SECURE; <span class="comment">// toggle it</span></span><br><span class="line">             <span class="built_in">this</span>.activity.value.getWindow().setFlags(flags, FLAG_SECURE); <span class="comment">// disable it!</span></span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">&quot;Done disabling SECURE flag...&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Java.choose(<span class="string">&quot;com.example.app.FlagSecureTestActivity&quot;</span>, &#123;</span><br><span class="line">       <span class="string">&quot;onMatch&quot;</span>: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> runnable = DisableSecureRunnable.$new(instance);</span><br><span class="line">          instance.runOnUiThread(runnable);</span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="string">&quot;onComplete&quot;</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-监控控件的点击事件"><a href="#Hook-监控控件的点击事件" class="headerlink" title="Hook 监控控件的点击事件"></a>Hook 监控控件的点击事件</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getObjClassName</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz) &#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!jobj) &#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.getName.call(jobj.getClass.call(obj));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">obj, mtdName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = getObjClassName(obj);</span><br><span class="line">    <span class="keyword">var</span> target = Java.use(listener_name);</span><br><span class="line">    <span class="keyword">if</span> (!target || !mtdName <span class="keyword">in</span> target) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send(&quot;[WatchEvent] hooking &quot; + mtdName + &quot;: &quot; + listener_name);</span></span><br><span class="line">    target[mtdName].overloads.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">overload</span>) </span>&#123;</span><br><span class="line">        overload.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//send(&quot;[WatchEvent] &quot; + mtdName + &quot;: &quot; + getObjClassName(this));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + getObjClassName(<span class="built_in">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>[mtdName].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OnClickListener</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        Java.use(<span class="string">&quot;android.view.View&quot;</span>).setOnClickListener.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">listener</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">                watch(listener, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.setOnClickListener(listener);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        Java.choose(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                instance = instance.mOnClickListener.value;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;mOnClickListener name is :&quot;</span> + getObjClassName(instance));</span><br><span class="line">                    watch(instance, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(OnClickListener);</span><br></pre></td></tr></table></figure><h1 id="Hook-frida-绕过-root-检测"><a href="#Hook-frida-绕过-root-检测" class="headerlink" title="Hook frida 绕过 root 检测"></a>Hook frida 绕过 root 检测</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $ frida -l antiroot.js -U -f com.example.app --no-pause</span></span><br><span class="line"><span class="comment">// CHANGELOG by Pichaya Morimoto (p.morimoto@sth.sh): </span></span><br><span class="line"><span class="comment">//  - I added extra whitelisted items to deal with the latest versions </span></span><br><span class="line"><span class="comment">// of RootBeer/Cordova iRoot as of August 6, 2019</span></span><br><span class="line"><span class="comment">//  - The original one just fucked up (kill itself) if Magisk is installed lol</span></span><br><span class="line"><span class="comment">// Credit &amp; Originally written by: https://codeshare.frida.re/@dzonerzy/fridantiroot/</span></span><br><span class="line"><span class="comment">// If this isn&#x27;t working in the future, check console logs, rootbeer src, or libtool-checker.so</span></span><br><span class="line"></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> RootPackages = [<span class="string">&quot;com.noshufou.android.su&quot;</span>, <span class="string">&quot;com.noshufou.android.su.elite&quot;</span>, <span class="string">&quot;eu.chainfire.supersu&quot;</span>,</span><br><span class="line">        <span class="string">&quot;com.koushikdutta.superuser&quot;</span>, <span class="string">&quot;com.thirdparty.superuser&quot;</span>, <span class="string">&quot;com.yellowes.su&quot;</span>, <span class="string">&quot;com.koushikdutta.rommanager&quot;</span>,</span><br><span class="line">        <span class="string">&quot;com.koushikdutta.rommanager.license&quot;</span>, <span class="string">&quot;com.dimonvideo.luckypatcher&quot;</span>, <span class="string">&quot;com.chelpus.lackypatch&quot;</span>,</span><br><span class="line">        <span class="string">&quot;com.ramdroid.appquarantine&quot;</span>, <span class="string">&quot;com.ramdroid.appquarantinepro&quot;</span>, <span class="string">&quot;com.devadvance.rootcloak&quot;</span>, <span class="string">&quot;com.devadvance.rootcloakplus&quot;</span>,</span><br><span class="line">        <span class="string">&quot;de.robv.android.xposed.installer&quot;</span>, <span class="string">&quot;com.saurik.substrate&quot;</span>, <span class="string">&quot;com.zachspong.temprootremovejb&quot;</span>, <span class="string">&quot;com.amphoras.hidemyroot&quot;</span>,</span><br><span class="line">        <span class="string">&quot;com.amphoras.hidemyrootadfree&quot;</span>, <span class="string">&quot;com.formyhm.hiderootPremium&quot;</span>, <span class="string">&quot;com.formyhm.hideroot&quot;</span>, <span class="string">&quot;me.phh.superuser&quot;</span>,</span><br><span class="line">        <span class="string">&quot;eu.chainfire.supersu.pro&quot;</span>, <span class="string">&quot;com.kingouser.com&quot;</span>, <span class="string">&quot;com.android.vending.billing.InAppBillingService.COIN&quot;</span>,<span class="string">&quot;com.topjohnwu.magisk&quot;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> RootBinaries = [<span class="string">&quot;su&quot;</span>, <span class="string">&quot;busybox&quot;</span>, <span class="string">&quot;supersu&quot;</span>, <span class="string">&quot;Superuser.apk&quot;</span>, <span class="string">&quot;KingoUser.apk&quot;</span>, <span class="string">&quot;SuperSu.apk&quot;</span>,<span class="string">&quot;magisk&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> RootProperties = &#123;</span><br><span class="line">        <span class="string">&quot;ro.build.selinux&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.debuggable&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;service.adb.root&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ro.secure&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> RootPropertiesKeys = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> RootProperties) RootPropertiesKeys.push(k);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> PackageManager = Java.use(<span class="string">&quot;android.app.ApplicationPackageManager&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> Runtime = Java.use(<span class="string">&#x27;java.lang.Runtime&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> NativeFile = Java.use(<span class="string">&#x27;java.io.File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">String</span> = Java.use(<span class="string">&#x27;java.lang.String&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> SystemProperties = Java.use(<span class="string">&#x27;android.os.SystemProperties&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> BufferedReader = Java.use(<span class="string">&#x27;java.io.BufferedReader&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ProcessBuilder = Java.use(<span class="string">&#x27;java.lang.ProcessBuilder&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> StringBuffer = Java.use(<span class="string">&#x27;java.lang.StringBuffer&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> loaded_classes = Java.enumerateLoadedClassesSync();</span><br><span class="line"></span><br><span class="line">    send(<span class="string">&quot;Loaded &quot;</span> + loaded_classes.length + <span class="string">&quot; classes!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> useKeyInfo = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> useProcessManager = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    send(<span class="string">&quot;loaded: &quot;</span> + loaded_classes.indexOf(<span class="string">&#x27;java.lang.ProcessManager&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loaded_classes.indexOf(<span class="string">&#x27;java.lang.ProcessManager&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//useProcessManager = true;</span></span><br><span class="line">            <span class="comment">//var ProcessManager = Java.use(&#x27;java.lang.ProcessManager&#x27;);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            send(<span class="string">&quot;ProcessManager Hook failed: &quot;</span> + err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        send(<span class="string">&quot;ProcessManager hook not loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> KeyInfo = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loaded_classes.indexOf(<span class="string">&#x27;android.security.keystore.KeyInfo&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//useKeyInfo = true;</span></span><br><span class="line">            <span class="comment">//var KeyInfo = Java.use(&#x27;android.security.keystore.KeyInfo&#x27;);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            send(<span class="string">&quot;KeyInfo Hook failed: &quot;</span> + err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        send(<span class="string">&quot;KeyInfo hook not loaded&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PackageManager.getPackageInfo.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">pname, flags</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> shouldFakePackage = (RootPackages.indexOf(pname) &gt; -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (shouldFakePackage) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass root check for package: &quot;</span> + pname);</span><br><span class="line">            pname = <span class="string">&quot;set.package.name.to.a.fake.one.so.we.can.bypass.it&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getPackageInfo.call(<span class="built_in">this</span>, pname, flags);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    NativeFile.exists.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> name = NativeFile.getName.call(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">var</span> shouldFakeReturn = (RootBinaries.indexOf(name) &gt; -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (shouldFakeReturn) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass return value for binary: &quot;</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.exists.call(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> exec = Runtime.exec.overload(<span class="string">&#x27;[Ljava.lang.String;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> exec1 = Runtime.exec.overload(<span class="string">&#x27;java.lang.String&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> exec2 = Runtime.exec.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> exec3 = Runtime.exec.overload(<span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> exec4 = Runtime.exec.overload(<span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;java.io.File&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> exec5 = Runtime.exec.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;java.io.File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    exec5.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd, env, dir</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;mount&quot;</span> || cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;id&quot;</span> || cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="string">&quot;which&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass which command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exec5.call(<span class="built_in">this</span>, cmd, env, dir);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    exec4.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmdarr, env, file</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmdarr.length; i = i + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> tmp_cmd = cmdarr[i];</span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;mount&quot;</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;id&quot;</span> || tmp_cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exec4.call(<span class="built_in">this</span>, cmdarr, env, file);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    exec3.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmdarr, envp</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmdarr.length; i = i + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> tmp_cmd = cmdarr[i];</span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;mount&quot;</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;id&quot;</span> || tmp_cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exec3.call(<span class="built_in">this</span>, cmdarr, envp);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    exec2.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd, env</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;mount&quot;</span> || cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;id&quot;</span> || cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exec2.call(<span class="built_in">this</span>, cmd, env);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    exec.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmd.length; i = i + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> tmp_cmd = cmd[i];</span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;mount&quot;</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;id&quot;</span> || tmp_cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">                send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exec.call(<span class="built_in">this</span>, cmd);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    exec1.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;mount&quot;</span> || cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;id&quot;</span> || cmd == <span class="string">&quot;sh&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;grep&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fakeCmd = <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + cmd + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, fakeCmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> exec1.call(<span class="built_in">this</span>, cmd);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">String</span>.contains.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="string">&quot;test-keys&quot;</span>) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass test-keys check&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.contains.call(<span class="built_in">this</span>, name);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> get = SystemProperties.get.overload(<span class="string">&#x27;java.lang.String&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    get.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (RootPropertiesKeys.indexOf(name) != -<span class="number">1</span>) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass &quot;</span> + name);</span><br><span class="line">            <span class="keyword">return</span> RootProperties[name];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.get.call(<span class="built_in">this</span>, name);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> path1 = Memory.readCString(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> path = path1.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> executable = path[path.length - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> shouldFakeReturn = (RootBinaries.indexOf(executable) &gt; -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (shouldFakeReturn) &#123;</span><br><span class="line">                Memory.writeUtf8String(args[<span class="number">0</span>], <span class="string">&quot;/ggezxxx&quot;</span>);</span><br><span class="line">                send(<span class="string">&quot;Bypass native fopen &gt;&gt; &quot;</span>+path1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> path1 = Memory.readCString(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> path = path1.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> executable = path[path.length - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> shouldFakeReturn = (RootBinaries.indexOf(executable) &gt; -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> (shouldFakeReturn) &#123;</span><br><span class="line">                Memory.writeUtf8String(args[<span class="number">0</span>], <span class="string">&quot;/ggezxxx&quot;</span>);</span><br><span class="line">                send(<span class="string">&quot;Bypass native fopen &gt;&gt; &quot;</span>+path1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;system&quot;</span>), &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> cmd = Memory.readCString(args[<span class="number">0</span>]);</span><br><span class="line">            send(<span class="string">&quot;SYSTEM CMD: &quot;</span> + cmd);</span><br><span class="line">            <span class="keyword">if</span> (cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;mount&quot;</span> || cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || cmd == <span class="string">&quot;id&quot;</span>) &#123;</span><br><span class="line">                send(<span class="string">&quot;Bypass native system: &quot;</span> + cmd);</span><br><span class="line">                Memory.writeUtf8String(args[<span class="number">0</span>], <span class="string">&quot;grep&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                send(<span class="string">&quot;Bypass native system: &quot;</span> + cmd);</span><br><span class="line">                Memory.writeUtf8String(args[<span class="number">0</span>], <span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    TO IMPLEMENT:</span></span><br><span class="line"><span class="comment">    Exec Family</span></span><br><span class="line"><span class="comment">    int execl(const char *path, const char *arg0, ..., const char *argn, (char *)0);</span></span><br><span class="line"><span class="comment">    int execle(const char *path, const char *arg0, ..., const char *argn, (char *)0, char *const envp[]);</span></span><br><span class="line"><span class="comment">    int execlp(const char *file, const char *arg0, ..., const char *argn, (char *)0);</span></span><br><span class="line"><span class="comment">    int execlpe(const char *file, const char *arg0, ..., const char *argn, (char *)0, char *const envp[]);</span></span><br><span class="line"><span class="comment">    int execv(const char *path, char *const argv[]);</span></span><br><span class="line"><span class="comment">    int execve(const char *path, char *const argv[], char *const envp[]);</span></span><br><span class="line"><span class="comment">    int execvp(const char *file, char *const argv[]);</span></span><br><span class="line"><span class="comment">    int execvpe(const char *file, char *const argv[], char *const envp[]);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    BufferedReader.readLine.overload().implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> text = <span class="built_in">this</span>.readLine.call(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (text === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// just pass , i know it&#x27;s ugly as hell but test != null won&#x27;t work :(</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> shouldFakeRead = (text.indexOf(<span class="string">&quot;ro.build.tags=test-keys&quot;</span>) &gt; -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (shouldFakeRead) &#123;</span><br><span class="line">                send(<span class="string">&quot;Bypass build.prop file read&quot;</span>);</span><br><span class="line">                text = text.replace(<span class="string">&quot;ro.build.tags=test-keys&quot;</span>, <span class="string">&quot;ro.build.tags=release-keys&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> executeCommand = ProcessBuilder.command.overload(<span class="string">&#x27;java.util.List&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    ProcessBuilder.start.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cmd = <span class="built_in">this</span>.command.call(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">var</span> shouldModifyCommand = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmd.size(); i = i + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> tmp_cmd = cmd.get(i).toString();</span><br><span class="line">            <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd.indexOf(<span class="string">&quot;mount&quot;</span>) != -<span class="number">1</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd.indexOf(<span class="string">&quot;id&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                shouldModifyCommand = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldModifyCommand) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass ProcessBuilder &quot;</span> + cmd);</span><br><span class="line">            <span class="built_in">this</span>.command.call(<span class="built_in">this</span>, [<span class="string">&quot;grep&quot;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.start.call(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd.indexOf(<span class="string">&quot;su&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass ProcessBuilder &quot;</span> + cmd);</span><br><span class="line">            <span class="built_in">this</span>.command.call(<span class="built_in">this</span>, [<span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.start.call(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.start.call(<span class="built_in">this</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useProcessManager) &#123;</span><br><span class="line">        <span class="keyword">var</span> ProcManExec = ProcessManager.exec.overload(<span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;java.io.File&#x27;</span>, <span class="string">&#x27;boolean&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> ProcManExecVariant = ProcessManager.exec.overload(<span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;[Ljava.lang.String;&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;boolean&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        ProcManExec.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd, env, workdir, redirectstderr</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> fake_cmd = cmd;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmd.length; i = i + <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> tmp_cmd = cmd[i];</span><br><span class="line">                <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;mount&quot;</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;id&quot;</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> fake_cmd = [<span class="string">&quot;grep&quot;</span>];</span><br><span class="line">                    send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (tmp_cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> fake_cmd = [<span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>];</span><br><span class="line">                    send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ProcManExec.call(<span class="built_in">this</span>, fake_cmd, env, workdir, redirectstderr);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ProcManExecVariant.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">cmd, env, directory, stdin, stdout, stderr, redirect</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> fake_cmd = cmd;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmd.length; i = i + <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> tmp_cmd = cmd[i];</span><br><span class="line">                <span class="keyword">if</span> (tmp_cmd.indexOf(<span class="string">&quot;getprop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;mount&quot;</span> || tmp_cmd.indexOf(<span class="string">&quot;build.prop&quot;</span>) != -<span class="number">1</span> || tmp_cmd == <span class="string">&quot;id&quot;</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> fake_cmd = [<span class="string">&quot;grep&quot;</span>];</span><br><span class="line">                    send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (tmp_cmd == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> fake_cmd = [<span class="string">&quot;justafakecommandthatcannotexistsusingthisshouldthowanexceptionwheneversuiscalled&quot;</span>];</span><br><span class="line">                    send(<span class="string">&quot;Bypass &quot;</span> + cmdarr + <span class="string">&quot; command&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ProcManExecVariant.call(<span class="built_in">this</span>, fake_cmd, env, directory, stdin, stdout, stderr, redirect);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useKeyInfo) &#123;</span><br><span class="line">        KeyInfo.isInsideSecureHardware.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            send(<span class="string">&quot;Bypass isInsideSecureHardware&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="Hook-frida-强制在主线程运行"><a href="#Hook-frida-强制在主线程运行" class="headerlink" title="Hook frida 强制在主线程运行"></a>Hook frida 强制在主线程运行</h1><p>针对使用一些方法的时候出现报错 <code>on a thread that has not called Looper.prepare()</code></p><p>强制让代码运行在主线程中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Toast = Java.use(<span class="string">&#x27;android.widget.Toast&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>).currentApplication(); </span><br><span class="line">  <span class="keyword">var</span> context = currentApplication.getApplicationContext();</span><br><span class="line"></span><br><span class="line">  Java.scheduleOnMainThread(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;Hello World&quot;</span>, Toast.LENGTH_LONG.value).show();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="Hook-frida-指定方法中过滤打印"><a href="#Hook-frida-指定方法中过滤打印" class="headerlink" title="Hook frida 指定方法中过滤打印"></a>Hook frida 指定方法中过滤打印</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_lnf</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> activate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> hashmapClass = Java.use(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">        hashmapClass.put.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">key,value</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (activate)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;key:&quot;</span>, key, <span class="string">&quot;value:&quot;</span>, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.put(key,value);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> lnfClazz = Java.use(<span class="string">&quot;tb.lnf&quot;</span>);</span><br><span class="line">        lnfClazz.a.overload(<span class="string">&#x27;java.util.HashMap&#x27;</span>, <span class="string">&#x27;java.util.HashMap&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;boolean&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">hashmap, hashmap2, str, str2, z</span>) </span>&#123;</span><br><span class="line">                printHashMap(<span class="string">&quot;hashmap&quot;</span>, hashmap);</span><br><span class="line">                printHashMap(<span class="string">&quot;hashmap2&quot;</span>, hashmap2);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;str&quot;</span>, str);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;str2&quot;</span>, str2);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;boolean&quot;</span>, z);</span><br><span class="line">                activate = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="built_in">this</span>.a(hashmap, hashmap2, str, str2, z);</span><br><span class="line">                activate = <span class="literal">false</span></span><br><span class="line">                printHashMap(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-禁止-app-退出"><a href="#Hook-禁止-app-退出" class="headerlink" title="Hook 禁止 app 退出"></a>Hook 禁止 app 退出</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookExit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] Starting hook exit&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> exitClass = Java.use(<span class="string">&quot;java.lang.System&quot;</span>);</span><br><span class="line">        exitClass.exit.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[*] System.exit.called&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] hooking calls to System.exit&quot;</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hookExit);</span><br></pre></td></tr></table></figure><h1 id="Hook-修改设备参数"><a href="#Hook-修改设备参数" class="headerlink" title="Hook 修改设备参数"></a>Hook 修改设备参数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// frida hook 修改设备参数</span></span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> TelephonyManager = Java.use(<span class="string">&quot;android.telephony.TelephonyManager&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IMEI hook</span></span><br><span class="line">    TelephonyManager.getDeviceId.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;[*]Called - getDeviceId()&quot;</span>);</span><br><span class="line">               <span class="keyword">var</span> temp = <span class="built_in">this</span>.getDeviceId();</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;real IMEI: &quot;</span>+temp);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;867979021642856&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// muti IMEI</span></span><br><span class="line">    TelephonyManager.getDeviceId.overload(<span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">p</span>) </span>&#123;</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;[*]Called - getDeviceId(int) param is&quot;</span>+p);</span><br><span class="line">               <span class="keyword">var</span> temp = <span class="built_in">this</span>.getDeviceId(p);</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;real IMEI &quot;</span>+p+<span class="string">&quot;: &quot;</span>+temp);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;867979021642856&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IMSI hook</span></span><br><span class="line">TelephonyManager.getSimSerialNumber.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;[*]Called - getSimSerialNumber(String)&quot;</span>);</span><br><span class="line">               <span class="keyword">var</span> temp = <span class="built_in">this</span>.getSimSerialNumber();</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">&quot;real IMSI: &quot;</span>+temp);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;123456789&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ANDOID_ID hook</span></span><br><span class="line">    <span class="keyword">var</span> Secure = Java.use(<span class="string">&quot;android.provider.Settings$Secure&quot;</span>);</span><br><span class="line">    Secure.getString.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">p1,p2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(p2.indexOf(<span class="string">&quot;android_id&quot;</span>)&lt;<span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">this</span>.getString(p1,p2);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*]Called - get android_ID, param is:&quot;</span>+p2);</span><br><span class="line">    <span class="keyword">var</span> temp = <span class="built_in">this</span>.getString(p1,p2);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;real Android_ID: &quot;</span>+temp);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;844de23bfcf93801&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//android的hidden API，需要通过反射调用</span></span><br><span class="line">    <span class="keyword">var</span> SP = Java.use(<span class="string">&quot;android.os.SystemProperties&quot;</span>);</span><br><span class="line">    SP.get.overload(<span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">p1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = <span class="built_in">this</span>.get(p1);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*]&quot;</span>+p1+<span class="string">&quot; : &quot;</span>+tmp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    SP.get.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">p1,p2</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> tmp = <span class="built_in">this</span>.get(p1,p2)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*]&quot;</span>+p1+<span class="string">&quot;,&quot;</span>+p2+<span class="string">&quot; : &quot;</span>+tmp);</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// hook MAC</span></span><br><span class="line">    <span class="keyword">var</span> wifi = Java.use(<span class="string">&quot;android.net.wifi.WifiInfo&quot;</span>);</span><br><span class="line">    wifi.getMacAddress.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = <span class="built_in">this</span>.getMacAddress();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*]real MAC: &quot;</span>+tmp);</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="Hook-打印请求调用栈"><a href="#Hook-打印请求调用栈" class="headerlink" title="Hook 打印请求调用栈"></a>Hook 打印请求调用栈</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> class_Socket = Java.use(<span class="string">&quot;java.net.Socket&quot;</span>);</span><br><span class="line">class_Socket.getOutputStream.overload().implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    send(<span class="string">&quot;getOutputSteam&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> result = <span class="built_in">this</span>.getOutputStream();</span><br><span class="line">    <span class="keyword">var</span> bt = Java.use(<span class="string">&quot;android.util.Log&quot;</span>).getStackTraceString(</span><br><span class="line">        Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>).$new();</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Backtrace:&quot;</span> + bt);</span><br><span class="line">    send(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Hook-UI-thread-注入"><a href="#Hook-UI-thread-注入" class="headerlink" title="Hook UI thread 注入"></a>Hook UI thread 注入</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> Toast = Java.use(<span class="string">&#x27;android.widget.Toast&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> currentApplication = Java.use(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>).currentApplication(); </span><br><span class="line">  <span class="keyword">var</span> context = currentApplication.getApplicationContext();</span><br><span class="line"></span><br><span class="line">  Java.scheduleOnMainThread(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">&quot;Hello World&quot;</span>, Toast.LENGTH_LONG.value).show();</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="Hook-view-的-onClick-方法"><a href="#Hook-view-的-onClick-方法" class="headerlink" title="Hook view 的 onClick 方法"></a>Hook view 的 onClick 方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getObjClassName</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz) &#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = Java.use(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!jobj) &#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = Java.use(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.getName.call(jobj.getClass.call(obj));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">obj, mtdName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = getObjClassName(obj);</span><br><span class="line">    <span class="keyword">var</span> target = Java.use(listener_name);</span><br><span class="line">    <span class="keyword">if</span> (!target || !mtdName <span class="keyword">in</span> target) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send(&quot;[WatchEvent] hooking &quot; + mtdName + &quot;: &quot; + listener_name);</span></span><br><span class="line">    target[mtdName].overloads.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">overload</span>) </span>&#123;</span><br><span class="line">        overload.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//send(&quot;[WatchEvent] &quot; + mtdName + &quot;: &quot; + getObjClassName(this));</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + getObjClassName(<span class="built_in">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>[mtdName].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OnClickListener</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        Java.use(<span class="string">&quot;android.view.View&quot;</span>).setOnClickListener.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">listener</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">                watch(listener, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.setOnClickListener(listener);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        Java.choose(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                instance = instance.mOnClickListener.value;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;mOnClickListener name is :&quot;</span> + getObjClassName(instance));</span><br><span class="line">                    watch(instance, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(OnClickListener);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> frida </category>
          
      </categories>
      
      
        <tags>
            
            <tag> frida </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
